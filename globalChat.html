<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAOMA™ — Global Chat</title>
    <meta
      name="description"
      content="TAOMA™ (シャドウ ストーム) — Real-time global chat."
    />
    <meta property="og:title" content="TAOMA™ — Global Chat" />
    <meta
      property="og:description"
      content="Real-time chat with TAOMA™ styling."
    />
    <meta name="theme-color" content="#0f1223" />
    <meta
      http-equiv="Content-Security-Policy"
      content="upgrade-insecure-requests"
    />
    <link rel="icon" type="image/png" href="/static/icon.png" />
    <style>
      /* --- Base / Tokens (from your portfolio) --- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      :root {
        --bg: #0e1020;
        --bg-soft: #141735;
        --card: #171b3b;
        --ink: #e9ebff;
        --muted: #a2a9c8;
        --acc: #85a3ff;
        --acc-2: #5b7bff;
        --ok: #35d79c;
        --danger: #ff5a6a;
        --ring: #85a3ff55;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35), 0 2px 8px rgba(0, 0, 0, 0.25);
        --radius: 16px;
        --space: clamp(16px, 2vw, 24px);
        --container: 1100px;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font: 15px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Ubuntu, Arial, sans-serif;
        color: var(--ink);
        background: var(--bg);
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        background: radial-gradient(
            1400px 900px at 12% -8%,
            #1b1f45 0%,
            #1b1f45 35%,
            transparent 72%
          ),
          radial-gradient(
            1200px 800px at 100% -10%,
            #0b4ea8 0%,
            #0b4ea8 28%,
            transparent 68%
          ),
          radial-gradient(
            900px 500px at 95% 115%,
            #0b4ea84d 0%,
            transparent 60%
          ),
          linear-gradient(160deg, #0f1531 0%, #0e1020 72%);
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      img {
        max-width: 100%;
        display: block;
      }
      .container {
        max-width: var(--container);
        margin: 0 auto;
        padding-inline: var(--space);
      }

      /* Header (copied from your site) */
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: saturate(1.1) blur(10px);
        background: linear-gradient(180deg, #0c0f24cc 0%, #0c0f2400 100%);
        border-bottom: 1px solid #ffffff14;
      }
      .nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 64px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 800;
        letter-spacing: 0.4px;
      }
      .brand .logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: block;
      }
      .links {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      .links a {
        padding: 0.45rem 0.7rem;
        border-radius: 10px;
        border: 1px solid transparent;
      }
      .links a:hover {
        border-color: #ffffff1f;
        background: #ffffff0f;
      }
      .mobile-toggle {
        display: none;
      }
      @media (max-width: 800px) {
        .mobile-toggle {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 40px;
          height: 40px;
          border-radius: 10px;
          border: 1px solid #ffffff26;
          background: transparent;
        }
        .links {
          position: fixed;
          inset: 64px 0 auto 0;
          background: linear-gradient(180deg, #0b0f29, #0b0f2945);
          padding: 1rem;
          display: none;
          flex-direction: column;
        }
        .links.open {
          display: flex;
        }
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: var(--acc);
        color: white;
        font-weight: 600;
        box-shadow: var(--shadow);
        border: 1px solid #ffffff1a;
        transition: 0.2s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        filter: saturate(1.1);
      }
      .btn.ghost {
        background: transparent;
        color: var(--ink);
        border: 1px solid #ffffff26;
        box-shadow: none;
      }

      .card {
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card), transparent 8%),
          var(--card)
        );
        border: 1px solid #ffffff1a;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }
      .muted {
        color: var(--muted);
      }
      :focus-visible {
        outline: 2px solid var(--acc);
        outline-offset: 2px;
        box-shadow: 0 0 0 6px var(--ring);
      }

      /* --- Chat layout --- */
      main {
        padding-block: clamp(28px, 6vw, 48px);
      }
      .chat-wrap {
        display: grid;
        gap: 1rem;
      }
      .chat-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #ffffff1a;
      }
      .chat-title {
        margin: 0;
        font-weight: 800;
        letter-spacing: 0.3px;
      }
      .status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        background: #ffffff10;
        border: 1px solid #ffffff26;
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #a1a1a1;
        box-shadow: 0 0 0 3px #ffffff1a inset;
      }
      .dot.ok {
        background: var(--ok);
      }
      .dot.warn {
        background: #e3a11a;
      }
      .dot.err {
        background: var(--danger);
      }

      .chat {
        display: flex;
        flex-direction: column;
        min-height: 420px;
        max-height: min(66vh, 680px);
        overflow: auto;
        padding: 1rem;
        gap: 0.5rem;
        scroll-behavior: smooth;
      }

      /* Message bubbles */
      .msg {
        max-width: 75%;
        width: fit-content;
        padding: 0.6rem 0.8rem;
        border-radius: 14px;
        border: 1px solid #ffffff22;
        background: #ffffff10;
        box-shadow: inset 0 1px 0 #ffffff0a;
        word-wrap: break-word;
        overflow-wrap: anywhere;
      }
      .msg .meta {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        font-size: 0.8rem;
        color: var(--muted);
        margin-bottom: 0.25rem;
      }
      .msg.me {
        margin-left: auto;
        background: color-mix(in oklab, var(--acc) 22%, transparent);
        border-color: #ffffff2a;
      }
      .msg.sys {
        margin-inline: auto;
        background: #ffffff0a;
        font-style: italic;
        color: var(--muted);
      }

      /* Composer */
      .composer {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0.8rem;
        border-top: 1px solid #ffffff1a;
        background: linear-gradient(180deg, #0c1030aa, #0c1030aa);
        backdrop-filter: blur(6px);
        display: flex;
        gap: 0.6rem;
      }
      .input {
        flex: 1;
        display: flex;
        gap: 0.5rem;
        align-items: center;
        background: #ffffff12;
        border: 1px solid #ffffff26;
        border-radius: 12px;
        padding: 0.55rem 0.75rem;
      }
      .input input {
        flex: 1;
        background: transparent;
        border: 0;
        color: var(--ink);
        font: inherit;
        outline: none;
      }
      .send {
        white-space: nowrap;
      }

      @media (max-width: 640px) {
        .msg {
          max-width: 86%;
        }
        .chat {
          max-height: 60vh;
        }
      }

      /* Footer (your isometric social kept) */
      footer {
        border-top: 1px solid #ffffff14;
        padding-block: 24px;
        margin-top: auto;
      }
      .foot {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }
      .social {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      /* (Scoped from your snippet) */
      footer .social a.iso-pro {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: color-mix(in oklab, var(--card) 35%, transparent);
        border: 1px solid #ffffff26;
        box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.2),
          inset 0 0 5px rgba(255, 255, 255, 0.28), 0 5px 8px rgba(0, 0, 0, 0.18);
        transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
        overflow: visible;
      }
      footer .social a.iso-pro:hover {
        background: color-mix(in oklab, var(--card) 45%, transparent);
        box-shadow: inset 0 0 22px rgba(255, 255, 255, 0.22),
          inset 0 0 6px rgba(255, 255, 255, 0.34),
          0 8px 14px rgba(0, 0, 0, 0.22);
      }
      footer .social a.iso-pro .svg,
      footer .social a.iso-pro svg {
        width: 22px;
        height: 22px;
        transition: transform 0.3s;
        color: currentColor;
        fill: currentColor;
      }
      footer .social a.iso-pro:hover .svg,
      footer .social a.iso-pro:hover svg {
        transform: translate(5px, -5px);
      }
      footer .social a.iso-pro span {
        opacity: 0;
        position: absolute;
        inset: 0;
        margin: auto;
        height: 48px;
        width: 48px;
        border-radius: 50%;
        border: 2px solid currentColor;
        transition: transform 0.3s, opacity 0.3s;
        pointer-events: none;
      }
      footer .social a.iso-pro:hover span {
        opacity: 1;
      }
      footer .social a.iso-pro:hover span:nth-child(1) {
        opacity: 0.22;
        transform: translate(0, -0);
      }
      footer .social a.iso-pro:hover span:nth-child(2) {
        opacity: 0.42;
        transform: translate(4px, -4px);
      }
      footer .social a.iso-pro:hover span:nth-child(3) {
        opacity: 0.62;
        transform: translate(8px, -8px);
      }
      footer .social a.iso-pro .text {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translate(10px, -50%) skew(-5deg);
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        z-index: 10;
        font: 600 12px/1.2 Inter, ui-sans-serif;
        padding: 6px 8px;
        border-radius: 6px;
        color: currentColor;
        background: rgba(255, 255, 255, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.28);
        box-shadow: -5px 0 1px rgba(153, 153, 153, 0.18),
          -10px 0 1px rgba(153, 153, 153, 0.14),
          inset 0 0 20px rgba(255, 255, 255, 0.24),
          inset 0 0 5px rgba(255, 255, 255, 0.32), 0 5px 5px rgba(0, 0, 0, 0.12);
        transition: opacity 0.25s, transform 0.25s;
      }
      footer .social a.iso-pro:hover .text {
        opacity: 1;
        transform: translate(18px, -50%) skew(-5deg);
      }
      footer .social a.iso-pro.is-fb,
      footer .social a.iso-pro.is-gh,
      footer .social a.iso-pro.is-mail,
      footer .social a.iso-pro.is-discord {
        color: #ffffff;
      }
      footer .social a.iso-pro:focus-visible {
        outline: 2px solid var(--acc);
        outline-offset: 3px;
        box-shadow: 0 0 0 6px var(--ring);
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="container nav" role="navigation" aria-label="Primary">
        <div class="brand">
          <a href="/"
            ><img
              class="logo"
              src="/static/icon.png"
              alt="TAOMA logo"
              width="28"
              height="28"
          /></a>
          <a href="/"><span>TAOMA™</span></a>
        </div>

        <button
          type="button"
          class="mobile-toggle"
          id="mobileToggle"
          aria-controls="primary-menu"
          aria-expanded="false"
          aria-label="Toggle menu"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M4 6H20M4 12H20M4 18H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>

        <nav id="primary-menu" class="links" aria-label="Site">
          <a href="/">Home</a>
          <a href="/projects">Projects</a>
          <a href="/about">About</a>
          <a href="/contact">Contact</a>
          <a href="/skills">Skills</a>
        </nav>

        <div id="authSlot" class="auth"></div>
      </div>
    </header>

    <!-- Main -->
    <main class="container">
      <section class="card chat-wrap" aria-label="Global Chat">
        <div class="chat-head">
          <h2 class="chat-title">Global Chat</h2>
          <div id="status" class="status" aria-live="polite">
            <span id="statusDot" class="dot"></span>
            <span id="statusText" class="muted">Connecting…</span>
          </div>
        </div>

        <div
          id="chat"
          class="chat"
          aria-live="polite"
          aria-relevant="additions"
        ></div>

        <form id="chatForm" class="composer">
          <div class="input">
            <input
              id="text"
              type="text"
              autocomplete="off"
              placeholder="Type a message…"
            />
          </div>
          <button class="btn send" type="submit" aria-label="Send message">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M22 2L11 13"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M22 2l-7 20-4-9-9-4 20-7Z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linejoin="round"
              />
            </svg>
            Send
          </button>
        </form>
      </section>
    </main>

    <!-- Footer -->
    <footer>
      <div class="container foot">
        <small class="muted"
          >© <span id="year"></span> TAOMA™. All rights reserved.</small
        >
        <div class="social">
          <a
            href="https://guns.lol/taoma"
            target="_blank"
            rel="noreferrer"
            aria-label="guns.lol"
            class="iso-pro is-fb"
          >
            <span></span><span></span><span></span>
            <svg
              width="18"
              height="18"
              viewBox="0 0 512 512"
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              class="svg"
            >
              <path
                d="M256 32C132 32 32 132 32 256s100 224 224 224 224-100 224-224S380 32 256 32Zm80 160h32v32h-32v32h-32v-32h-32v-32h32v-32h32v32Z"
              />
            </svg>
            <div class="text">guns.lol</div>
          </a>
          <a
            href="https://github.com/TaomasSpace"
            target="_blank"
            rel="noreferrer"
            aria-label="GitHub"
            class="iso-pro is-gh"
          >
            <span></span><span></span><span></span>
            <svg viewBox="0 0 24 24" fill="none" class="svg">
              <path
                d="M12 2C6.477 2 2 6.477 2 12a10 10 0 0 0 6.838 9.488c.5.092.682-.216.682-.48 0-.237-.01-1.026-.015-1.862-2.782.604-3.369-1.18-3.369-1.18-.455-1.156-1.11-1.464-1.11-1.464-.907-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.088 2.91.833.092-.647.35-1.088.636-1.339-2.22-.252-4.555-1.11-4.555-4.943 0-1.091.39-1.987 1.03-2.688-.103-.252-.447-1.268.098-2.643 0 0 .84-.269 2.75 1.026A9.58 9.58 0 0 1 12 6.844c.85.004 1.707.115 2.506.337 1.909-1.295 2.748-1.026 2.748-1.026.547 1.375.203 2.39.1 2.643.64.701 1.028 1.597 1.028 2.688 0 3.842-2.338 4.688-4.566 4.936.358.31.677.92.677 1.855 0 1.338-.012 2.419-.012 2.748 0 .267.18.577.688.478A10.003 10.003 0 0 0 22 12c0-5.523-4.477-10-10-10Z"
                fill="currentColor"
              />
            </svg>
            <div class="text">GitHub</div>
          </a>
          <a
            href="mailto:Taoma.M@proton.me"
            aria-label="Email"
            class="iso-pro is-mail"
          >
            <span></span><span></span><span></span>
            <svg viewBox="0 0 24 24" fill="none" class="svg">
              <rect
                x="3"
                y="5"
                width="18"
                height="14"
                rx="2"
                stroke="currentColor"
                stroke-width="2"
                stroke-linejoin="round"
              />
              <path
                d="M3 7l9 6 9-6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <div class="text">Email</div>
          </a>
          <a
            href="https://discord.gg/H3NDg7e3vD"
            target="_blank"
            rel="noreferrer"
            aria-label="Discord"
            class="iso-pro is-discord"
          >
            <span></span><span></span><span></span>
            <svg viewBox="0 0 24 24" fill="none" class="svg">
              <path
                d="M20 4a18 18 0 0 0-4.5-1.5l-.2.4A16.4 16.4 0 0 1 12 3c-1.1 0-2.2.1-3.3.3l-.2-.4A18 18 0 0 0 4 4c-1.3 2-2 4.2-2 6.5 0 6.7 4.5 8.6 8.8 8.6h.7l-.3-1a9 9 0 0 1-1.7-.6l.4-.2c.8.4 1.7.6 2.6.6s1.8-.2 2.6-.6l.4.2a9 9 0 0 1-1.7.6l-.3 1h.7C17.5 19.1 22 17.2 22 10.5 22 8.2 21.3 6 20 4ZM9.5 14.2c-.8 0-1.5-.8-1.5-1.8s.7-1.8 1.5-1.8S11 11.4 11 12.4s-.7 1.8-1.5 1.8Zm5 0c-.8 0-1.5-.8-1.5-1.8s.7-1.8 1.5-1.8 1.5.8 1.5 1.8-.7 1.8-1.5 1.8Z"
                stroke="currentColor"
                stroke-width="0.5"
                fill="currentColor"
              />
            </svg>
            <div class="text">Discord</div>
          </a>
        </div>
      </div>
    </footer>

    <script>
      // Mobile menu toggle
      const toggle = document.getElementById("mobileToggle");
      const menu = document.getElementById("primary-menu");
      toggle?.addEventListener("click", () => {
        const open = menu.classList.toggle("open");
        toggle.setAttribute("aria-expanded", String(open));
      });
      document.getElementById("year").textContent = new Date().getFullYear();

      // --- Helpers
      const chatEl = document.getElementById("chat");
      const statusText = document.getElementById("statusText");
      const statusDot = document.getElementById("statusDot");
      const form = document.getElementById("chatForm");
      const input = document.getElementById("text");

      function setStatus(state, text) {
        statusText.textContent = text;
        statusDot.classList.remove("ok", "warn", "err");
        if (state === "ok") statusDot.classList.add("ok");
        else if (state === "warn") statusDot.classList.add("warn");
        else if (state === "err") statusDot.classList.add("err");
      }
      function esc(s) {
        return String(s ?? "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      function addMessage(
        text,
        { me = false, meta = null, system = false } = {}
      ) {
        const wrap = document.createElement("div");
        wrap.className = "msg" + (me ? " me" : "") + (system ? " sys" : "");
        if (meta) {
          const m = document.createElement("div");
          m.className = "meta";
          m.textContent = meta;
          wrap.appendChild(m);
        }
        const p = document.createElement("div");
        p.innerHTML = esc(text);
        wrap.appendChild(p);
        chatEl.appendChild(wrap);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      // --- WebSocket bootstrap (keeps your logic)
      const defaultWsUrl = (() => {
        const protocol = location.protocol === "https:" ? "wss" : "ws";
        const host = location.host || location.hostname;
        return `${protocol}://${host}/ws/global-chat`;
      })();
      const wsUrl = window.GLOBAL_CHAT_WS_URL || defaultWsUrl;
      let ws;
      let reconnectAttempts = 0;

      function connect() {
        try {
          ws = new WebSocket(wsUrl);
        } catch (err) {
          setStatus("err", "Invalid WebSocket URL");
          return;
        }

        ws.addEventListener("open", () => {
          reconnectAttempts = 0;
          setStatus("ok", "Connected");
          addMessage("You are connected to the global chat.", { system: true });
        });

        ws.addEventListener("message", (ev) => {
          addMessage(String(ev.data), { me: false });
        });

        ws.addEventListener("error", (e) => {
          setStatus("warn", "Connection issue");
        });

        ws.addEventListener("close", () => {
          setStatus("warn", "Disconnected — retrying…");
          // simple backoff up to ~5s
          const delay = Math.min(5000, 500 * Math.pow(2, reconnectAttempts++));
          setTimeout(connect, delay);
        });
      }
      connect();

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const msg = input.value.trim();
        if (!msg) return;
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(msg);
          addMessage(msg, { me: true, meta: "You" });
          input.value = "";
          input.focus();
        } else {
          addMessage("Not connected. Message not sent.", { system: true });
        }
      });

      // Optional: Ctrl/Cmd+Enter to send
      input.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          form.requestSubmit();
        }
      });

      // --- (Optional) Auth dropdown from your site (safe if endpoints exist) ---
      async function fetchSession() {
        try {
          const r = await fetch("/api/auth/verify", { credentials: "include" });
          if (!r.ok) return null;
          return await r.json();
        } catch {
          return null;
        }
      }
      function escapeHtml(value) {
        return String(value ?? "").replace(
          /[&<>"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch] || ch)
        );
      }
      function sanitizeUrl(raw) {
        if (typeof raw !== "string") return "";
        const trimmed = raw.trim();
        if (!trimmed || trimmed.startsWith("javascript:")) return "";
        try {
          const u = new URL(trimmed, window.location.origin);
          if (["http:", "https:"].includes(u.protocol)) return u.href;
        } catch {
          if (trimmed.startsWith("/") && !trimmed.startsWith("//"))
            return trimmed;
        }
        return "";
      }
      async function renderAuthHeader() {
        const slot = document.getElementById("authSlot");
        if (!slot) return;
        const session = await fetchSession();
        const user = session?.user || null;
        const isAdmin = !!(user && user.admin);
        if (!user) {
          slot.innerHTML = `<a class="btn small" href="/login">Login</a><a class="btn small" href="/register">Register</a>`;
          return;
        }
        const uname = escapeHtml(user.username || "User");
        const initials =
          (user.username || "User").trim().slice(0, 2).toUpperCase() || "U";
        const pfp = sanitizeUrl(
          user.profile_picture ? String(user.profile_picture) : ""
        );
        slot.innerHTML = `
        <div class="auth-box" style="position:relative">
          <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false">
            ${
              pfp
                ? `<img class="avatar" src="${pfp}" alt="${uname}'s profile picture">`
                : `<span class="avatar-fallback" aria-hidden="true">${initials}</span>`
            }
            <span class="uname" style="font-weight:700;font-size:.95rem">${uname}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="menu" id="userMenu" role="menu" aria-label="User menu">
            <a href="/profile" role="menuitem">Profile</a>
            ${isAdmin ? `<a href="/admin" role="menuitem">Admin</a>` : ``}
            <button id="logoutBtn" role="menuitem">Logout</button>
          </div>
        </div>`;
        const btn = slot.querySelector("#avatarBtn");
        const menu = slot.querySelector("#userMenu");
        const logoutBtn = slot.querySelector("#logoutBtn");
        function closeMenu() {
          menu.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
        }
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = menu.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
        document.addEventListener("click", (e) => {
          if (!menu.contains(e.target) && !btn.contains(e.target)) closeMenu();
        });
        logoutBtn.addEventListener(
          "click",
          async () => {
            try {
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "include",
              });
            } catch {}
            window.location.href = "/";
          },
          { passive: true }
        );
      }
      renderAuthHeader();
    </script>
  </body>
</html>
