<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <style>
      #chat {
        font-family: system-ui, sans-serif;
        max-width: 700px;
        margin: 1rem auto;
      }
      .message {
        margin: 0.25rem 0;
      }
      #status {
        margin: 1rem auto;
        max-width: 700px;
      }
      form {
        display: flex;
        gap: 0.5rem;
        max-width: 700px;
        margin: 0.5rem auto;
      }
      input[type="text"] {
        flex: 1;
        padding: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div id="status">Connecting to server...</div>

    <div id="chat"></div>
    <form id="chatForm">
      <input
        type="text"
        id="text"
        autocomplete="off"
        placeholder="Type a message..."
      />
      <button type="submit">Send</button>
    </form>
  </body>
  <script>
    const chat = document.getElementById("chat");
    const status = document.getElementById("status");

    const defaultWsUrl = (() => {
      const protocol = location.protocol === "https:" ? "wss" : "ws";
      const host = location.host || location.hostname;
      return `${protocol}://${host}/ws/global-chat`;
    })();

    const wsUrl = window.GLOBAL_CHAT_WS_URL || defaultWsUrl;

    const ws = new WebSocket(wsUrl);

    ws.addEventListener("open", () => {
      status.textContent = "Connected to server";
      status.style.color = "green";
    });

    ws.addEventListener("message", (ev) => {
      const p = document.createElement("p");
      p.className = "message";
      p.textContent = String(ev.data);
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    });

    ws.addEventListener("error", (e) => {
      status.textContent = "Error: " + (e.message || e.type);
      status.style.color = "red";
    });
    const form = document.getElementById("chatForm");
    const input = document.getElementById("text");
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if (!msg) return;
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(msg);
        input.value = "";
      }
    });
    ws.addEventListener("close", () => {
      status.textContent = "Disconnected from server";
      status.style.color = "orange";
    });
  </script>
</html>
