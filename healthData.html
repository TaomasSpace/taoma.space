<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alexandra Health Data</title>
    <style>
      :root {
        --accent: #2563eb;
        --muted: #666;
        --danger: #b91c1c;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        padding: 1rem;
        max-width: 1000px;
        margin: auto;
      }
      .tabs {
        display: flex;
        gap: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 1rem;
      }
      .tab {
        padding: 0.5rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-bottom: none;
        border-radius: 0.5rem 0.5rem 0 0;
        cursor: pointer;
        background: #f9fafb;
      }
      .tab.active {
        background: white;
        color: var(--accent);
        font-weight: 600;
      }
      .panel {
        display: none;
      }
      .panel.active {
        display: block;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr minmax(180px, 1fr) 48px;
        gap: 1rem;
        align-items: center;
        margin: 0.5rem 0;
      }
      .row output.val {
        text-align: right;
        font-variant-numeric: tabular-nums;
        color: #374151;
      }
      .row input[type="range"] {
        width: 100%;
      }
      .actions {
        margin-top: 1rem;
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      .hint {
        color: var(--muted);
        font-size: 0.9rem;
      }
      #status {
        font-size: 0.95rem;
      }

      /* Historie */
      .filters {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }
      .filters label {
        display: block;
        font-size: 0.85rem;
        color: var(--muted);
      }
      .filters input {
        width: 100%;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead th {
        text-align: left;
        font-weight: 600;
        background: #f3f4f6;
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
      }
      tbody td {
        padding: 0.5rem;
        border-bottom: 1px solid #f1f5f9;
      }
      tbody tr {
        cursor: pointer;
      }
      tbody tr:hover {
        background: #f8fafc;
      }
      .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin: 0.75rem 0;
      }
      button,
      .btn {
        padding: 0.5rem 0.75rem;
        border: 1px solid #e5e7eb;
        background: white;
        border-radius: 0.5rem;
        cursor: pointer;
      }
      button.primary {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }
      button.danger {
        background: var(--danger);
        color: white;
        border-color: var(--danger);
      }
      .pill {
        font-size: 0.8rem;
        padding: 0.15rem 0.4rem;
        border-radius: 0.5rem;
        background: #eef2ff;
      }
      .right {
        margin-left: auto;
      }

      /* Modal */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal {
        background: white;
        padding: 1rem;
        border-radius: 0.75rem;
        width: min(600px, 95vw);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .modal header {
        font-weight: 700;
        margin-bottom: 0.5rem;
      }
      .modal .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }
      .modal footer {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 0.75rem;
      }
      .chart-wrap {
        position: relative;
        height: 420px; /* feste Arbeits-Höhe */
        max-height: 70vh; /* optional: nicht höher als 70% Viewport */
        width: 100%;
      }
      #healthChart {
        position: absolute;
        inset: 0;
        width: 100% !important;
        height: 100% !important; /* Chart nimmt exakt die Wrapper-Höhe */
      }
      .info-wrap {
        display: inline-block;
        position: relative;
        margin-left: 0.4rem;
        cursor: help;
        user-select: none;
      }
      .info-wrap .badge {
        display: inline-block;
        font-size: 0.85rem;
        line-height: 1;
        border: 1px solid #e5e7eb;
        border-radius: 0.4rem;
        padding: 0.12rem 0.35rem;
        background: #f9fafb;
        color: #374151;
      }
      .info-wrap .tooltip {
        position: absolute;
        top: 130%;
        left: 0;
        z-index: 20;
        display: none;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 8px 26px rgba(0, 0, 0, 0.15);
        padding: 0.5rem;
        width: min(420px, 80vw);
      }
      .info-wrap:hover .tooltip {
        display: block;
      }
      .info-wrap .tooltip img {
        max-width: 100%;
        height: auto;
        display: block;
      }
      .info-wrap .tooltip a {
        color: var(--accent);
      }
    </style>
  </head>
  <body>
    <h1>Health Tracking</h1>

    <div class="tabs">
      <div class="tab active" data-tab="capture">Erfassen</div>
      <div class="tab" data-tab="history">Historie</div>
      <div class="tab" data-tab="stats">Statistik</div>
    </div>

    <!-- Panel: Erfassen -->
    <div class="panel active" id="panel-capture">
      <div class="row">
        <label for="Borg">
          Borg Skala (0–20)
          <span class="info-wrap">
            <span class="badge">ℹ️</span>
            <span class="tooltip">
              <!-- Bild: verwende am besten eine DIREKTE Bild-URL.
             Falls dein Google-Redirect nicht lädt, bleibt hier einfach der Link. -->
              <img
                src="https://www.amsel.de/fileadmin/_processed_/c/2/csm_borg-skala_9f7b2c0d3b.png"
                alt="Borg-Skala"
                loading="lazy"
                referrerpolicy="no-referrer"
                onerror="this.replaceWith(document.getElementById('borg-fallback').content.cloneNode(true))"
              />
              <div>
                <a
                  href="https://www.amsel.de/multiple-sklerose/ms-themen/ms-und-sport/einfuehrung/worauf-muessen-menschen-mit-ms-beim-sport-achten/"
                  target="_blank"
                  rel="noopener"
                >
                  Quelle öffnen
                </a>
              </div>
            </span>
          </span>
        </label>
        <input type="range" max="20" min="0" id="Borg" value="0" />
      </div>
      <div class="row">
        <label for="Erschoepfung">Erschöpfung (0–10)</label
        ><input type="range" max="10" min="0" id="Erschoepfung" value="0" />
      </div>
      <div class="row">
        <label for="Muskelschwaeche">Muskelschwäche (0–10)</label
        ><input type="range" max="10" min="0" id="Muskelschwaeche" value="0" />
      </div>
      <div class="row">
        <label for="Schmerzen">Schmerzen (0–10)</label
        ><input type="range" max="10" min="0" id="Schmerzen" value="0" />
      </div>
      <div class="row">
        <label for="Angst">Angst (0–10)</label
        ><input type="range" max="10" min="0" id="Angst" value="0" />
      </div>
      <div class="row">
        <label for="Konzentration">Konzentration/Gedächtnis (0–10)</label
        ><input type="range" max="10" min="0" id="Konzentration" value="0" />
      </div>
      <div class="row">
        <label for="Husten">Husten (0–10)</label
        ><input type="range" max="10" min="0" id="Husten" value="0" />
      </div>
      <div class="row">
        <label for="Atemnot">Atemnot (0–10)</label
        ><input type="range" max="10" min="0" id="Atemnot" value="0" />
      </div>

      <div class="row">
        <label for="Temperatur">Temperatur (°C)</label>
        <input
          type="number"
          max="45"
          min="20"
          id="Temperatur"
          value="36"
          step="0.1"
        />
      </div>

      <div class="row">
        <label for="Mens">Mens</label><input type="checkbox" id="Mens" />
      </div>
      <div class="row">
        <label for="Notizen">Notizen</label
        ><input type="text" id="Notizen" placeholder="optional" />
      </div>

      <div class="actions">
        <button id="saveBtn" class="primary">Save</button>
        <span class="hint">speichert für <span id="todayLabel"></span></span>
        <span id="status"></span>
      </div>
    </div>

    <!-- Panel: Historie -->
    <div class="panel" id="panel-history">
      <div class="toolbar">
        <strong>Einträge</strong>
        <span class="pill" id="countBadge">0</span>
        <button id="refreshBtn" class="btn">Neu laden</button>
        <span class="right"></span>
      </div>

      <div class="filters">
        <div>
          <label for="fDateFrom">Datum von</label>
          <input type="date" id="fDateFrom" />
        </div>
        <div>
          <label for="fDateTo">Datum bis</label>
          <input type="date" id="fDateTo" />
        </div>
        <div>
          <label for="fMinBorg">min Borg</label>
          <input type="number" id="fMinBorg" min="0" max="20" />
        </div>
        <div>
          <label for="fMinPain">min Schmerzen</label>
          <input type="number" id="fMinPain" min="0" max="10" />
        </div>
        <div>
          <label for="fMens">Mens</label>
          <select id="fMens">
            <option value="">egal</option>
            <option value="true">ja</option>
            <option value="false">nein</option>
          </select>
        </div>
        <div>
          <label for="fQuery">Notizen enthält</label>
          <input type="text" id="fQuery" placeholder="Stichwort" />
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Borg</th>
            <th>Schmerzen</th>
            <th>Atemnot</th>
            <th>Temp</th>
            <th>Mens</th>
            <th>Notizen</th>
            <th style="width: 150px">Aktionen</th>
          </tr>
        </thead>
        <tbody id="healthTableBody"></tbody>
      </table>
    </div>
    <!-- Panel: Statistik -->
    <div class="panel" id="panel-stats">
      <div class="toolbar">
        <strong>Diagramm</strong>
        <span class="right"></span>
        <label
          >Zeitraum:
          <select id="sRange">
            <option value="7">7 Tage</option>
            <option value="30" selected>30 Tage</option>
            <option value="90">90 Tage</option>
            <option value="365">12 Monate</option>
            <option value="all">Alles</option>
          </select>
        </label>
      </div>
      <div
        style="
          display: flex;
          gap: 1rem;
          flex-wrap: wrap;
          margin: 0.5rem 0 0.75rem;
        "
      >
        <!-- left scale fields -->
        <label
          ><input type="checkbox" class="sMetric" value="borg" checked />
          Borg</label
        >
        <label
          ><input type="checkbox" class="sMetric" value="schmerzen" />
          Schmerzen</label
        >
        <label
          ><input type="checkbox" class="sMetric" value="atemnot" />
          Atemnot</label
        >
        <label
          ><input type="checkbox" class="sMetric" value="husten" />
          Husten</label
        >
        <label
          ><input type="checkbox" class="sMetric" value="angst" /> Angst</label
        >
        <label
          ><input type="checkbox" class="sMetric" value="konzentration" />
          Konzentration</label
        >
        <label
          ><input type="checkbox" class="sMetric" value="erschoepfung" />
          Erschöpfung</label
        >
        <label
          ><input type="checkbox" class="sMetric" value="muskelschwaeche" />
          Muskelschwäche</label
        >
        <!-- right scale field -->
        <label
          ><input type="checkbox" class="sMetric" value="temperatur" />
          Temperatur (°C)</label
        >
      </div>

      <div class="chart-wrap">
        <canvas id="healthChart"></canvas>
      </div>
    </div>

    <!-- Modal: Bearbeiten/Löschen -->
    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <header>Eintrag bearbeiten</header>
        <div id="modalContent">
          <div class="grid">
            <label>Datum <input type="date" id="m_day" /></label>
            <label
              >Borg <input type="number" id="m_borg" min="0" max="20"
            /></label>
            <label
              >Temperatur
              <input type="number" id="m_temp" step="0.1" min="20" max="45"
            /></label>
            <label
              >Erschöpfung <input type="number" id="m_ersch" min="0" max="10"
            /></label>
            <label
              >Muskelschwäche
              <input type="number" id="m_muskel" min="0" max="10"
            /></label>
            <label
              >Schmerzen <input type="number" id="m_schmerz" min="0" max="10"
            /></label>
            <label
              >Angst <input type="number" id="m_angst" min="0" max="10"
            /></label>
            <label
              >Konzentration <input type="number" id="m_konz" min="0" max="10"
            /></label>
            <label
              >Husten <input type="number" id="m_husten" min="0" max="10"
            /></label>
            <label
              >Atemnot <input type="number" id="m_atem" min="0" max="10"
            /></label>
            <label
              >Mens
              <select id="m_mens">
                <option value="false">nein</option>
                <option value="true">ja</option>
              </select></label
            >
            <label>Notizen <input type="text" id="m_note" /></label>
          </div>
        </div>
        <footer>
          <button id="btnDelete" class="danger">Löschen</button>
          <span style="flex: 1"></span>
          <button id="btnCancel">Abbrechen</button>
          <button id="btnSaveEdit" class="primary">Speichern</button>
        </footer>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>

    <script>
      let mensMarkedLabels = new Set();

      const mensHighlighter = {
        id: "mensHighlighter",
        beforeDatasetsDraw(chart, args, pluginOpts) {
          if (!mensMarkedLabels.size) return;

          const { ctx, chartArea, scales } = chart;
          const x = scales.x;
          if (!x?.ticks?.length) return;

          ctx.save();
          ctx.fillStyle = "rgba(220, 38, 38, 0.08)"; // zartes Rot

          const tickCount = x.ticks.length;
          for (let i = 0; i < tickCount; i++) {
            const label = x.ticks[i].label;
            if (!mensMarkedLabels.has(label)) continue;

            // Breite zwischen Ticks abschätzen
            const curr = x.getPixelForTick(i);
            const prev =
              i > 0
                ? x.getPixelForTick(i - 1)
                : curr - (x.getPixelForTick(i + 1) - curr);
            const next =
              i < tickCount - 1
                ? x.getPixelForTick(i + 1)
                : curr + (curr - prev);
            const left = (prev + curr) / 2;
            const right = (curr + next) / 2;
            const w = Math.max(1, right - left);

            ctx.fillRect(
              left,
              chartArea.top,
              w,
              chartArea.bottom - chartArea.top
            );
          }
          ctx.restore();
        },
      };

      Chart.register(mensHighlighter);
      // ===== Config =====
      const API_BASE = "/alexandra/data/health"; // ändere zu "/api/health" falls du die API-Route nutzt

      // ===== Utils =====
      const $ = (id) => document.getElementById(id);
      const todayISO = () => {
        const d = new Date();
        const y = d.getFullYear(),
          m = String(d.getMonth() + 1).padStart(2, "0"),
          day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      };
      const toISODate = (s) => s?.slice(0, 10);
      const fmtTemp = (v) => (v != null ? Number(v).toFixed(1) : "");

      // ===== Tabs =====
      document.querySelectorAll(".tab").forEach((t) => {
        t.addEventListener("click", () => {
          document
            .querySelectorAll(".tab")
            .forEach((x) => x.classList.remove("active"));
          document
            .querySelectorAll(".panel")
            .forEach((x) => x.classList.remove("active"));
          t.classList.add("active");
          const id =
            t.dataset.tab === "capture"
              ? "panel-capture"
              : t.dataset.tab === "history"
              ? "panel-history"
              : "panel-stats";
          document.getElementById(id).classList.add("active");
          if (id === "panel-history") loadTable();
          if (id === "panel-stats") initStats(); // <-- NEW
        });
      });

      // ===== Capture panel logic =====
      $("todayLabel").textContent = todayISO();

      async function createOrUpdateData() {
        const statusEl = $("status");
        statusEl.textContent = "…speichere";
        statusEl.style.color = "";

        const day = todayISO();
        const payload = {
          day: day,
          borg: parseInt($("Borg").value, 10),
          temperatur: parseFloat($("Temperatur").value),
          erschoepfung: parseInt($("Erschoepfung").value, 10),
          muskelschwaeche: parseInt($("Muskelschwaeche").value, 10),
          schmerzen: parseInt($("Schmerzen").value, 10),
          angst: parseInt($("Angst").value, 10),
          konzentration: parseInt($("Konzentration").value, 10),
          husten: parseInt($("Husten").value, 10),
          atemnot: parseInt($("Atemnot").value, 10),
          mens: $("Mens").checked,
          notizen: $("Notizen").value?.trim() || null,
        };

        try {
          const check = await fetch(`${API_BASE}/by-day/${day}`);
          if (check.ok) {
            const existing = await check.json();
            const id = existing.id;
            const res = await fetch(`${API_BASE}/${id}`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error(`PATCH failed: ${res.status}`);
            statusEl.textContent = "Aktualisiert ✔";
            statusEl.style.color = "green";
          } else if (check.status === 404) {
            const res = await fetch(`${API_BASE}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error(`POST failed: ${res.status}`);
            statusEl.textContent = "Gespeichert ✔";
            statusEl.style.color = "green";
            if (
              document
                .querySelector('[data-tab="stats"]')
                .classList.contains("active")
            ) {
              await ensureListLoaded(); // oder allRows pushen/aktualisieren
              updateChart();
            }
          } else {
            throw new Error(`Lookup failed: ${check.status}`);
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Fehler beim Speichern";
          statusEl.style.color = "crimson";
          alert(String(err));
        }
      }
      $("saveBtn").addEventListener("click", (e) => {
        e.preventDefault();
        createOrUpdateData();
      });

      // ===== History panel logic =====
      let allRows = []; // Cache von /list
      let currentRow = null; // für Modal

      async function loadTable() {
        try {
          const res = await fetch(`${API_BASE}`); // GET: list
          if (!res.ok) throw new Error(`GET list failed: ${res.status}`);
          allRows = await res.json();
          renderTable();
        } catch (e) {
          console.error(e);
          alert("Konnte Einträge nicht laden.");
        }
      }

      function applyFilters(rows) {
        const df = $("fDateFrom").value;
        const dt = $("fDateTo").value;
        const minB = $("fMinBorg").value
          ? parseInt($("fMinBorg").value, 10)
          : null;
        const minP = $("fMinPain").value
          ? parseInt($("fMinPain").value, 10)
          : null;
        const mens = $("fMens").value; // "", "true", "false"
        const q = $("fQuery").value.trim().toLowerCase();

        return rows.filter((r) => {
          const d = toISODate(r.day || r["day"]); // je nach API könnte day schon Date sein
          if (df && d < df) return false;
          if (dt && d > dt) return false;
          if (minB != null && (r.borg ?? 0) < minB) return false;
          if (minP != null && (r.schmerzen ?? 0) < minP) return false;
          if (mens === "true" && !r.mens) return false;
          if (mens === "false" && r.mens) return false;
          if (q && !(r.notizen || "").toLowerCase().includes(q)) return false;
          return true;
        });
      }

      function renderTable() {
        const rows = applyFilters(allRows);
        $("countBadge").textContent = rows.length;
        const tb = $("healthTableBody");
        tb.innerHTML = "";
        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                  <td>${toISODate(r.day)}</td>
                  <td>${r.borg ?? ""}</td>
                  <td>${r.schmerzen ?? ""}</td>
                  <td>${r.atemnot ?? ""}</td>
                  <td>${fmtTemp(r.temperatur)}</td>
                  <td>${r.mens ? "ja" : "nein"}</td>
                  <td>${(r.notizen || "").replace(/</g, "&lt;")}</td>
                  <td>
                    <button class="btn" data-action="edit">Bearbeiten</button>
                    <button class="btn danger" data-action="delete">Löschen</button>
                  </td>
                `;
          tr.querySelector('[data-action="edit"]').addEventListener(
            "click",
            (e) => {
              e.stopPropagation();
              openEdit(r);
            }
          );
          tr.querySelector('[data-action="delete"]').addEventListener(
            "click",
            (e) => {
              e.stopPropagation();
              confirmDelete(r);
            }
          );
          tr.addEventListener("click", () => openEdit(r));
          tb.appendChild(tr);
        }
      }

      // Filter Events
      [
        "fDateFrom",
        "fDateTo",
        "fMinBorg",
        "fMinPain",
        "fMens",
        "fQuery",
      ].forEach((id) => {
        $(id).addEventListener("input", renderTable);
        $(id).addEventListener("change", renderTable);
      });
      $("refreshBtn").addEventListener("click", loadTable);

      // ===== Statistik (Chart.js) =====
      const METRIC_LABELS = {
        borg: "Borg",
        schmerzen: "Schmerzen",
        atemnot: "Atemnot",
        husten: "Husten",
        angst: "Angst",
        konzentration: "Konzentration",
        erschoepfung: "Erschöpfung", // ASCII key -> Display
        muskelschwaeche: "Muskelschwäche",
        temperatur: "Temperatur (°C)",
      };

      // which metrics use the right axis (°C)
      const RIGHT_AXIS = new Set(["temperatur"]);

      function parseDateISO(d) {
        // d is "YYYY-MM-DD" or a full ISO; return Date at local midnight
        const s = (d || "").slice(0, 10);
        const [Y, M, D] = s.split("-").map(Number);
        return new Date(Y, (M || 1) - 1, D || 1);
      }

      // keep only last N days (or all)
      function filterRange(rows, rangeValue) {
        if (rangeValue === "all") return rows.slice();
        const days = parseInt(rangeValue, 10);
        if (!Number.isFinite(days)) return rows.slice();
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days + 1); // inclusive
        return rows.filter((r) => parseDateISO(r.day) >= cutoff);
      }

      function normalizeRowKeys(r) {
        // Cope with ü/ö fields coming as ASCII keys from API
        return {
          ...r,
          erschoepfung: r.erschoepfung ?? r["erschöpfung"],
          muskelschwaeche: r.muskelschwaeche ?? r["muskelschwäche"],
        };
      }

      function buildDatasets(rows, selected) {
        // rows must be sorted ASC by date
        const labels = rows.map((r) => (r.day || "").slice(0, 10));
        const datasets = [];

        // Chart.js automatic colors if none specified (v4+).
        selected.forEach((metric) => {
          const yAxisID = RIGHT_AXIS.has(metric) ? "yR" : "yL";
          const data = rows.map((r) => {
            const rr = normalizeRowKeys(r);
            const v = rr[metric];
            return v == null ? null : Number(v);
          });
          datasets.push({
            label: METRIC_LABELS[metric] || metric,
            data,
            yAxisID,
            spanGaps: true,
            tension: 0.25, // slight smoothing
            pointRadius: 2,
          });
        });

        return { labels, datasets };
      }

      async function ensureListLoaded() {
        if (allRows && allRows.length) return;
        const res = await fetch(`${API_BASE}`);
        if (!res.ok) throw new Error(`GET list failed: ${res.status}`);
        allRows = await res.json();
      }

      let chart; // Chart.js Instanz
      let statsWired = false; // <— guard

      async function initStats() {
        try {
          await ensureListLoaded();
        } catch (e) {
          console.error(e);
          alert("Konnte Daten für Statistik nicht laden.");
          return;
        }

        if (!statsWired) {
          document.querySelectorAll(".sMetric").forEach((cb) => {
            cb.addEventListener("change", updateChart);
          });
          $("sRange").addEventListener("change", updateChart);
          statsWired = true;
        }
        updateChart();

        // wenn der Tab gerade erst sichtbar wurde, einmal sauber layouten
        queueMicrotask(() => chart?.resize());
      }

      function updateChart() {
        const selected = [...document.querySelectorAll(".sMetric:checked")].map(
          (c) => c.value
        );
        if (selected.length === 0) {
          // default to Borg if nothing is selected
          document.querySelector('.sMetric[value="borg"]').checked = true;
          selected.push("borg");
        }

        // sort ASC by date for chart
        const rowsAsc = filterRange(allRows, $("sRange").value)
          .slice()
          .sort((a, b) => parseDateISO(a.day) - parseDateISO(b.day));

        const { labels, datasets } = buildDatasets(rowsAsc, selected);
        mensMarkedLabels = new Set(
          rowsAsc.filter((r) => r.mens).map((r) => (r.day || "").slice(0, 10))
        );

        // Optional: Punkte an Mens-Tagen rot einfärben
        const pointColors = labels.map((l) =>
          mensMarkedLabels.has(l) ? "crimson" : undefined
        );
        datasets.forEach((ds) => {
          // nur Punkte einfärben, Linie bleibt auto
          ds.pointBackgroundColor = pointColors;
          ds.pointBorderColor = pointColors;
        });
        const cfg = {
          type: "line",
          data: { labels, datasets },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            interaction: { mode: "nearest", intersect: false },
            scales: {
              yL: {
                type: "linear",
                position: "left",
                title: { display: true, text: "Skalen (0–10 / 0–20)" },
                min: 0,
                suggestedMax: 20,
                grid: { drawOnChartArea: true },
              },
              yR: {
                type: "linear",
                position: "right",
                title: { display: true, text: "Temperatur (°C)" },
                min: 20,
                suggestedMax: 40,
                grid: { drawOnChartArea: false },
              },
              x: {
                ticks: { autoSkip: true, maxTicksLimit: 12 },
              },
            },
            plugins: {
              legend: { position: "top" },
              tooltip: {
                callbacks: {
                  // pretty tooltip for date
                  title: (items) => items[0]?.label ?? "",
                },
              },
            },
          },
        };

        const ctx = $("healthChart").getContext("2d");
        if (chart) {
          chart.data.labels = labels;
          chart.data.datasets = datasets;
          chart.options = cfg.options;
          chart.update();
        } else {
          chart = new Chart(ctx, cfg);
        }
      }

      // ===== Modal =====
      function openEdit(row) {
        currentRow = row;
        $("m_day").value = toISODate(row.day);
        $("m_borg").value = row.borg ?? 0;
        $("m_temp").value = row.temperatur ?? 36;
        $("m_ersch").value = row["erschöpfung"] ?? row.erschoepfung ?? 0;
        $("m_muskel").value = row["muskelschwäche"] ?? row.muskelschwaeche ?? 0;
        $("m_schmerz").value = row.schmerzen ?? 0;
        $("m_angst").value = row.angst ?? 0;
        $("m_konz").value = row.konzentration ?? 0;
        $("m_husten").value = row.husten ?? 0;
        $("m_atem").value = row.atemnot ?? 0;
        $("m_mens").value = row.mens ? "true" : "false";
        $("m_note").value = row.notizen || "";
        $("modalBackdrop").style.display = "flex";
      }
      function closeModal() {
        $("modalBackdrop").style.display = "none";
        currentRow = null;
      }
      $("btnCancel").addEventListener("click", closeModal);

      $("btnSaveEdit").addEventListener("click", async () => {
        if (!currentRow) return;
        const id = currentRow.id;
        const payload = {
          day: $("m_day").value,
          borg: parseInt($("m_borg").value, 10),
          temperatur: parseFloat($("m_temp").value),
          erschoepfung: parseInt($("m_ersch").value, 10),
          muskelschwaeche: parseInt($("m_muskel").value, 10),
          schmerzen: parseInt($("m_schmerz").value, 10),
          angst: parseInt($("m_angst").value, 10),
          konzentration: parseInt($("m_konz").value, 10),
          husten: parseInt($("m_husten").value, 10),
          atemnot: parseInt($("m_atem").value, 10),
          mens: $("m_mens").value === "true",
          notizen: $("m_note").value?.trim() || null,
        };
        try {
          const res = await fetch(`${API_BASE}/${id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) throw new Error(`PATCH failed: ${res.status}`);
          closeModal();
          await loadTable();
        } catch (e) {
          console.error(e);
          alert("Speichern fehlgeschlagen.");
        }
      });

      async function confirmDelete(row) {
        if (!confirm(`Eintrag vom ${toISODate(row.day)} wirklich löschen?`))
          return;
        try {
          const res = await fetch(`${API_BASE}/${row.id}`, {
            method: "DELETE",
          });
          if (!res.ok) throw new Error(`DELETE failed: ${res.status}`);
          await loadTable();
        } catch (e) {
          console.error(e);
          alert("Löschen fehlgeschlagen.");
        }
      }

      function wireRangeOutputs() {
        const ranges = document.querySelectorAll('input[type="range"]');
        ranges.forEach((r) => {
          // Falls schon ein Output daneben existiert, wiederverwenden
          let out = r.parentElement.querySelector("output.val");
          if (!out) {
            out = document.createElement("output");
            out.className = "val";
            // neben den Slider einfügen (3. Spalte in .row)
            r.insertAdjacentElement("afterend", out);
          }
          const update = () => {
            out.textContent = r.value;
          };
          r.addEventListener("input", update);
          r.addEventListener("change", update);
          update(); // initialer Wert
        });
      }
      wireRangeOutputs();
    </script>
    <template id="borg-fallback">
      <div style="font-size: 0.9rem; line-height: 1.35">
        <strong>Borg-Skala (vereinfachte Orientierung)</strong>
        <ul style="margin: 0.4rem 0; padding-left: 1rem">
          <li>0–1: sehr leicht</li>
          <li>2–3: leicht</li>
          <li>4–6: etwas anstrengend</li>
          <li>7–8: anstrengend</li>
          <li>9–10: sehr anstrengend</li>
          <li>20 (klassisch): maximale Anstrengung</li>
        </ul>
        <a
          href="https://www.amsel.de/multiple-sklerose/ms-themen/ms-und-sport/einfuehrung/worauf-muessen-menschen-mit-ms-beim-sport-achten/"
          target="_blank"
          rel="noopener"
          >Quelle öffnen</a
        >
      </div>
    </template>
  </body>
</html>
