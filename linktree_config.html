<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAOMA™ — Linktree Config</title>
    <meta name="description" content="Configure your personal linktree." />
    <meta property="og:title" content="TAOMA™ — Linktree Config" />
    <meta
      property="og:description"
      content="Edit your linktree profile, links and badges."
    />
    <meta name="theme-color" content="#0f1223" />
    <link rel="icon" type="image/png" href="/static/icon.png" />
    <style>
      /* =========================================================
         TAOMA — Linktree Config (UI refresh)
         Goal: clearer hierarchy, friendlier colors, better spacing,
               better focus/keyboard accessibility.
         NOTE: No IDs/classes used by JS were changed.
      ========================================================= */

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      :root {
        /* --- Color system (default: dark) --- */
        --bg: #0b1220;
        --bg-grad-1: rgba(122, 162, 255, 0.18);
        --bg-grad-2: rgba(93, 214, 194, 0.12);

        --surface: #0f1a2e;
        --surface-2: #12223d;
        --card: rgba(255, 255, 255, 0.06);
        --card-solid: #0f1a2e;
        --border: rgba(255, 255, 255, 0.12);
        --border-2: rgba(255, 255, 255, 0.18);

        --ink: #eaf0ff;
        --muted: rgba(234, 240, 255, 0.72);
        --muted-2: rgba(234, 240, 255, 0.56);

        --acc: #5dd6c2; /* teal */
        --acc-2: #7aa2ff; /* blue */
        --danger: #ff5a6a;
        --ok: #2fe0a8;

        --ring: rgba(93, 214, 194, 0.45);
        --shadow: 0 18px 55px rgba(0, 0, 0, 0.35);
        --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.25);

        --radius: 18px;
        --radius-sm: 12px;
        --space: clamp(16px, 2vw, 24px);
        --container: 1160px;

        --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Ubuntu, Arial, sans-serif;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f8ff;
          --bg-grad-1: rgba(122, 162, 255, 0.18);
          --bg-grad-2: rgba(93, 214, 194, 0.18);

          --surface: #ffffff;
          --surface-2: #f0f4ff;
          --card: rgba(20, 30, 55, 0.04);
          --card-solid: #ffffff;
          --border: rgba(20, 30, 55, 0.1);
          --border-2: rgba(20, 30, 55, 0.14);

          --ink: #0f172a;
          --muted: rgba(15, 23, 42, 0.72);
          --muted-2: rgba(15, 23, 42, 0.56);

          --shadow: 0 18px 55px rgba(2, 8, 23, 0.1);
          --shadow-soft: 0 10px 28px rgba(2, 8, 23, 0.08);
        }
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font: 15px/1.6 var(--font);
        color: var(--ink);
        background: var(--bg);
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        max-width: 100vw;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        background: radial-gradient(
            900px 500px at 14% -6%,
            var(--bg-grad-1) 0%,
            transparent 60%
          ),
          radial-gradient(
            900px 520px at 95% 0%,
            var(--bg-grad-2) 0%,
            transparent 62%
          ),
          radial-gradient(
            900px 520px at 90% 120%,
            rgba(122, 162, 255, 0.1) 0%,
            transparent 62%
          ),
          linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.06) 100%);
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      img {
        max-width: 100%;
        display: block;
      }

      ::selection {
        background: rgba(93, 214, 194, 0.22);
      }

      .container {
        max-width: var(--container);
        margin: 0 auto;
        padding-inline: var(--space);
      }

      /* ----------------- Buttons ----------------- */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        padding: 0.78rem 1rem;
        border-radius: 999px;
        background: linear-gradient(135deg, var(--acc) 0%, var(--acc-2) 100%);
        color: #0b1220;
        font-weight: 750;
        letter-spacing: 0.2px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-soft);
        transition: transform 0.18s ease, filter 0.18s ease,
          box-shadow 0.18s ease;
        white-space: nowrap;
        cursor: pointer;
      }

      .btn:hover {
        transform: translateY(-1px);
        filter: saturate(1.05);
        box-shadow: var(--shadow);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.ghost {
        background: rgba(255, 255, 255, 0.06);
        color: var(--ink);
        border: 1px solid var(--border);
        box-shadow: none;
      }

      @media (prefers-color-scheme: light) {
        .btn.ghost {
          background: rgba(15, 23, 42, 0.04);
        }
      }

      .btn.sm {
        padding: 0.55rem 0.8rem;
        border-radius: 999px;
        font-size: 0.92rem;
      }

      .btn.small,
      .auth .btn.small {
        padding: 0.55rem 0.85rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        color: var(--ink);
        border: 1px solid var(--border);
        box-shadow: none;
        font-weight: 700;
      }

      .btn.danger {
        background: linear-gradient(
          135deg,
          rgba(255, 90, 106, 1) 0%,
          rgba(255, 170, 84, 1) 100%
        );
        color: #0b1220;
      }

      .btn:focus-visible,
      button:focus-visible,
      a:focus-visible,
      input:focus-visible,
      select:focus-visible,
      textarea:focus-visible {
        outline: 2px solid rgba(93, 214, 194, 0.85);
        outline-offset: 3px;
        box-shadow: 0 0 0 6px var(--ring);
      }

      /* ----------------- Pills / Chips ----------------- */
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.34rem 0.64rem;
        border-radius: 999px;
        background: rgba(93, 214, 194, 0.1);
        border: 1px solid rgba(93, 214, 194, 0.22);
        font-size: 0.9rem;
        color: var(--ink);
      }

      /* ----------------- Cards & Layout ----------------- */
      .card {
        background: linear-gradient(
          180deg,
          var(--card) 0%,
          rgba(255, 255, 255, 0.03) 100%
        );
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow-soft);
        max-width: 100%;
        overflow: hidden;
      }

      @media (prefers-color-scheme: light) {
        .card {
          background: linear-gradient(
            180deg,
            rgba(255, 255, 255, 0.9) 0%,
            rgba(240, 244, 255, 0.85) 100%
          );
        }
      }

      main {
        flex: 1;
        padding-block: clamp(28px, 4.5vw, 60px);
        max-width: 100vw;
        overflow-x: hidden;
      }

      .section-title {
        font-size: clamp(22px, 3vw, 30px);
        margin: 0 0 1rem 0;
        letter-spacing: -0.3px;
      }

      .muted {
        color: var(--muted);
      }

      .help {
        margin-top: 0.25rem;
        color: var(--muted-2);
        font-size: 0.92rem;
      }

      .wrap {
        display: grid;
        grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
        gap: clamp(14px, 2.6vw, 26px);
        align-items: flex-start;
        max-width: 100%;
      }

      @media (max-width: 980px) {
        .wrap {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .panel {
        padding: clamp(16px, 2.2vw, 22px);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .panel h2 {
        margin: 0;
        font-size: clamp(18px, 2.4vw, 22px);
        letter-spacing: -0.2px;
      }

      .panel h3 {
        margin: 0.2rem 0 0.6rem;
        font-size: clamp(16px, 2.2vw, 20px);
        letter-spacing: -0.2px;
      }

      .hr {
        height: 1px;
        background: var(--border);
        margin: 0.9rem 0;
        width: 100%;
      }

      /* ----------------- Header / Nav ----------------- */
      header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: saturate(1.1) blur(12px);
        -webkit-backdrop-filter: saturate(1.1) blur(12px);
        background: rgba(11, 18, 32, 0.72);
        border-bottom: 1px solid var(--border);
      }

      @media (prefers-color-scheme: light) {
        header {
          background: rgba(246, 248, 255, 0.78);
        }
      }

      .nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 68px;
        gap: 0.75rem;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 900;
        letter-spacing: 0.3px;
      }

      .brand .logo {
        width: 30px;
        height: 30px;
        border-radius: 10px;
        display: block;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }

      .links {
        display: flex;
        gap: 0.35rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .links a {
        padding: 0.5rem 0.75rem;
        border-radius: 999px;
        border: 1px solid transparent;
        color: var(--muted);
        font-weight: 650;
        transition: background 0.18s ease, border-color 0.18s ease,
          color 0.18s ease;
      }

      .links a[aria-current="page"] {
        color: var(--ink);
        background: rgba(93, 214, 194, 0.1);
        border-color: rgba(93, 214, 194, 0.22);
      }

      .links a:hover {
        color: var(--ink);
        border-color: var(--border);
        background: rgba(255, 255, 255, 0.06);
      }

      .mobile-toggle {
        display: none;
      }

      @media (max-width: 800px) {
        .mobile-toggle {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 44px;
          height: 44px;
          border-radius: 14px;
          border: 1px solid var(--border);
          background: rgba(255, 255, 255, 0.06);
          color: var(--ink);
        }

        .links {
          position: fixed;
          inset: 68px 12px auto 12px;
          max-width: calc(100vw - 24px);
          background: rgba(11, 18, 32, 0.92);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          padding: 0.85rem;
          display: none;
          flex-direction: column;
          gap: 0.35rem;
          box-shadow: var(--shadow);
        }

        @media (prefers-color-scheme: light) {
          .links {
            background: rgba(255, 255, 255, 0.92);
          }
        }

        .links.open {
          display: flex;
        }

        .links a {
          width: 100%;
        }
      }

      /* ----------------- Forms ----------------- */
      .grid {
        display: grid;
        gap: 12px;
        width: 100%;
      }

      .grid.cols-2 {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        align-items: flex-start;
        column-gap: 16px;
        row-gap: 12px;
      }

      @media (max-width: 720px) {
        .grid.cols-2 {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 0;
      }

      .field label {
        font-weight: 800;
        font-size: 0.95rem;
        letter-spacing: 0.2px;
      }

      details.fold {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 0.5rem 0.7rem;
        background: rgba(255, 255, 255, 0.04);
      }

      details.fold > summary {
        list-style: none;
        cursor: pointer;
        user-select: none;
        font-weight: 800;
        font-size: 0.9rem;
        letter-spacing: 0.2px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      details.fold > summary::-webkit-details-marker {
        display: none;
      }

      details.fold > summary::after {
        content: "▾";
        font-size: 0.9rem;
        transition: transform 0.18s ease;
      }

      details.fold[open] > summary::after {
        transform: rotate(180deg);
      }

      .fold-body {
        margin-top: 0.6rem;
        display: grid;
        gap: 0.6rem;
      }

      .input,
      .select,
      textarea {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        border-radius: 14px;
        color: var(--ink);
        padding: 0.72rem 0.85rem;
        width: 100%;
        max-width: 100%;
        min-width: 0;
        font: inherit;
        transition: border-color 0.18s ease, background 0.18s ease;
      }
      .select {
        background: var(--surface-2);
        color: var(--ink);
      }
      .select option,
      .select optgroup {
        background: var(--surface-2);
        color: var(--ink);
      }

      @media (prefers-color-scheme: light) {
        .input,
        .select,
        textarea {
          background: rgba(15, 23, 42, 0.02);
        }
      }

      .input::placeholder,
      textarea::placeholder {
        color: var(--muted-2);
      }

      .input:focus,
      .select:focus,
      textarea:focus {
        border-color: rgba(93, 214, 194, 0.55);
        background: rgba(93, 214, 194, 0.06);
        outline: none;
      }

      textarea {
        min-height: 92px;
        resize: vertical;
      }

      input[type="file"] {
        max-width: 100%;
        font-size: 14px;
        padding: 0.55rem 0.65rem;
        border-radius: 14px;
        border: 1px dashed var(--border-2);
        background: rgba(255, 255, 255, 0.04);
        color: var(--muted);
      }

      /* Textfelder: Lange Texte umbrechen */
      input[type="text"],
      input[type="url"],
      input[type="password"],
      textarea {
        word-break: break-word;
        overflow-wrap: break-word;
      }

      /* ----------------- Rows / Alerts ----------------- */
      .row {
        display: flex;
        gap: 0.65rem;
        align-items: center;
        flex-wrap: wrap;
        width: 100%;
      }

      .alert {
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 0.72rem 0.85rem;
        width: 100%;
      }

      .alert.ok {
        border-color: rgba(47, 224, 168, 0.4);
        background: rgba(47, 224, 168, 0.1);
      }

      .alert.err {
        border-color: rgba(255, 90, 106, 0.45);
        background: rgba(255, 90, 106, 0.1);
      }

      /* ----------------- Templates ----------------- */
      .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
        width: 100%;
      }

      .template-card {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        flex-direction: column;
        gap: 0.55rem;
        transition: transform 0.18s ease, border-color 0.18s ease,
          background 0.18s ease;
      }

      .template-card:hover {
        transform: translateY(-2px);
        border-color: rgba(93, 214, 194, 0.28);
        background: rgba(93, 214, 194, 0.06);
      }

      .template-card .title {
        font-weight: 900;
        font-size: 1.02rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }

      .template-card .sub {
        color: var(--muted);
        font-size: 0.92rem;
      }

      .template-card .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
        align-items: center;
      }

      /* ----------------- Discord box ----------------- */
      .discord-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.9rem;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
        flex-wrap: wrap;
        width: 100%;
      }

      .discord-preview {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin-top: 0.35rem;
        max-width: 100%;
      }

      .pfp-preview {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.15);
        display: grid;
        place-items: center;
        overflow: hidden;
        border: 1px solid var(--border);
      }

      .pfp-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      /* ----------------- Links list ----------------- */
      .links-list {
        display: grid;
        gap: 10px;
        width: 100%;
      }

      .link-item {
        display: flex;
        align-items: center;
        gap: 0.55rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 0.65rem;
        flex-wrap: wrap;
        width: 100%;
        max-width: 100%;
        transition: border-color 0.18s ease, background 0.18s ease;
      }

      .link-item:hover {
        border-color: rgba(122, 162, 255, 0.28);
        background: rgba(122, 162, 255, 0.06);
      }

      .link-item.dragging {
        opacity: 0.82;
        border-color: rgba(93, 214, 194, 0.55);
        background: rgba(93, 214, 194, 0.1);
      }

      .link-item input {
        flex: 1;
        min-width: 140px;
        max-width: 100%;
      }

      .link-icon-upload {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 160px;
        flex: 1 1 180px;
      }

      .link-icon-upload .muted {
        font-size: 0.85rem;
      }

      .icon-16 {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      .handle {
        cursor: grab;
        opacity: 0.75;
        flex-shrink: 0;
        user-select: none;
      }

      .badge-item {
        display: flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.55rem 0.7rem;
        border: 1px solid var(--border);
        border-radius: 14px;
        width: 100%;
        flex-wrap: wrap;
        background: rgba(255, 255, 255, 0.04);
      }

      .kbd {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-bottom-color: rgba(0, 0, 0, 0.25);
        border-radius: 8px;
        padding: 0.12rem 0.4rem;
        font: 700 12px/1 var(--mono);
      }

      .preview-note {
        font-size: 0.92rem;
        margin-top: 0.35rem;
        word-break: break-all;
        color: var(--muted-2);
      }

      /* ----------------- Auth dropdown ----------------- */
      .auth {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .auth-box {
        position: relative;
      }

      .avatar-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.38rem 0.55rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
        cursor: pointer;
      }

      .avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        display: block;
        background: rgba(0, 0, 0, 0.1);
      }

      .avatar-fallback {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font: 900 12px/1 var(--font);
        background: rgba(122, 162, 255, 0.22);
        color: var(--ink);
      }

      .menu {
        position: absolute;
        right: 0;
        margin-top: 0.55rem;
        min-width: 170px;
        z-index: 60;
        background: rgba(15, 26, 46, 0.96);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 0.35rem;
        display: none;
      }

      @media (prefers-color-scheme: light) {
        .menu {
          background: rgba(255, 255, 255, 0.96);
        }
      }

      .menu.open {
        display: block;
      }

      .menu a,
      .menu button {
        width: 100%;
        text-align: left;
        display: block;
        background: transparent;
        color: var(--ink);
        padding: 0.6rem 0.7rem;
        border: 0;
        border-radius: 12px;
        cursor: pointer;
        font: inherit;
      }

      .menu a:hover,
      .menu button:hover {
        background: rgba(93, 214, 194, 0.1);
      }

      /* ----------------- Footer ----------------- */
      footer {
        border-top: 1px solid var(--border);
        padding-block: 24px;
        margin-top: auto;
      }

      .foot {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .social {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      .social a {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.05);
      }

      /* Keep your existing iso hover, but slightly calmer */
      footer .social a.iso-pro {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.06);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
        transition: transform 0.22s ease, box-shadow 0.22s ease,
          background 0.22s ease;
        overflow: visible;
      }

      footer .social a.iso-pro:hover {
        transform: translateY(-1px);
        background: rgba(93, 214, 194, 0.1);
        box-shadow: 0 14px 26px rgba(0, 0, 0, 0.22);
      }

      footer .social a.iso-pro .svg,
      footer .social a.iso-pro svg {
        width: 22px;
        height: 22px;
        transition: transform 0.22s ease;
        color: currentColor;
        fill: currentColor;
      }

      footer .social a.iso-pro:hover .svg,
      footer .social a.iso-pro:hover svg {
        transform: translate(4px, -4px);
      }

      footer .social a.iso-pro span {
        opacity: 0;
        position: absolute;
        inset: 0;
        margin: auto;
        height: 48px;
        width: 48px;
        border-radius: 50%;
        border: 2px solid currentColor;
        transition: transform 0.22s ease, opacity 0.22s ease;
        pointer-events: none;
      }

      footer .social a.iso-pro:hover span {
        opacity: 1;
      }

      footer .social a.iso-pro:hover span:nth-child(1) {
        opacity: 0.18;
        transform: translate(0px, 0px);
      }

      footer .social a.iso-pro:hover span:nth-child(2) {
        opacity: 0.34;
        transform: translate(3px, -3px);
      }

      footer .social a.iso-pro:hover span:nth-child(3) {
        opacity: 0.5;
        transform: translate(6px, -6px);
      }

      footer .social a.iso-pro .text {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translate(10px, -50%);
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        z-index: 10;
        font: 700 12px/1.2 var(--font);
        padding: 6px 8px;
        border-radius: 10px;
        color: var(--ink);
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid var(--border);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      @media (prefers-color-scheme: light) {
        footer .social a.iso-pro .text {
          background: rgba(15, 23, 42, 0.1);
        }
      }

      footer .social a.iso-pro:hover .text {
        opacity: 1;
        transform: translate(16px, -50%);
      }

      footer .social a.iso-pro:focus-visible {
        outline: 2px solid rgba(93, 214, 194, 0.85);
        outline-offset: 3px;
        box-shadow: 0 0 0 6px var(--ring);
      }

      /* ----------------- Visitor counter ----------------- */
      .visitor-counter {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        font: 800 14px/1.2 var(--font);
        color: var(--ink);
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid var(--border);
      }

      .visitor-counter svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
        color: var(--muted);
      }

      /* ----------------- Mobile ergonomics ----------------- */
      @media (max-width: 640px) {
        .container {
          padding-inline: clamp(12px, 4vw, 16px);
        }

        .panel {
          padding: clamp(12px, 3vw, 16px);
        }

        .input,
        .select,
        textarea {
          font-size: 16px; /* avoid iOS zoom */
          padding: 0.66rem 0.78rem;
        }

        .row {
          flex-direction: column;
          align-items: stretch;
          gap: 0.55rem;
        }

        .row .btn {
          width: 100%;
        }

        .link-item {
          flex-direction: column;
          align-items: stretch;
          gap: 0.5rem;
        }

        .link-item .btn {
          width: 100%;
        }

        .section-title {
          font-size: clamp(20px, 6vw, 26px);
        }

        footer .container {
          flex-direction: column;
          gap: 0.85rem;
          align-items: flex-start;
        }

        .social {
          width: 100%;
          justify-content: center;
        }

        .alert {
          font-size: 0.95rem;
        }
      }

      /* Gallery grid responsiveness (kept) */
      #galleryWrap {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)) !important;
      }

      @media (max-width: 480px) {
        #galleryWrap {
          grid-template-columns: repeat(
            auto-fill,
            minmax(50px, 1fr)
          ) !important;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="container nav" role="navigation" aria-label="Primary">
        <div class="brand">
          <a href="/"
            ><img
              class="logo"
              src="/static/icon.png"
              alt="TAOMA logo"
              width="28"
              height="28"
          /></a>
          <a href="/"><span>TAOMA™</span></a>
        </div>

        <button
          type="button"
          class="mobile-toggle"
          id="mobileToggle"
          aria-controls="primary-menu"
          aria-expanded="false"
          aria-label="Toggle menu"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M4 6H20M4 12H20M4 18H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>

        <nav id="primary-menu" class="links" aria-label="Site">
          <a href="/">Home</a>
          <a href="/api">GIF API</a>
          <a href="/api/gif/admin">Add GIFs</a>
          <a href="/marketplace">Marketplace</a>
          <a href="/linktree/config" aria-current="page">Linktree</a>
        </nav>

        <div id="authSlot" class="auth"></div>
      </div>
    </header>

    <main class="container">
      <h1 class="section-title">Linktree Config</h1>
      <div
        class="row"
        style="
          justify-content: space-between;
          gap: 1rem;
          align-items: flex-start;
          margin-bottom: 10px;
        "
      >
        <div class="muted" style="max-width: 720px">
          Turn your current setup into a reusable template for desktop, mobile,
          or both. Your links and icons stay private.
        </div>
        <a class="btn ghost" id="btnCreateTemplate" href="/marketplace/create"
          >Create template</a
        >
      </div>

      <div id="notLogged" class="alert err" style="display: none">
        Not logged in.
        <a
          href="/login?next=${encodeURIComponent(location.href)}"
          class="btn sm ghost"
          style="margin-left: 0.6rem"
          >Go to Login</a
        >
      </div>

      <div class="wrap" id="cfgWrap" style="display: none">
        <section class="card panel" style="grid-column: 1 / -1">
          <div
            class="row"
            style="
              justify-content: space-between;
              gap: 0.75rem;
              flex-wrap: wrap;
            "
          >
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 4px;
                max-width: 720px;
              "
            >
              <h2 style="margin: 0">Templates</h2>
              <div class="muted">
                Save your current look as a private template and reuse anything
                you've saved from the marketplace.
              </div>
            </div>
            <button class="btn sm" id="btnSavePrivateTemplate" type="button">
              Save as private template
            </button>
          </div>
          <div id="msgTemplates" class="alert" style="display: none"></div>
          <div id="savedTemplatesGrid" class="template-grid" aria-live="polite">
            <div class="muted">Loading templates...</div>
          </div>
        </section>

        <!-- Left: Meta / Badges -->
        <section class="card panel">
          <h2>Profile & Appearance</h2>
          <div id="msgMeta" class="alert" style="display: none"></div>

          <form id="formMeta" class="grid cols-2" autocomplete="off">
            <div class="field">
              <label for="inDevice">Editing for</label>
              <select id="inDevice" class="select">
                <option value="pc">Desktop</option>
                <option value="mobile">Mobile</option>
              </select>
              <div class="preview-note muted">
                Default is Desktop. Switching to Mobile can create a separate
                copy.
              </div>
            </div>
            <div class="field">
              <label for="inSlug">Slug (URL)</label>
              <input
                id="inSlug"
                class="input"
                placeholder="your-handle"
                required
              />
              <div class="preview-note muted">
                Preview:
                <code class="kbd">/tree/<span id="slugPreview">-</span></code>
              </div>
            </div>
            <div class="field">
              <label for="inEntryText">Entry overlay text</label>
              <input
                id="inEntryText"
                class="input"
                placeholder="Click to enter"
                maxlength="120"
              />
              <div class="help">
                Shown on the entry gate before media plays.
              </div>
              <details class="fold">
                <summary>Entry styling</summary>
                <div class="fold-body">
                  <div class="field">
                    <label for="inEntryTextColor">Entry text color</label>
                    <input
                      id="inEntryTextColor"
                      class="input"
                      type="color"
                      value="#e9ebff"
                    />
                  </div>
                  <div class="field">
                    <label for="inEntryFont">Entry font style</label>
                    <select id="inEntryFont" class="select">
                      <option value="default">Default</option>
                      <option value="serif">Serif</option>
                      <option value="mono">Mono</option>
                      <option value="script">Script</option>
                      <option value="display">Display</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="inEntryEffect">Entry effect</label>
                    <select id="inEntryEffect" class="select">
                      <option value="none">None</option>
                      <option value="glow">Glow</option>
                      <option value="neon">Neon</option>
                      <option value="rainbow">Rainbow</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="inEntryFontSize">Entry font size (px)</label>
                    <input
                      id="inEntryFontSize"
                      class="input"
                      type="number"
                      min="10"
                      max="40"
                      value="16"
                    />
                  </div>
                  <div class="field">
                    <label for="inEntryBgAlpha">Entry box alpha (0-100)</label>
                    <input
                      id="inEntryBgAlpha"
                      class="input"
                      type="number"
                      min="0"
                      max="100"
                      value="85"
                    />
                  </div>
                  <div class="field">
                    <label for="inEntryOverlayAlpha"
                      >Entry overlay alpha (0-100)</label
                    >
                    <input
                      id="inEntryOverlayAlpha"
                      class="input"
                      type="number"
                      min="0"
                      max="100"
                      value="35"
                    />
                  </div>
                  <div class="field">
                    <label class="row" style="gap: 0.5rem">
                      <input type="checkbox" id="inEntryBoxEnabled" checked />
                      <span>Show entry box</span>
                    </label>
                  </div>
                  <div class="field">
                    <label class="row" style="gap: 0.5rem">
                      <input type="checkbox" id="inEntryBorderEnabled" checked />
                      <span>Show entry border</span>
                    </label>
                  </div>
                  <div class="field">
                    <label for="inEntryBorderColor">Entry border color</label>
                    <input
                      id="inEntryBorderColor"
                      class="input"
                      type="text"
                      maxlength="7"
                      placeholder="#RRGGBB"
                    />
                  </div>
                </div>
              </details>
            </div>
            <div class="field">
              <label for="inLocation">Location</label>
              <input id="inLocation" class="input" placeholder="Switzerland" />
              <details class="fold">
                <summary>Location styling</summary>
                <div class="fold-body">
                  <div class="field">
                    <label for="inLocationColor">Location Color</label>
                    <input
                      id="inLocationColor"
                      class="input"
                      type="color"
                      value="#a2a9c8"
                    />
                  </div>
                </div>
              </details>
            </div>

            <div class="field" style="grid-column: 1 / -1">
              <label for="filePfp">Upload Profile Picture (Linktree)</label>
              <input type="file" id="filePfp" accept="image/*" />
              <input type="hidden" id="inLinktreePfp" />
              <div class="preview-note muted">
                If empty, your account profile picture is used.
              </div>
              <div id="pfpStatus" class="preview-note muted">
                Using your account profile picture.
              </div>
              <div class="row" style="margin-top: 0.4rem">
                <button class="btn sm ghost" type="button" id="btnRemovePfp">
                  Remove Picture
                </button>
              </div>
            </div>

            <div class="field" style="grid-column: 1 / -1">
              <label for="inQuote">Quote</label>
              <textarea
                id="inQuote"
                class="input"
                placeholder="Write your bio/quote…"
              ></textarea>
              <label
                class="row"
                style="gap: 0.4rem; align-items: center; margin-top: 0.35rem"
              >
                <input type="checkbox" id="inQuoteTyping" />
                <span>Typewriter quote (cycle up to 3 texts)</span>
              </label>
              <div
                class="grid cols-2"
                id="quoteTypingFields"
                style="margin-top: 0.5rem"
              >
                <div class="field">
                  <label for="inQuoteAlt1">Quote text 2</label>
                  <input
                    id="inQuoteAlt1"
                    class="input"
                    placeholder="Second quote text"
                  />
                </div>
                <div class="field">
                  <label for="inQuoteAlt2">Quote text 3</label>
                  <input
                    id="inQuoteAlt2"
                    class="input"
                    placeholder="Third quote text"
                  />
                </div>
              </div>
              <div
                class="field"
                id="quoteTypingSpeedWrap"
                style="margin-top: 0.5rem"
              >
                <label for="inQuoteSpeed"
                  >Typewriter speed (ms per char)</label
                >
                <input
                  id="inQuoteSpeed"
                  class="input"
                  type="number"
                  min="20"
                  max="200"
                  value="42"
                />
              </div>
              <div class="field">
                <label for="inQuotePause"
                  >Pause before next quote (ms)</label
                >
                <input
                  id="inQuotePause"
                  class="input"
                  type="number"
                  min="200"
                  max="10000"
                  value="1200"
                />
              </div>
              <details class="fold">
                <summary>Quote styling</summary>
                <div class="fold-body">
                  <div class="field">
                    <label for="inQuoteColor">Quote Color</label>
                    <input
                      id="inQuoteColor"
                      class="input"
                      type="color"
                      value="#e9ebff"
                    />
                  </div>
                  <div class="field">
                    <label for="inQuoteFont">Quote font style</label>
                    <select id="inQuoteFont" class="select">
                      <option value="default">Default</option>
                      <option value="serif">Serif</option>
                      <option value="mono">Mono</option>
                      <option value="script">Script</option>
                      <option value="display">Display</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="inQuoteEffect">Quote effect</label>
                    <select id="inQuoteEffect" class="select">
                      <option value="none">None</option>
                      <option value="glow">Glow</option>
                      <option value="neon">Neon</option>
                      <option value="rainbow">Rainbow</option>
                    </select>
                  </div>
                  <div class="field">
                    <label for="inQuoteSize">Quote font size (px)</label>
                    <input
                      id="inQuoteSize"
                      class="input"
                      type="number"
                      min="10"
                      max="40"
                      value="15"
                    />
                  </div>
                </div>
              </details>
            </div>
            <div class="field">
              <label for="fileSong">Upload Song</label>
              <input type="file" id="fileSong" accept="audio/*" />
              <input type="hidden" id="inSong" />
              <input type="hidden" id="inSongName" />
              <div id="songStatus" class="preview-note muted">
                No song uploaded yet.
              </div>
              <div class="row" style="margin-top: 0.4rem">
                <button class="btn sm ghost" type="button" id="btnRemoveSong">
                  Remove Song
                </button>
              </div>
            </div>
            <div class="field">
              <label for="fileSongIcon">Upload Song Icon</label>
              <input type="file" id="fileSongIcon" accept="image/*" />
              <input type="hidden" id="inSongIcon" />
              <div id="songIconStatus" class="preview-note muted">
                No icon uploaded.
              </div>
              <div class="row" style="margin-top: 0.4rem">
                <button class="btn sm ghost" type="button" id="btnRemoveSongIcon">
                  Remove Icon
                </button>
              </div>
            </div>
            <div class="field">
              <label class="row" style="gap: 0.4rem; align-items: center">
                <input type="checkbox" id="inAudioPlayer" />
                <span>Show audio player controls</span>
              </label>
              <div class="help">
                Shows the player when a song is uploaded.
              </div>
            </div>
            <details class="fold" style="grid-column: 1 / -1">
              <summary>Audio player styling</summary>
              <div class="fold-body grid cols-2">
                <div class="field">
                  <label for="inAudioBgColor">Audio player background</label>
                  <input
                    id="inAudioBgColor"
                    class="input"
                    type="color"
                    value="#171b3b"
                  />
                </div>
                <div class="field">
                  <label for="inAudioBgAlpha"
                    >Audio player transparency (0-100)</label
                  >
                  <input
                    id="inAudioBgAlpha"
                    class="input"
                    type="number"
                    min="0"
                    max="100"
                    value="60"
                  />
                </div>
                <div class="field">
                  <label for="inAudioTextColor">Audio player text color</label>
                  <input
                    id="inAudioTextColor"
                    class="input"
                    type="color"
                    value="#e9ebff"
                  />
                </div>
                <div class="field">
                  <label for="inAudioAccentColor">Audio player accent color</label>
                  <input
                    id="inAudioAccentColor"
                    class="input"
                    type="color"
                    value="#85a3ff"
                  />
                </div>
              </div>
            </details>
            <div class="field">
              <label for="fileBg">Upload Background</label>
              <input type="file" id="fileBg" accept="image/*,video/*" />
              <input type="hidden" id="inBg" />
              <div id="bgStatus" class="preview-note muted">
                No background uploaded yet.
              </div>
              <div class="row" style="margin-top: 0.4rem">
                <button class="btn sm ghost" type="button" id="btnRemoveBg">
                  Remove Background
                </button>
              </div>
            </div>
            <div class="field">
              <label for="fileCursor">Upload Cursor (Desktop)</label>
              <input type="file" id="fileCursor" accept="image/*" />
              <input type="hidden" id="inCursor" />
              <div class="preview-note muted">
                Use a small PNG/WEBP for best results.
              </div>
              <div id="cursorStatus" class="preview-note muted">
                No cursor uploaded.
              </div>
              <div class="row" style="margin-top: 0.4rem">
                <button class="btn sm ghost" type="button" id="btnRemoveCursor">
                  Remove Cursor
                </button>
              </div>
            </div>
            <details class="fold" style="grid-column: 1 / -1">
              <summary>Cursor effects</summary>
              <div class="fold-body grid cols-2">
                <div class="field">
                  <label for="inCursorFx">Cursor effect (Desktop)</label>
                  <select id="inCursorFx" class="select">
                    <option value="none">none</option>
                    <option value="glow">glow</option>
                    <option value="particles">particles</option>
                  </select>
                  <div class="preview-note muted">
                    Runs only on desktop screens.
                  </div>
                </div>
                <div class="field">
                  <label for="inCursorFxColor">Cursor effect color</label>
                  <input
                    id="inCursorFxColor"
                    class="input"
                    type="color"
                    value="#85a3ff"
                  />
                </div>
                <div class="field" style="grid-column: 1 / -1">
                  <label for="inCursorFxAlpha"
                    >Cursor effect intensity (0-100)</label
                  >
                  <input
                    id="inCursorFxAlpha"
                    class="input"
                    type="number"
                    min="0"
                    max="100"
                    value="70"
                  />
                  <div class="preview-note muted">
                    Applies to glow and particles.
                  </div>
                </div>
              </div>
            </details>
            <details class="fold" style="grid-column: 1 / -1">
              <summary>Card styling</summary>
              <div class="fold-body grid cols-2">
                <div class="field">
                  <label for="inTrans">Card Transparency (0-100)</label>
                  <input
                    id="inTrans"
                    class="input"
                    type="number"
                    min="0"
                    max="100"
                    value="100"
                  />
                  <div class="preview-note muted">
                    0 = transparent, 100 = opaque (matches link background slider).
                  </div>
                </div>
                <div class="field">
                  <label for="inCardColor">Card/Base Color</label>
                  <input
                    id="inCardColor"
                    class="input"
                    type="color"
                    value="#171b3b"
                  />
                </div>
              </div>
            </details>
            <div class="field">
              <label for="inDisplayName">Display Name</label>
              <select id="inDisplayName" class="select">
                <option value="slug">Slug</option>
                <option value="username">Username</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="field">
              <label for="inCustomName">Custom Name</label>
              <input
                id="inCustomName"
                class="input"
                placeholder="Your name/nickname"
                maxlength="64"
              />
              <div class="preview-note muted">
                Used when Display Name is set to Custom.
              </div>
            </div>
            <details class="fold" style="grid-column: 1 / -1">
              <summary>Name styling</summary>
              <div class="fold-body grid cols-2">
                <div class="field">
                  <label for="inNameFx">Name Effect</label>
                  <select id="inNameFx" class="select">
                    <option value="none">none</option>
                    <option value="glow">glow</option>
                    <option value="neon">neon</option>
                    <option value="rainbow">rainbow</option>
                  </select>
                </div>
                <div class="field">
                  <label for="inNameColor">Name Color</label>
                  <input
                    id="inNameColor"
                    class="input"
                    type="color"
                    value="#e9ebff"
                  />
                </div>
              </div>
            </details>
            <details class="fold" style="grid-column: 1 / -1">
              <summary>Text styling</summary>
              <div class="fold-body">
                <div class="field">
                  <label for="inTextColor">Text Color</label>
                  <input
                    id="inTextColor"
                    class="input"
                    type="color"
                    value="#e9ebff"
                  />
                </div>
              </div>
            </details>
            <details class="fold" style="grid-column: 1 / -1">
              <summary>Link styling</summary>
              <div class="fold-body grid cols-2">
                <div class="field">
                  <label for="inLinkColor">Link Text Color</label>
                  <input
                    id="inLinkColor"
                    class="input"
                    type="color"
                    value="#e9ebff"
                  />
                </div>
                <div class="field">
                  <label for="inLinkBgColor">Link Background Color</label>
                  <input
                    id="inLinkBgColor"
                    class="input"
                    type="color"
                    value="#171b3b"
                  />
                </div>
                <div class="field" style="grid-column: 1 / -1">
                  <label for="inLinkBgAlpha"
                    >Link Background Transparency (0-100)</label
                  >
                  <input
                    id="inLinkBgAlpha"
                    class="input"
                    type="number"
                    min="0"
                    max="100"
                    value="100"
                  />
                </div>
              </div>
            </details>
            <details class="fold" style="grid-column: 1 / -1">
              <summary>Background effects</summary>
              <div class="fold-body">
                <div class="field">
                  <label for="inBgFx">Background Effect</label>
                  <select id="inBgFx" class="select">
                    <option value="none">none</option>
                    <option value="night">night</option>
                    <option value="rain">rain</option>
                    <option value="snow">snow</option>
                  </select>
                </div>
              </div>
            </details>

            <div class="field" style="grid-column: 1 / -1">
              <label>Discord (optional)</label>
              <div class="discord-box">
                <div>
                  <div id="discordStatusText" class="muted">Not linked</div>
                  <div id="discordPreview" class="discord-preview muted">
                    Link Discord to use your profile frame.
                  </div>
                </div>
                <div class="row" style="gap: 0.5rem; flex-wrap: wrap">
                  <button type="button" class="btn sm" id="btnDiscordLink">
                    Link Discord
                  </button>
                  <button
                    type="button"
                    class="btn sm ghost"
                    id="btnDiscordUnlink"
                    style="display: none"
                  >
                    Unlink
                  </button>
                </div>
              </div>
              <label
                class="row"
                style="margin-top: 0.5rem; gap: 0.4rem; align-items: center"
              >
                <input type="checkbox" id="inDiscordFrame" />
                <span>Show my Discord profile frame around my avatar</span>
              </label>
              <div class="help">
                Optional. Uses your current Discord profile frame if available.
              </div>

              <label
                class="row"
                style="margin-top: 0.75rem; gap: 0.4rem; align-items: center"
              >
                <input type="checkbox" id="inDiscordPresence" />
                <span>Show my Discord activity status on my avatar</span>
              </label>
              <div class="help" style="margin-top: 0.35rem">
                Status is read automatically from Discord (last known).
              </div>
              <label
                class="row"
                style="margin-top: 0.5rem; gap: 0.4rem; align-items: center"
              >
                <input type="checkbox" id="inDiscordStatus" />
                <span>Show my Discord status line on the linktree</span>
              </label>
              <div class="help" style="margin-top: 0.35rem">
                Custom status text is pulled from Discord automatically.
              </div>
              <label
                class="row"
                style="margin-top: 0.5rem; gap: 0.4rem; align-items: center"
              >
                <input type="checkbox" id="inDiscordBadges" />
                <span>Show my Discord badges</span>
              </label>

              <label
                class="row"
                style="margin-top: 0.75rem; gap: 0.4rem; align-items: center"
              >
                <input type="checkbox" id="inShowCounter" />
                <span>Show visitor counter on my profile</span>
              </label>
              <div class="help">
                Counts unique visitors (shared desktop/mobile). Current:
                <strong id="inVisitCount">0</strong>
              </div>
              <details class="fold" style="margin-top: 0.75rem">
                <summary>Counter styling</summary>
                <div class="fold-body grid cols-2">
                  <div class="field">
                    <label for="inCounterColor">Counter Text/Icon Color</label>
                    <input
                      id="inCounterColor"
                      class="input"
                      type="color"
                      value="#e9ebff"
                    />
                  </div>
                  <div class="field">
                    <label for="inCounterBgColor">Counter Background Color</label>
                    <input
                      id="inCounterBgColor"
                      class="input"
                      type="color"
                      value="#ffffff"
                    />
                  </div>
                  <div class="field" style="grid-column: 1 / -1">
                    <label for="inCounterBgAlpha"
                      >Counter Background Transparency (0-100)</label
                    >
                    <input
                      id="inCounterBgAlpha"
                      class="input"
                      type="number"
                      min="0"
                      max="100"
                      value="20"
                    />
                  </div>
                </div>
              </details>
            </div>

            <div class="row" style="grid-column: 1 / -1; margin-top: 0.4rem">
              <button type="submit" class="btn sm" id="btnSaveMeta">
                Save
              </button>
              <a
                class="btn sm ghost"
                id="btnOpenPublic"
                href="#"
                target="_blank"
                rel="noreferrer"
                >Open /tree/…</a
              >
            </div>
          </form>

          <div class="hr"></div>

          <h3>Badges (earned icons)</h3>
          <div id="badges" class="grid"></div>

          <div class="hr"></div>

          <h3>Discord badges</h3>
          <div id="discordBadgesList" class="grid"></div>
          <div
            id="discordBadgesHint"
            class="muted"
            style="margin-top: 0.35rem"
          ></div>
        </section>

        <!-- Right: Links -->
        <section class="card panel">
          <h2>Links</h2>
          <div id="msgLinks" class="alert" style="display: none"></div>

          <form id="formAddLink" class="grid cols-2" autocomplete="off">
            <div class="field">
              <label for="inLinkUrl">URL</label>
              <input id="inLinkUrl" class="input" placeholder="https://…" />
            </div>
            <div class="field">
              <label for="inLinkLabel">Label</label>
              <input id="inLinkLabel" class="input" placeholder="My Link" />
            </div>
            <div class="field">
              <label for="fileIcon">Upload Link Icon</label>
              <input type="file" id="fileIcon" accept="image/*" />
              <input type="hidden" id="inLinkIcon" />
              <div id="linkIconStatus" class="preview-note muted">
                No icon uploaded.
              </div>
              <div class="row" style="margin-top: 0.4rem">
                <button class="btn sm ghost" type="button" id="btnRemoveLinkIcon">
                  Remove Icon
                </button>
              </div>
            </div>
            <div class="field">
              <label for="inLinkActive">Active</label>
              <select id="inLinkActive" class="select">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>
            <div class="row" style="grid-column: 1 / -1">
              <button class="btn sm" type="submit">Add Link</button>
            </div>
          </form>

          <div class="hr"></div>

          <div class="links-list" id="linksList" aria-live="polite"></div>
        </section>
      </div>
    </main>

    <footer>
      <div class="container foot">
        <small class="muted"
          >© <span id="year"></span> TAOMA™. All rights reserved. ·
          <a href="/datenschutz.html">Privacy Policy</a> · <a href="/impressum.html">Imprint</a></small
        >
        <div class="visitor-counter">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            />
          </svg>
          <span id="visitor-count">0</span>
        </div>
        <div class="social">
          <a
            href="https://guns.lol/taoma"
            target="_blank"
            rel="noreferrer"
            aria-label="guns.lol"
            class="iso-pro is-fb"
          >
            <span></span><span></span><span></span>
            <svg
              width="18"
              height="18"
              viewBox="0 0 512 512"
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              class="svg"
            >
              <path
                d="M256 32C132 32 32 132 32 256s100 224 224 224 224-100 224-224S380 32 256 32Zm80 160h32v32h-32v32h-32v-32h-32v-32h32v-32h32v32Z"
              />
            </svg>
            <div class="text">guns.lol</div>
          </a>

          <a
            href="https://github.com/TaomasSpace"
            target="_blank"
            rel="noreferrer"
            aria-label="GitHub"
            class="iso-pro is-gh"
          >
            <span></span><span></span><span></span>
            <svg
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="svg"
            >
              <path
                d="M12 2C6.477 2 2 6.477 2 12a10 10 0 0 0 6.838 9.488c.5.092.682-.216.682-.48 0-.237-.01-1.026-.015-1.862-2.782.604-3.369-1.18-3.369-1.18-.455-1.156-1.11-1.464-1.11-1.464-.907-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.088 2.91.833.092-.647.35-1.088.636-1.339-2.22-.252-4.555-1.11-4.555-4.943 0-1.091.39-1.987 1.03-2.688-.103-.252-.447-1.268.098-2.643 0 0 .84-.269 2.75 1.026A9.58 9.58 0 0 1 12 6.844c.85.004 1.707.115 2.506.337 1.909-1.295 2.748-1.026 2.748-1.026.547 1.375.203 2.39.1 2.643.64.701 1.028 1.597 1.028 2.688 0 3.842-2.338 4.688-4.566 4.936.358.31.677.92.677 1.855 0 1.338-.012 2.419-.012 2.748 0 .267.18.577.688.478A10.003 10.003 0 0 0 22 12c0-5.523-4.477-10-10-10Z"
              />
            </svg>
            <div class="text">GitHub</div>
          </a>

          <a
            href="mailto:Taoma.M@proton.me"
            aria-label="Email"
            class="iso-pro is-mail"
          >
            <span></span><span></span><span></span>
            <svg
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="svg"
              aria-hidden="true"
            >
              <rect
                x="3"
                y="5"
                width="18"
                height="14"
                rx="2"
                stroke="currentColor"
                stroke-width="2"
                stroke-linejoin="round"
              />
              <path
                d="M3 7l9 6 9-6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
            <div class="text">Email</div>
          </a>
          <a
            href="https://discord.gg/H3NDg7e3vD"
            target="_blank"
            rel="noreferrer"
            aria-label="Discord"
            class="iso-pro is-discord"
          >
            <span></span><span></span><span></span>
            <svg
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              class="svg"
            >
              <path
                d="M20 4a18 18 0 0 0-4.5-1.5l-.2.4A16.4 16.4 0 0 1 12 3c-1.1 0-2.2.1-3.3.3l-.2-.4A18 18 0 0 0 4 4c-1.3 2-2 4.2-2 6.5 0 6.7 4.5 8.6 8.8 8.6h.7l-.3-1a9 9 0 0 1-1.7-.6l.4-.2c.8.4 1.7.6 2.6.6s1.8-.2 2.6-.6l.4.2a9 9 0 0 1-1.7.6l-.3 1h.7C17.5 19.1 22 17.2 22 10.5 22 8.2 21.3 6 20 4ZM9.5 14.2c-.8 0-1.5-.8-1.5-1.8s.7-1.8 1.5-1.8S11 11.4 11 12.4s-.7 1.8-1.5 1.8Zm5 0c-.8 0-1.5-.8-1.5-1.8s.7-1.8 1.5-1.8 1.5.8 1.5 1.8-.7 1.8-1.5 1.8Z"
              />
            </svg>
            <div class="text">Discord</div>
          </a>
        </div>
      </div>
    </footer>

    <script>
      // --- Mobile menu
      const toggle = document.getElementById("mobileToggle");
      const menu = document.getElementById("primary-menu");
      if (toggle) {
        toggle.addEventListener("click", () => {
          const open = menu.classList.toggle("open");
          toggle.setAttribute("aria-expanded", String(open));
        });
      }
      document.getElementById("year").textContent = new Date().getFullYear();

      async function safe(fn) {
        try {
          return await fn();
        } catch (e) {
          console.error(e);
          return null;
        }
      }
      (async () => {
        const countEl = document.getElementById("visitor-count");
        try {
          const KEY = "taoma_last_counted_at",
            DAY = 86400000,
            now = Date.now();
          const last = Number(localStorage.getItem(KEY) || 0);
          if (!last || now - last > DAY) {
            navigator.sendBeacon &&
              navigator.sendBeacon("/api/visits/increment");
            localStorage.setItem(KEY, String(now));
          }
          const r = await fetch("/api/visits/value");
          if (r.ok) {
            const { total } = await r.json();
            if (countEl)
              countEl.textContent = String(
                total !== undefined && total !== null ? total : 0
              );
          } else if (countEl) countEl.textContent = "—";
        } catch {
          if (countEl) countEl.textContent = "—";
        }
      })();

      function escapeHtml(value) {
        return String(
          value !== undefined && value !== null ? value : ""
        ).replace(
          /[&<>"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch] || ch)
        );
      }

      function sanitizeUrl(raw) {
        if (typeof raw !== "string") return "";
        const trimmed = raw.trim();
        if (!trimmed) return "";
        if (trimmed.startsWith("javascript:")) return "";
        try {
          const u = new URL(trimmed, window.location.origin);
          if (["http:", "https:"].includes(u.protocol)) {
            return trimmed.startsWith("http://") ||
              trimmed.startsWith("https://")
              ? u.href
              : trimmed;
          }
        } catch (_) {
          if (trimmed.startsWith("/") && !trimmed.startsWith("//"))
            return trimmed;
        }
        return "";
      }

      async function fetchSession() {
        try {
          const r = await safe(() =>
            fetch("/api/auth/verify", { credentials: "include" })
          );
          if (!r || !r.ok) return null;
          return await r.json();
        } catch (_) {
          return null;
        }
      }

      async function renderAuthHeader() {
        const slot = document.getElementById("authSlot");
        if (!slot) return null;

        const session = await fetchSession();
        const user = session && session.user ? session.user : null;
        const isAdmin = !!(user && user.admin);
        currentUser = user;

        if (!user) {
          slot.innerHTML = `<a class="btn small" href="/login?next=${encodeURIComponent(
            location.href
          )}">Login</a>
                                  <a class="btn small" href="/register?next=${encodeURIComponent(
                                    location.href
                                  )}">Register</a>`;
          return null;
        }
        const uname = user.username || "User";
        const initials = uname.trim().slice(0, 2).toUpperCase();
        const pfp = sanitizeUrl(
          user.profile_picture ? String(user.profile_picture) : ""
        );
        slot.innerHTML = `
      <div class="auth-box" style="position:relative">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false">
          ${
            pfp
              ? `<img class="avatar" src="${pfp}" alt="${escapeHtml(
                  uname
                )}'s profile picture">`
              : `<span class="avatar-fallback" aria-hidden="true">${escapeHtml(
                  initials
                )}</span>`
          }
          <span class="uname" style="font-weight:700;font-size:.95rem">${escapeHtml(
            uname
          )}</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div class="menu" id="userMenu" role="menu">
          <a href="/profile" role="menuitem">Profile</a>
          ${isAdmin ? `<a href="/admin" role="menuitem">Admin</a>` : ``}
          <button id="logoutBtnHdr" role="menuitem">Logout</button>
        </div>
      </div>`;

        const btn = slot.querySelector("#avatarBtn");
        const m = slot.querySelector("#userMenu");
        const lo = slot.querySelector("#logoutBtnHdr");

        function close() {
          m.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
        }

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = m.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
        document.addEventListener("click", (e) => {
          if (!m.contains(e.target) && !btn.contains(e.target)) close();
        });
        lo.addEventListener(
          "click",
          async () => {
            try {
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "include",
              });
            } catch {}
            location.href = "/";
          },
          { passive: true }
        );
        return user;
      }

      // --- State ---
      let currentUser = null;
      let currentTree = null;
      let linktreeId = null;
      let currentDevice = "pc";
      let discordStatus = { linked: false };
      let discordBadgeCodes = null;
      let savedTemplates = [];
      const HIDE_LINKS =
        new URLSearchParams(location.search).get("hideLinks") === "true";

      const $ = (id) => document.getElementById(id);
      const msgMeta = $("msgMeta"),
        msgLinks = $("msgLinks"),
        msgTemplates = $("msgTemplates");

      function showMsg(el, text, ok = false) {
        if (!el) return;
        el.textContent = text;
        el.className = "alert " + (ok ? "ok" : "err");
        el.style.display = "block";
        setTimeout(() => (el.style.display = "none"), 3500);
      }

      function slugFromQuery() {
        const u = new URL(location.href);
        return u.searchParams.get("slug");
      }

      function templateIdFromQuery() {
        const u = new URL(location.href);
        return u.searchParams.get("template_id");
      }

      function deviceFromQuery() {
        const u = new URL(location.href);
        const val = u.searchParams.get("device");
        if (val === "both") return "both";
        return val === "mobile" ? "mobile" : val === "pc" ? "pc" : null;
      }

      const DEFAULT_LINK_COLOR = "#e9ebff";
      const DEFAULT_LINK_BG_COLOR = "#171b3b";
      const DEFAULT_CARD_COLOR = "#171b3b";
      const DEFAULT_AUDIO_BG_COLOR = "#171b3b";
      const DEFAULT_AUDIO_BG_ALPHA = 60;
      const DEFAULT_AUDIO_TEXT_COLOR = "#e9ebff";
      const DEFAULT_AUDIO_ACCENT_COLOR = "#85a3ff";
      const DEFAULT_TEXT_COLOR = "#e9ebff";
      const DEFAULT_NAME_COLOR = "#e9ebff";
      const DEFAULT_LOCATION_COLOR = "#a2a9c8";
      const DEFAULT_QUOTE_COLOR = "#e9ebff";
      const DEFAULT_ENTRY_TEXT_COLOR = "#e9ebff";
      const DEFAULT_ENTRY_FONT_SIZE = 16;
      const DEFAULT_ENTRY_BG_ALPHA = 85;
      const DEFAULT_ENTRY_OVERLAY_ALPHA = 35;
      const DEFAULT_QUOTE_SPEED = 42;
      const DEFAULT_QUOTE_PAUSE = 1200;
      const DEFAULT_QUOTE_SIZE = 15;
      const DEFAULT_CURSOR_FX_COLOR = DEFAULT_AUDIO_ACCENT_COLOR;
      const DEFAULT_CURSOR_FX_ALPHA = 70;
      const PRIVATE_TEMPLATE_DESC =
        "Private snapshot created from Linktree Config.";
      const PRIVATE_TEMPLATE_MARKER = PRIVATE_TEMPLATE_DESC.toLowerCase();

      function hexOrNull(val) {
        const t = (val || "").trim();
        if (!t) return null;
        if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(t)) return t;
        return null;
      }

      function clampPercent(val, fallback = 0) {
        const n = parseInt(val ?? fallback, 10);
        if (Number.isNaN(n)) return Math.min(100, Math.max(0, fallback));
        return Math.min(100, Math.max(0, n));
      }


      function fileNameFromUrl(url) {
        if (!url) return "";
        try {
          const u = new URL(String(url), window.location.origin);
          const name = (u.pathname || "").split("/").pop();
          return name ? decodeURIComponent(name) : "";
        } catch (_) {
          return String(url);
        }
      }

      function setUploadStatus(id, url, emptyText, displayName) {
        const el = $(id);
        if (!el) return;
        const preferred = String(displayName || "").trim();
        const name = preferred || fileNameFromUrl(url || "");
        el.textContent = name || emptyText;
      }


      const VIDEO_EXTENSIONS = [".mp4", ".webm", ".m4v", ".mov"];

      function looksLikeVideoUrl(url) {
        if (!url) return false;
        const lower = String(url).toLowerCase();
        return VIDEO_EXTENSIONS.some((ext) => lower.includes(ext));
      }

      function templateDeviceLabel(device) {
        if (device === "both") return "Desktop + Mobile";
        if (device === "mobile") return "Mobile";
        return "Desktop";
      }

      function fillMetaForm(lt) {
        $("inSlug").value = lt.slug || "";
        $("slugPreview").textContent = lt.slug || "-";
        $("inDevice").value = lt.device_type || "pc";
        currentDevice = lt.device_type || "pc";
        $("inLocation").value = lt.location || "";
        const qt = Array.isArray(lt.quote_typing_texts)
          ? lt.quote_typing_texts
          : [];
        const q1 = qt[0] || lt.quote || "";
        $("inQuote").value = q1 || "";
        $("inQuoteAlt1").value = qt[1] || "";
        $("inQuoteAlt2").value = qt[2] || "";
        $("inQuoteTyping").checked = !!lt.quote_typing_enabled;
        $("inQuoteSpeed").value =
          lt.quote_typing_speed !== undefined && lt.quote_typing_speed !== null
            ? lt.quote_typing_speed
            : DEFAULT_QUOTE_SPEED;
        $("inQuotePause").value =
          lt.quote_typing_pause !== undefined && lt.quote_typing_pause !== null
            ? lt.quote_typing_pause
            : DEFAULT_QUOTE_PAUSE;
        $("inQuoteSize").value =
          lt.quote_font_size !== undefined && lt.quote_font_size !== null
            ? lt.quote_font_size
            : DEFAULT_QUOTE_SIZE;
        $("inEntryText").value = lt.entry_text || "";
        $("inEntryTextColor").value =
          lt.entry_text_color || DEFAULT_ENTRY_TEXT_COLOR;
        $("inEntryFont").value = lt.entry_font_family || "default";
        $("inEntryEffect").value = lt.entry_effect || "none";
        $("inEntryFontSize").value =
          lt.entry_font_size !== undefined && lt.entry_font_size !== null
            ? lt.entry_font_size
            : DEFAULT_ENTRY_FONT_SIZE;
        $("inEntryBgAlpha").value =
          lt.entry_bg_alpha !== undefined && lt.entry_bg_alpha !== null
            ? lt.entry_bg_alpha
            : DEFAULT_ENTRY_BG_ALPHA;
      $("inEntryOverlayAlpha").value =
        lt.entry_overlay_alpha !== undefined &&
        lt.entry_overlay_alpha !== null
          ? lt.entry_overlay_alpha
          : DEFAULT_ENTRY_OVERLAY_ALPHA;
      $("inEntryBoxEnabled").checked =
        lt.entry_box_enabled !== undefined && lt.entry_box_enabled !== null
          ? !!lt.entry_box_enabled
          : true;
      $("inEntryBorderEnabled").checked =
        lt.entry_border_enabled !== undefined && lt.entry_border_enabled !== null
          ? !!lt.entry_border_enabled
          : true;
      $("inEntryBorderColor").value = lt.entry_border_color || "";
        $("inSong").value = lt.song_url || "";
        $("inSongName").value = lt.song_name || "";
        $("inSongIcon").value = lt.song_icon_url || "";
        $("inAudioPlayer").checked = !!lt.show_audio_player;
        $("inAudioBgColor").value =
          lt.audio_player_bg_color || DEFAULT_AUDIO_BG_COLOR;
        $("inAudioBgAlpha").value =
          lt.audio_player_bg_alpha !== undefined && lt.audio_player_bg_alpha !== null
            ? lt.audio_player_bg_alpha
            : DEFAULT_AUDIO_BG_ALPHA;
        $("inAudioTextColor").value =
          lt.audio_player_text_color || DEFAULT_AUDIO_TEXT_COLOR;
        $("inAudioAccentColor").value =
          lt.audio_player_accent_color || DEFAULT_AUDIO_ACCENT_COLOR;
        $("inBg").value = lt.background_url || "";
        $("inDisplayName").value = lt.display_name_mode || "slug";
        $("inCustomName").value = lt.custom_display_name || "";
        const cardTrans =
          lt.transparency !== undefined && lt.transparency !== null
            ? lt.transparency
            : 0;
        $("inTrans").value = 100 - Math.min(100, Math.max(0, cardTrans));
        $("inNameFx").value = lt.name_effect || "none";
        $("inBgFx").value = lt.background_effect || "none";
        $("inTextColor").value = lt.text_color || DEFAULT_TEXT_COLOR;
        $("inNameColor").value =
          lt.name_color || lt.link_color || DEFAULT_NAME_COLOR;
        $("inLocationColor").value =
          lt.location_color || lt.text_color || DEFAULT_LOCATION_COLOR;
        $("inQuoteColor").value =
          lt.quote_color || lt.text_color || DEFAULT_QUOTE_COLOR;
        $("inQuoteFont").value = lt.quote_font_family || "default";
        $("inQuoteEffect").value = lt.quote_effect || "none";
        $("inLinkColor").value = lt.link_color || DEFAULT_LINK_COLOR;
        $("inLinkBgColor").value = lt.link_bg_color || DEFAULT_LINK_BG_COLOR;
        $("inCardColor").value = lt.card_color || DEFAULT_CARD_COLOR;
        $("inLinkBgAlpha").value =
          lt.link_bg_alpha !== undefined && lt.link_bg_alpha !== null
            ? lt.link_bg_alpha
            : 100;
        $("inCursor").value = lt.cursor_url || "";
        $("inCursorFx").value = lt.cursor_effect || "none";
        $("inCursorFxColor").value =
          lt.cursor_effect_color || DEFAULT_CURSOR_FX_COLOR;
        $("inCursorFxAlpha").value =
          lt.cursor_effect_alpha !== undefined && lt.cursor_effect_alpha !== null
            ? lt.cursor_effect_alpha
            : DEFAULT_CURSOR_FX_ALPHA;
        $("inLinktreePfp").value = lt.linktree_profile_picture || "";
        setUploadStatus(
          "songStatus",
          lt.song_url,
          "No song uploaded yet.",
          lt.song_name
        );
        setUploadStatus("songIconStatus", lt.song_icon_url, "No icon uploaded.");
        setUploadStatus(
          "pfpStatus",
          lt.linktree_profile_picture,
          "Using your account profile picture."
        );
        setUploadStatus(
          "bgStatus",
          lt.background_url,
          "No background uploaded yet."
        );
        setUploadStatus("cursorStatus", lt.cursor_url, "No cursor uploaded.");
        $("inDiscordFrame").checked = !!lt.discord_frame_enabled;
        $("inDiscordPresence").checked = !!lt.discord_presence_enabled;
        $("inDiscordStatus").checked = !!lt.discord_status_enabled;
        $("inDiscordBadges").checked = !!lt.discord_badges_enabled;
        $("inShowCounter").checked = !!lt.show_visit_counter;
        const vcEl = document.getElementById("inVisitCount");
        if (vcEl)
          vcEl.textContent = Number(lt.visit_count || 0).toLocaleString();
        $("inCounterColor").value = lt.visit_counter_color || "#e9ebff";
        $("inCounterBgColor").value = lt.visit_counter_bg_color || "#ffffff";
        $("inCounterBgAlpha").value =
          lt.visit_counter_bg_alpha !== undefined &&
          lt.visit_counter_bg_alpha !== null
            ? lt.visit_counter_bg_alpha
            : 20;
        toggleCustomNameField();
        toggleQuoteTypingFields();
        const btnOpen = $("btnOpenPublic");
        btnOpen.href = `/tree/${encodeURIComponent(lt.slug)}`;
        btnOpen.textContent = `/tree/${lt.slug}`;
        const availableBadges = Array.isArray(discordStatus?.badges)
          ? discordStatus.badges
          : [];
        if (Array.isArray(lt.discord_badge_codes)) {
          discordBadgeCodes = lt.discord_badge_codes;
        } else if (availableBadges.length) {
          discordBadgeCodes = availableBadges
            .map((b) => b && b.code)
            .filter(Boolean);
        } else {
          discordBadgeCodes = [];
        }
        renderDiscordBadges();
        updateDiscordUI();
      }

      function toggleCustomNameField() {
        const isCustom = $("inDisplayName").value === "custom";
        const input = $("inCustomName");
        input.disabled = !isCustom;
        if (input.parentElement) {
          input.parentElement.classList.toggle("muted", !isCustom);
        }
      }

      function toggleQuoteTypingFields() {
        const enabled = $("inQuoteTyping").checked;
        const wrap = $("quoteTypingFields");
        const speedWrap = $("quoteTypingSpeedWrap");
        const pauseInput = $("inQuotePause");
        if (wrap) {
          wrap.style.display = enabled ? "grid" : "none";
        }
        if (speedWrap) {
          speedWrap.style.display = enabled ? "block" : "none";
        }
        if (pauseInput && pauseInput.parentElement) {
          pauseInput.parentElement.style.display = enabled ? "block" : "none";
        }
      }

      function collectQuoteTexts() {
        const list = [
          $("inQuote").value.trim(),
          $("inQuoteAlt1").value.trim(),
          $("inQuoteAlt2").value.trim(),
        ].filter(Boolean);
        return list.slice(0, 3);
      }

      function resolveTemplateDevice(tpl) {
        if (!tpl) return "pc";
        if (tpl.device_type) return tpl.device_type;
        if (Array.isArray(tpl.variants)) {
          if (tpl.variants.length > 1) return "both";
          if (tpl.variants[0] && tpl.variants[0].device_type) {
            return tpl.variants[0].device_type;
          }
        }
        return "pc";
      }

      function variantFromTreeData(lt) {
        if (!lt || !lt.background_url) return null;
        const disp = lt.display_name_mode || "slug";
        return {
          device_type: lt.device_type || "pc",
          location: lt.location || "",
          quote: lt.quote || "",
          quote_typing_enabled: !!lt.quote_typing_enabled,
          quote_typing_texts: Array.isArray(lt.quote_typing_texts)
            ? lt.quote_typing_texts
            : [],
          quote_typing_speed:
            lt.quote_typing_speed !== undefined && lt.quote_typing_speed !== null
              ? lt.quote_typing_speed
              : DEFAULT_QUOTE_SPEED,
          quote_typing_pause:
            lt.quote_typing_pause !== undefined && lt.quote_typing_pause !== null
              ? lt.quote_typing_pause
              : DEFAULT_QUOTE_PAUSE,
          quote_font_size:
            lt.quote_font_size !== undefined && lt.quote_font_size !== null
              ? lt.quote_font_size
              : DEFAULT_QUOTE_SIZE,
          quote_font_family: lt.quote_font_family || "default",
          quote_effect: lt.quote_effect || "none",
          entry_text: lt.entry_text || "",
          entry_bg_alpha:
            lt.entry_bg_alpha !== undefined && lt.entry_bg_alpha !== null
              ? lt.entry_bg_alpha
              : DEFAULT_ENTRY_BG_ALPHA,
          entry_text_color: hexOrNull(lt.entry_text_color),
          entry_font_size:
            lt.entry_font_size !== undefined && lt.entry_font_size !== null
              ? lt.entry_font_size
              : DEFAULT_ENTRY_FONT_SIZE,
          entry_font_family: lt.entry_font_family || "default",
          entry_effect: lt.entry_effect || "none",
          entry_overlay_alpha:
            lt.entry_overlay_alpha !== undefined && lt.entry_overlay_alpha !== null
              ? lt.entry_overlay_alpha
              : DEFAULT_ENTRY_OVERLAY_ALPHA,
          entry_box_enabled:
            lt.entry_box_enabled !== undefined && lt.entry_box_enabled !== null
              ? !!lt.entry_box_enabled
              : true,
          entry_border_enabled:
            lt.entry_border_enabled !== undefined && lt.entry_border_enabled !== null
              ? !!lt.entry_border_enabled
              : true,
          entry_border_color: hexOrNull(lt.entry_border_color),
          song_url: lt.song_url || "",
          song_name: lt.song_name || "",
          song_icon_url: lt.song_icon_url || "",
          show_audio_player: !!lt.show_audio_player,
          audio_player_bg_color: hexOrNull(lt.audio_player_bg_color),
          audio_player_bg_alpha: clampPercent(
            lt.audio_player_bg_alpha ?? DEFAULT_AUDIO_BG_ALPHA,
            DEFAULT_AUDIO_BG_ALPHA
          ),
          audio_player_text_color: hexOrNull(lt.audio_player_text_color),
          audio_player_accent_color: hexOrNull(lt.audio_player_accent_color),
          background_url: lt.background_url,
          background_is_video:
            looksLikeVideoUrl(lt.background_url) || !!lt.background_is_video,
          transparency: clampPercent(lt.transparency ?? 0, 0),
          name_effect: lt.name_effect || "none",
          background_effect: lt.background_effect || "none",
          display_name_mode: disp,
          custom_display_name:
            disp === "custom" ? lt.custom_display_name || "" : null,
          linktree_profile_picture: lt.linktree_profile_picture || null,
          link_color: hexOrNull(lt.link_color),
          link_bg_color: hexOrNull(lt.link_bg_color),
          link_bg_alpha: clampPercent(lt.link_bg_alpha ?? 100, 100),
          card_color: hexOrNull(lt.card_color),
          text_color: hexOrNull(lt.text_color),
          name_color: hexOrNull(lt.name_color),
          location_color: hexOrNull(lt.location_color),
          quote_color: hexOrNull(lt.quote_color),
          cursor_url: lt.cursor_url || null,
          cursor_effect: lt.cursor_effect || "none",
          cursor_effect_color: hexOrNull(lt.cursor_effect_color),
          cursor_effect_alpha: clampPercent(
            lt.cursor_effect_alpha ?? DEFAULT_CURSOR_FX_ALPHA,
            DEFAULT_CURSOR_FX_ALPHA
          ),
          discord_frame_enabled: !!lt.discord_frame_enabled,
          discord_presence_enabled: !!lt.discord_presence_enabled,
          discord_status_enabled: !!lt.discord_status_enabled,
          discord_badges_enabled: !!lt.discord_badges_enabled,
          discord_badge_codes: Array.isArray(lt.discord_badge_codes)
            ? lt.discord_badge_codes
            : [],
          show_visit_counter: !!lt.show_visit_counter,
          visit_counter_color: hexOrNull(lt.visit_counter_color),
          visit_counter_bg_color: hexOrNull(lt.visit_counter_bg_color),
          visit_counter_bg_alpha: clampPercent(
            lt.visit_counter_bg_alpha ?? 20,
            20
          ),
        };
      }

      function buildVariantFromFormState(device) {
        const dev = device || currentDevice || "pc";
        const displayMode = $("inDisplayName").value || "slug";
        const customName = $("inCustomName").value.trim();
        if (displayMode === "custom" && !customName) {
          showMsg(
            msgTemplates || msgMeta,
            "Add a custom name before saving the template",
            false
          );
          return null;
        }
        const bgUrl = $("inBg").value.trim();
        if (!bgUrl) {
          showMsg(
            msgTemplates || msgMeta,
            "Upload a background before saving a template",
            false
          );
          return null;
        }
        const linkBgAlpha = clampPercent($("inLinkBgAlpha").value ?? 100, 100);
        const cardAlphaInput = clampPercent($("inTrans").value ?? 100, 100);
        const cursorFxAlpha = clampPercent(
          $("inCursorFxAlpha").value ?? DEFAULT_CURSOR_FX_ALPHA,
          DEFAULT_CURSOR_FX_ALPHA
        );
        const counterAlpha = clampPercent(
          $("inCounterBgAlpha").value ?? 20,
          20
        );
        const quoteTexts = collectQuoteTexts();
        const quoteSpeed = Math.min(
          200,
          Math.max(20, parseInt($("inQuoteSpeed").value || DEFAULT_QUOTE_SPEED, 10))
        );
        const quotePause = Math.min(
          10000,
          Math.max(
            200,
            parseInt($("inQuotePause").value || DEFAULT_QUOTE_PAUSE, 10)
          )
        );
        const quoteSize = Math.min(
          40,
          Math.max(10, parseInt($("inQuoteSize").value || DEFAULT_QUOTE_SIZE, 10))
        );
        const entryFontSize = Math.min(
          40,
          Math.max(
            10,
            parseInt($("inEntryFontSize").value || DEFAULT_ENTRY_FONT_SIZE, 10)
          )
        );
        const entryBgAlpha = clampPercent(
          $("inEntryBgAlpha").value ?? DEFAULT_ENTRY_BG_ALPHA,
          DEFAULT_ENTRY_BG_ALPHA
        );
        const entryOverlayAlpha = clampPercent(
          $("inEntryOverlayAlpha").value ?? DEFAULT_ENTRY_OVERLAY_ALPHA,
          DEFAULT_ENTRY_OVERLAY_ALPHA
        );
        const entryBoxEnabled = $("inEntryBoxEnabled").checked;
        const entryBorderEnabled = $("inEntryBorderEnabled").checked;
        const entryBorderColor = hexOrNull($("inEntryBorderColor").value);
        return {
          device_type: dev,
          location: $("inLocation").value.trim() || "",
          quote: quoteTexts[0] || "",
          quote_typing_enabled: $("inQuoteTyping").checked,
          quote_typing_texts: quoteTexts,
          quote_typing_speed: Number.isFinite(quoteSpeed)
            ? quoteSpeed
            : DEFAULT_QUOTE_SPEED,
          quote_typing_pause: Number.isFinite(quotePause)
            ? quotePause
            : DEFAULT_QUOTE_PAUSE,
          quote_font_size: Number.isFinite(quoteSize) ? quoteSize : DEFAULT_QUOTE_SIZE,
          quote_font_family: $("inQuoteFont").value || "default",
          quote_effect: $("inQuoteEffect").value || "none",
          entry_bg_alpha: Number.isFinite(entryBgAlpha)
            ? entryBgAlpha
            : DEFAULT_ENTRY_BG_ALPHA,
          entry_text_color: hexOrNull($("inEntryTextColor").value),
          entry_font_size: Number.isFinite(entryFontSize)
            ? entryFontSize
            : DEFAULT_ENTRY_FONT_SIZE,
          entry_font_family: $("inEntryFont").value || "default",
          entry_effect: $("inEntryEffect").value || "none",
          entry_overlay_alpha: Number.isFinite(entryOverlayAlpha)
            ? entryOverlayAlpha
            : DEFAULT_ENTRY_OVERLAY_ALPHA,
          entry_box_enabled: !!entryBoxEnabled,
          entry_border_enabled: !!entryBorderEnabled,
          entry_border_color: entryBorderColor,
          entry_text: $("inEntryText").value.trim() || "",
          song_url: $("inSong").value.trim() || "",
          song_name: $("inSongName").value.trim() || "",
          song_icon_url: $("inSongIcon").value.trim() || null,
          show_audio_player: $("inAudioPlayer").checked,
          audio_player_bg_color: hexOrNull($("inAudioBgColor").value),
          audio_player_bg_alpha: clampPercent(
            $("inAudioBgAlpha").value ?? DEFAULT_AUDIO_BG_ALPHA,
            DEFAULT_AUDIO_BG_ALPHA
          ),
          audio_player_text_color: hexOrNull($("inAudioTextColor").value),
          audio_player_accent_color: hexOrNull($("inAudioAccentColor").value),
          background_url: bgUrl,
          background_is_video: looksLikeVideoUrl(bgUrl),
          transparency: 100 - cardAlphaInput,
          name_effect: $("inNameFx").value || "none",
          background_effect: $("inBgFx").value || "none",
          display_name_mode: displayMode,
          custom_display_name: displayMode === "custom" ? customName : null,
          linktree_profile_picture: $("inLinktreePfp").value.trim() || null,
          link_color: hexOrNull($("inLinkColor").value),
          link_bg_color: hexOrNull($("inLinkBgColor").value),
          link_bg_alpha: Number.isFinite(linkBgAlpha) ? linkBgAlpha : 100,
          card_color: hexOrNull($("inCardColor").value),
          text_color: hexOrNull($("inTextColor").value),
          name_color: hexOrNull($("inNameColor").value),
          location_color: hexOrNull($("inLocationColor").value),
          quote_color: hexOrNull($("inQuoteColor").value),
          cursor_url: $("inCursor").value.trim() || null,
          cursor_effect: $("inCursorFx").value || "none",
          cursor_effect_color: hexOrNull($("inCursorFxColor").value),
          cursor_effect_alpha: Number.isFinite(cursorFxAlpha)
            ? cursorFxAlpha
            : DEFAULT_CURSOR_FX_ALPHA,
          discord_frame_enabled: $("inDiscordFrame").checked,
          discord_presence_enabled: $("inDiscordPresence").checked,
          discord_status_enabled: $("inDiscordStatus").checked,
          discord_badges_enabled: $("inDiscordBadges").checked,
          discord_badge_codes: Array.isArray(discordBadgeCodes)
            ? discordBadgeCodes
            : [],
          show_visit_counter: $("inShowCounter").checked,
          visit_counter_color: hexOrNull($("inCounterColor").value),
          visit_counter_bg_color: hexOrNull($("inCounterBgColor").value),
          visit_counter_bg_alpha: Number.isFinite(counterAlpha)
            ? counterAlpha
            : 20,
        };
      }

      function buildTemplateDemoUrl(tpl, device) {
        if (!tpl || !tpl.id) return "#";
        const dRaw = device || resolveTemplateDevice(tpl) || "pc";
        const d = dRaw === "both" ? "pc" : dRaw;
        const url = new URL(
          `/marketplace/templates/${encodeURIComponent(tpl.id)}/demo`,
          window.location.origin
        );
        url.searchParams.set("template_id", tpl.id);
        if (d) url.searchParams.set("device", d);
        return url.toString();
      }

      function renderSavedTemplates() {
        const grid = $("savedTemplatesGrid");
        if (!grid) return;
        grid.innerHTML = "";
        if (!savedTemplates.length) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.textContent = "No saved templates yet.";
          grid.appendChild(empty);
          return;
        }
        savedTemplates.forEach((tpl) => {
          if (!tpl || !tpl.id) return;
          const card = document.createElement("div");
          card.className = "template-card";
          const device = resolveTemplateDevice(tpl);
          const deviceChip = `<span class="chip">${templateDeviceLabel(
            device
          )}</span>`;
          const owner = tpl.creator || tpl.owner_username || "unknown";
          const isMine =
            currentUser &&
            (tpl.owner_username === currentUser.username ||
              tpl.owner_id === currentUser.id);
          const privacy = tpl.is_public ? "Public" : "Private";
          card.innerHTML = `
            <div class="title">
              <span>${escapeHtml(tpl.name || "Template")}</span>
              ${deviceChip}
            </div>
            <div class="sub">by ${escapeHtml(owner)}</div>
            <div class="meta-row">
              <span class="chip">${privacy}</span>
              ${isMine ? `<span class="chip">Yours</span>` : ""}
            </div>
          `;
          const btnRow = document.createElement("div");
          btnRow.className = "meta-row";
          const applyBtn = document.createElement("button");
          applyBtn.type = "button";
          applyBtn.className = "btn sm";
          applyBtn.textContent = "Apply";
          applyBtn.addEventListener("click", () => applySavedTemplate(tpl));
          btnRow.appendChild(applyBtn);
          const demoLink = document.createElement("a");
          demoLink.className = "btn sm ghost";
          demoLink.href = buildTemplateDemoUrl(tpl, device);
          demoLink.target = "_blank";
          demoLink.rel = "noopener";
          demoLink.textContent = "Demo";
          btnRow.appendChild(demoLink);
          card.appendChild(btnRow);
          grid.appendChild(card);
        });
      }

      async function loadSavedTemplates() {
        const grid = $("savedTemplatesGrid");
        if (!currentUser || !grid) return;
        grid.innerHTML = `<div class="muted">Loading templates...</div>`;
        try {
          const [savedRes, mineRes] = await Promise.all([
            fetch("/api/marketplace/templates/saved", {
              credentials: "include",
            }),
            fetch("/api/marketplace/templates/mine", {
              credentials: "include",
            }),
          ]);
          const saved = savedRes.ok ? await savedRes.json() : [];
          const mine = mineRes.ok ? await mineRes.json() : [];
          const merged = new Map();
          saved
            .filter((tpl) => tpl && tpl.id)
            .forEach((tpl) => merged.set(tpl.id, tpl));
          mine
            .filter((tpl) => tpl && tpl.id && tpl.is_public === false)
            .filter((tpl) =>
              (tpl.description || "")
                .toLowerCase()
                .includes(PRIVATE_TEMPLATE_MARKER)
            )
            .forEach((tpl) => {
              if (!merged.has(tpl.id)) merged.set(tpl.id, tpl);
            });
          savedTemplates = Array.from(merged.values());
          renderSavedTemplates();
        } catch (e) {
          renderSavedTemplates();
          showMsg(
            msgTemplates || msgMeta,
            "Could not load saved templates",
            false
          );
        }
      }

      async function applySavedTemplate(tpl) {
        if (!tpl || !tpl.id) return;
        const device = resolveTemplateDevice(tpl) || currentDevice || "pc";
        const label = templateDeviceLabel(device);
        const ok = confirm(
          `Apply "${
            tpl.name || "Template"
          }" to your ${label}? Links and icons stay unchanged.`
        );
        if (!ok) return;
        try {
          await apiApplyTemplate(tpl.id, device);
          showMsg(
            msgTemplates || msgMeta,
            `Template applied to ${label}`,
            true
          );
          await refreshData();
        } catch (err) {
          showMsg(msgTemplates || msgMeta, "Template apply failed", false);
        }
      }

      async function savePrivateTemplate() {
        if (!currentUser) {
          showMsg(msgTemplates || msgMeta, "Login required", false);
          return;
        }
        const slug = $("inSlug").value.trim();
        if (!slug) {
          showMsg(
            msgTemplates || msgMeta,
            "Set a slug before saving a template",
            false
          );
          return;
        }
        const activeDevice = $("inDevice").value || currentDevice || "pc";
        const mainVariant = buildVariantFromFormState(activeDevice);
        if (!mainVariant) return;
        const variants = [mainVariant];
        const otherDevice = activeDevice === "pc" ? "mobile" : "pc";
        try {
          const otherTree = await apiLoadTreeOwnerBySlug(slug, otherDevice);
          const otherVariant = variantFromTreeData(otherTree);
          if (otherVariant) variants.push(otherVariant);
        } catch (_) {}
        const deviceLabel =
          variants.length > 1
            ? "Desktop + Mobile"
            : templateDeviceLabel(mainVariant.device_type);
        const payload = {
          name: `${slug} – ${deviceLabel}`,
          description: PRIVATE_TEMPLATE_DESC,
          creator: currentUser.username || "User",
          is_public: false,
          preview_image_url: null,
          variants,
        };
        try {
          await fetch("/api/marketplace/templates", {
            method: "POST",
            headers: headers(),
            credentials: "include",
            body: JSON.stringify(payload),
          });
          showMsg(msgTemplates || msgMeta, "Private template saved", true);
          await loadSavedTemplates();
        } catch (err) {
          showMsg(msgTemplates || msgMeta, "Save failed", false);
        }
      }

      let dragStartOrder = "";

      function domOrderKey(container) {
        return Array.from(container.querySelectorAll(".link-item"))
          .map((el) => el.dataset.id || "")
          .join("|");
      }

      function getDragAfterElement(container, y) {
        const els = Array.from(
          container.querySelectorAll(".link-item:not(.dragging)")
        );
        let closest = { offset: Number.NEGATIVE_INFINITY, el: null };
        els.forEach((el) => {
          const box = el.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            closest = { offset, el };
          }
        });
        return closest.el;
      }

      function ensureLinksDrag(container) {
        if (!container || container.dataset.dragBound === "1") return;
        container.dataset.dragBound = "1";
        container.addEventListener("dragover", (e) => {
          e.preventDefault();
          const after = getDragAfterElement(container, e.clientY);
          const dragging = container.querySelector(".dragging");
          if (!dragging) return;
          if (!after) {
            container.appendChild(dragging);
          } else {
            container.insertBefore(dragging, after);
          }
        });
      }

      async function persistLinkOrder(container) {
        const wrap = container || $("linksList");
        if (!wrap) return;
        const rows = Array.from(wrap.querySelectorAll(".link-item"));
        if (!rows.length) return;
        const results = await Promise.all(
          rows.map((row, idx) =>
            apiUpdateLink(
              Number(row.dataset.id),
              { position: idx },
              { silent: true, skipRefresh: true }
            )
          )
        );
        if (results.some((ok) => ok === false)) {
          showMsg(msgLinks, "Reorder failed", false);
          await refreshData();
          return;
        }
        await refreshData();
        showMsg(msgLinks, "Order updated", true);
      }

      function moveLinkRow(row, direction = 0) {
        if (!direction || !row || !row.parentElement) return;
        const wrap = row.parentElement;
        if (direction < 0 && row.previousElementSibling) {
          wrap.insertBefore(row, row.previousElementSibling);
        } else if (direction > 0 && row.nextElementSibling) {
          wrap.insertBefore(row.nextElementSibling, row);
        } else {
          return;
        }
        persistLinkOrder(wrap);
      }

      function renderLinks(links) {
        const wrap = $("linksList");
        if (HIDE_LINKS || !wrap) return;
        wrap.innerHTML = "";
        ensureLinksDrag(wrap);
        (links || []).forEach((l, idx) => {
          const row = document.createElement("div");
          row.className = "link-item";
          row.dataset.id = l.id;
          row.dataset.position = idx;
          row.draggable = true;
          row.innerHTML = `
        <span class="handle" title="Move" aria-hidden="true">☰</span>
        <input class="input" data-k="label" placeholder="Label" value="${(
          l.label || ""
        ).replaceAll('"', "&quot;")}">
        <input class="input" data-k="url" placeholder="https://…" value="${
          l.url
        }">
          <div class="link-icon-upload">
            <input type="file" class="input" data-k="icon_file" accept="image/*">
            <input type="hidden" data-k="icon_url" value="${(
              l.icon_url || ""
            ).replaceAll("\"", "&quot;")}">
            <div class="muted" data-k="icon_status"></div>
            <button class="btn sm ghost" type="button" data-act="icon-remove">
              Remove Icon
            </button>
          </div>
        <select class="select" data-k="is_active">
          <option value="true"${l.is_active ? " selected" : ""}>Active</option>
          <option value="false"${
            !l.is_active ? " selected" : ""
          }>Hidden</option>
        </select>
        <button class="btn sm ghost" data-act="up" title="Up">▲</button>
        <button class="btn sm ghost" data-act="down" title="Down">▼</button>
        <button class="btn sm" data-act="save">Save</button>
        <button class="btn sm danger" data-act="del">Delete</button>
      `;
        const iconUrlInput = row.querySelector('[data-k="icon_url"]');
        const iconStatus = row.querySelector('[data-k="icon_status"]');
        if (iconStatus) {
          iconStatus.textContent =
            fileNameFromUrl(l.icon_url || "") || "No icon uploaded.";
        }
        const iconFile = row.querySelector('[data-k="icon_file"]');
        if (iconFile) {
          iconFile.addEventListener("change", async () => {
            try {
              const url = await uploadInlineFile(
                iconFile,
                "/api/users/me/linkicon"
              );
              if (!url) return;
              if (iconUrlInput) iconUrlInput.value = url;
              if (iconStatus) {
                iconStatus.textContent =
                  fileNameFromUrl(url) || "No icon uploaded.";
              }
              await apiUpdateLink(
                l.id,
                { icon_url: url },
                { silent: true, skipRefresh: true }
              );
              showMsg(msgLinks, "Icon uploaded", true);
            } catch (e) {
              showMsg(msgLinks, "Icon upload failed", false);
            }
          });
        }
        const iconRemove = row.querySelector('[data-act="icon-remove"]');
        if (iconRemove) {
          iconRemove.addEventListener("click", async () => {
            if (iconUrlInput) iconUrlInput.value = "";
            if (iconFile) iconFile.value = "";
            if (iconStatus) iconStatus.textContent = "No icon uploaded.";
            await apiUpdateLink(
              l.id,
              { icon_url: null },
              { silent: true, skipRefresh: true }
            );
            showMsg(msgLinks, "Icon removed", true);
          });
        }
          row
            .querySelector('[data-act="save"]')
            .addEventListener("click", async () => {
              const currentPosition = Array.from(wrap.children).indexOf(row);
              const body = {
                label:
                  row.querySelector('[data-k="label"]').value.trim() || null,
                url: row.querySelector('[data-k="url"]').value.trim(),
                icon_url:
                  row.querySelector('[data-k="icon_url"]').value.trim() || null,
                is_active:
                  row.querySelector('[data-k="is_active"]').value === "true",
                position: currentPosition,
              };
              await apiUpdateLink(l.id, body);
            });
          row
            .querySelector('[data-act="del"]')
            .addEventListener("click", async () => {
              if (!confirm("Delete this link?")) return;
              await apiDeleteLink(l.id);
            });
          row
            .querySelector('[data-act="up"]')
            .addEventListener("click", async () => {
              moveLinkRow(row, -1);
            });
          row
            .querySelector('[data-act="down"]')
            .addEventListener("click", async () => {
              moveLinkRow(row, 1);
            });
          row.addEventListener("dragstart", (evt) => {
            dragStartOrder = domOrderKey(wrap);
            row.classList.add("dragging");
            if (evt.dataTransfer) {
              evt.dataTransfer.effectAllowed = "move";
              evt.dataTransfer.setData("text/plain", String(l.id));
            }
          });
          row.addEventListener("dragend", async () => {
            row.classList.remove("dragging");
            const orderAfter = domOrderKey(wrap);
            if (orderAfter !== dragStartOrder) {
              await persistLinkOrder(wrap);
            }
          });
          wrap.appendChild(row);
        });
      }

      function renderBadges(list) {
        const box = $("badges");
        if (!box) return;
        box.innerHTML = "";
        (list || []).forEach((ic) => {
          const item = document.createElement("div");
          item.className = "badge-item";
          item.innerHTML = `
        <img src="${ic.image_url}" alt="${ic.code}" class="icon-16">
        <strong>${ic.code}</strong>
        <span class="muted">${ic.description || ""}</span>
        <span class="kbd" title="Acquired">${
          ic.acquired_at ? new Date(ic.acquired_at).toLocaleDateString() : ""
        }</span>
        <label class="row" style="margin-left:auto;gap:.35rem">
          <span class="muted">Displayed</span>
          <input type="checkbox" ${
            ic.displayed ? "checked" : ""
          } aria-label="Displayed">
        </label>
      `;
          const chk = item.querySelector('input[type="checkbox"]');
          chk.addEventListener("change", async () => {
            await apiToggleMyIcon(ic.code, chk.checked);
          });
          box.appendChild(item);
        });
      }

      async function apiUpdateDiscordBadgeCodes(codes) {
        if (!linktreeId) {
          showMsg(msgMeta, "Create the Linktree first", false);
          return;
        }
        const r = await fetch(`/api/linktrees/${linktreeId}`, {
          method: "PATCH",
          headers: headers(),
          credentials: "include",
          body: JSON.stringify({ discord_badge_codes: codes }),
        });
        if (!r.ok) {
          showMsg(msgMeta, "Discord badges update failed", false);
          return;
        }
        showMsg(msgMeta, "Discord badges updated", true);
        await refreshData();
      }

      function renderDiscordBadges() {
        const box = $("discordBadgesList");
        const hint = $("discordBadgesHint");
        if (!box) return;
        box.innerHTML = "";
        if (hint) hint.textContent = "";

        const linked = !!(discordStatus && discordStatus.linked);
        if (!linked) {
          if (hint)
            hint.textContent = "Link Discord to manage your Discord badges.";
          return;
        }
        const list = Array.isArray(discordStatus?.badges)
          ? discordStatus.badges
          : [];
        if (!list.length) {
          if (hint) hint.textContent = "No Discord badges found on your account.";
          return;
        }

        if (!Array.isArray(discordBadgeCodes)) {
          discordBadgeCodes = list.map((b) => b && b.code).filter(Boolean);
        }

        list.forEach((badge) => {
          if (!badge) return;
          const item = document.createElement("div");
          item.className = "badge-item";
          const label = badge.label || badge.code || "badge";
          const icon = sanitizeUrl(badge.icon_url ? String(badge.icon_url) : "");
          const checked =
            Array.isArray(discordBadgeCodes) &&
            discordBadgeCodes.includes(badge.code);
          item.innerHTML = `
        <img src="${icon}" alt="${badge.code || ""}" class="icon-16">
        <strong>${escapeHtml(badge.code || "badge")}</strong>
        <span class="muted">${escapeHtml(label)}</span>
        <span class="kbd"></span>
        <label class="row" style="margin-left:auto;gap:.35rem">
          <span class="muted">Displayed</span>
          <input type="checkbox" data-code="${escapeHtml(
            badge.code || ""
          )}" ${checked ? "checked" : ""} aria-label="Displayed">
        </label>
      `;
          const chk = item.querySelector('input[type="checkbox"]');
          chk.addEventListener("change", async () => {
            const codes = Array.from(
              box.querySelectorAll('input[type="checkbox"][data-code]')
            )
              .filter((input) => input.checked)
              .map((input) => input.getAttribute("data-code"))
              .filter(Boolean);
            discordBadgeCodes = codes;
            await apiUpdateDiscordBadgeCodes(codes);
          });
          box.appendChild(item);
        });
      }

      function updateDiscordUI() {
        const statusEl = $("discordStatusText");
        const previewEl = $("discordPreview");
        const toggleEl = $("inDiscordFrame");
        const presenceToggle = $("inDiscordPresence");
        const statusToggle = $("inDiscordStatus");
        const badgesToggle = $("inDiscordBadges");
        const linkBtn = $("btnDiscordLink");
        const unlinkBtn = $("btnDiscordUnlink");
        const linked = !!(discordStatus && discordStatus.linked);
        if (statusEl) {
          const name =
            (discordStatus &&
              (discordStatus.global_name || discordStatus.username)) ||
            "Discord user";
          statusEl.textContent = linked ? `Linked as ${name}` : "Not linked";
        }
        if (linkBtn && unlinkBtn) {
          linkBtn.style.display = linked ? "none" : "inline-flex";
          unlinkBtn.style.display = linked ? "inline-flex" : "none";
        }
        if (toggleEl) {
          toggleEl.disabled = !linked;
          if (!linked) toggleEl.checked = false;
        }
        if (presenceToggle) {
          presenceToggle.disabled = !linked;
          if (!linked) presenceToggle.checked = false;
        }
        if (statusToggle) {
          statusToggle.disabled = !linked;
          if (!linked) statusToggle.checked = false;
        }
        if (badgesToggle) {
          badgesToggle.disabled = !linked;
          if (!linked) badgesToggle.checked = false;
        }
        if (previewEl) {
          previewEl.innerHTML = "";
          previewEl.classList.remove("muted");
          if (linked && discordStatus && discordStatus.decoration_url) {
            const wrap = document.createElement("div");
            wrap.className = "pfp-preview";
            const img = document.createElement("img");
            img.src = discordStatus.decoration_url;
            img.alt = "Discord profile frame";
            img.loading = "lazy";
            wrap.appendChild(img);
            previewEl.appendChild(wrap);
          } else {
            previewEl.classList.add("muted");
            previewEl.textContent = linked
              ? "No Discord profile frame detected on your account."
              : "Link Discord to use your Discord profile frame.";
          }
        }
        renderDiscordBadges();
      }

      async function loadDiscordStatus() {
        try {
          const r = await fetch("/api/discord/status", {
            credentials: "include",
          });
          discordStatus = r.ok ? await r.json() : { linked: false };
          discordBadgeCodes = null;
        } catch (_) {
          discordStatus = { linked: false };
          discordBadgeCodes = null;
        }
        updateDiscordUI();
      }

      async function startDiscordLink() {
        try {
          const r = await fetch("/api/discord/oauth-url", {
            credentials: "include",
          });
          if (!r.ok) {
            showMsg(msgMeta, "Discord linking unavailable", false);
            return;
          }
          const { url, configured, reason } = await r.json();
          if (!configured || !url) {
            showMsg(msgMeta, reason || "Discord linking not configured", false);
            return;
          }
          const w = window.open(url, "discord_link", "width=520,height=720");
          if (!w) showMsg(msgMeta, "Allow popups to link Discord", false);
        } catch (e) {
          showMsg(msgMeta, "Discord link failed", false);
        }
      }

      async function unlinkDiscord() {
        try {
          const r = await fetch("/api/discord/account", {
            method: "DELETE",
            credentials: "include",
          });
          if (!r.ok) throw new Error(await r.text());
          discordStatus = { linked: false };
          $("inDiscordFrame").checked = false;
          updateDiscordUI();
          await refreshData();
          showMsg(msgMeta, "Discord disconnected", true);
        } catch (e) {
          showMsg(msgMeta, "Unlink failed", false);
        }
      }

      function headers() {
        return { "Content-Type": "application/json" };
      }

      async function apiLoadTreeBySlug(slug, device = currentDevice) {
        const r = await fetch(
          `/api/linktrees/${encodeURIComponent(
            slug
          )}?device=${encodeURIComponent(device || "pc")}`
        );
        if (!r.ok) return null;
        const lt = await r.json();
        return lt;
      }

      async function apiLoadTreeOwnerBySlug(slug, device = currentDevice) {
        const r = await fetch(
          `/api/linktrees/by-slug/${encodeURIComponent(
            slug
          )}/manage?device=${encodeURIComponent(device || "pc")}`,
          { headers: headers(), credentials: "include" }
        );
        if (!r.ok) return null;
        return await r.json();
      }

      async function apiCloneVariant(slug, targetDevice = "mobile") {
        const r = await fetch(
          `/api/linktrees/${encodeURIComponent(
            slug
          )}/clone?target_device=${encodeURIComponent(targetDevice)}`,
          { method: "POST", headers: headers(), credentials: "include" }
        );
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiEnsureOrUpdateMeta(exists) {
        const linkBgAlpha = Math.min(
          100,
          Math.max(0, parseInt($("inLinkBgAlpha").value || "100", 10))
        );
        const cardAlphaInput = Math.min(
          100,
          Math.max(0, parseInt($("inTrans").value || "100", 10))
        );
        const audioBgAlpha = clampPercent(
          $("inAudioBgAlpha").value ?? DEFAULT_AUDIO_BG_ALPHA,
          DEFAULT_AUDIO_BG_ALPHA
        );
        const cursorFxAlpha = clampPercent(
          $("inCursorFxAlpha").value ?? DEFAULT_CURSOR_FX_ALPHA,
          DEFAULT_CURSOR_FX_ALPHA
        );
        const quoteTexts = collectQuoteTexts();
        const quoteSpeed = Math.min(
          200,
          Math.max(20, parseInt($("inQuoteSpeed").value || DEFAULT_QUOTE_SPEED, 10))
        );
        const quotePause = Math.min(
          10000,
          Math.max(
            200,
            parseInt($("inQuotePause").value || DEFAULT_QUOTE_PAUSE, 10)
          )
        );
        const quoteSize = Math.min(
          40,
          Math.max(10, parseInt($("inQuoteSize").value || DEFAULT_QUOTE_SIZE, 10))
        );
        const entryFontSize = Math.min(
          40,
          Math.max(
            10,
            parseInt($("inEntryFontSize").value || DEFAULT_ENTRY_FONT_SIZE, 10)
          )
        );
        const entryBgAlpha = Math.min(
          100,
          Math.max(
            0,
            parseInt($("inEntryBgAlpha").value || DEFAULT_ENTRY_BG_ALPHA, 10)
          )
        );
        const entryOverlayAlpha = Math.min(
          100,
          Math.max(
            0,
            parseInt(
              $("inEntryOverlayAlpha").value || DEFAULT_ENTRY_OVERLAY_ALPHA,
              10
            )
          )
        );
        const entryBoxEnabled = $("inEntryBoxEnabled").checked;
        const entryBorderEnabled = $("inEntryBorderEnabled").checked;
        const entryBorderColor = hexOrNull($("inEntryBorderColor").value);
        const body = {
          slug: $("inSlug").value.trim(),
          device_type: currentDevice,
          location: $("inLocation").value.trim() || null,
          quote: quoteTexts[0] || null,
          quote_typing_enabled: $("inQuoteTyping").checked,
          quote_typing_texts: quoteTexts,
          quote_typing_speed: Number.isFinite(quoteSpeed)
            ? quoteSpeed
            : DEFAULT_QUOTE_SPEED,
          quote_typing_pause: Number.isFinite(quotePause)
            ? quotePause
            : DEFAULT_QUOTE_PAUSE,
          quote_font_size: Number.isFinite(quoteSize) ? quoteSize : DEFAULT_QUOTE_SIZE,
          quote_font_family: $("inQuoteFont").value || "default",
          quote_effect: $("inQuoteEffect").value || "none",
          entry_bg_alpha: Number.isFinite(entryBgAlpha)
            ? entryBgAlpha
            : DEFAULT_ENTRY_BG_ALPHA,
          entry_overlay_alpha: Number.isFinite(entryOverlayAlpha)
            ? entryOverlayAlpha
            : DEFAULT_ENTRY_OVERLAY_ALPHA,
          entry_box_enabled: !!entryBoxEnabled,
          entry_border_enabled: !!entryBorderEnabled,
          entry_border_color: entryBorderColor,
          entry_text_color: hexOrNull($("inEntryTextColor").value),
          entry_font_size: Number.isFinite(entryFontSize)
            ? entryFontSize
            : DEFAULT_ENTRY_FONT_SIZE,
          entry_font_family: $("inEntryFont").value || "default",
          entry_effect: $("inEntryEffect").value || "none",
          entry_text: $("inEntryText").value.trim() || null,
          song_url: $("inSong").value.trim() || null,
          song_name: $("inSongName").value.trim() || null,
          song_icon_url: $("inSongIcon").value.trim() || null,
          show_audio_player: $("inAudioPlayer").checked,
          audio_player_bg_color: hexOrNull($("inAudioBgColor").value),
          audio_player_bg_alpha: Number.isFinite(audioBgAlpha)
            ? audioBgAlpha
            : DEFAULT_AUDIO_BG_ALPHA,
          audio_player_text_color: hexOrNull($("inAudioTextColor").value),
          audio_player_accent_color: hexOrNull($("inAudioAccentColor").value),
          background_url: $("inBg").value.trim() || null,
          background_is_video: looksLikeVideoUrl($("inBg").value.trim()),
          transparency: 100 - cardAlphaInput,
          name_effect: $("inNameFx").value || "none",
          background_effect: $("inBgFx").value || "none",
          display_name_mode: $("inDisplayName").value,
          custom_display_name: $("inCustomName").value.trim() || null,
          linktree_profile_picture: $("inLinktreePfp").value.trim() || null,
          text_color: $("inTextColor").value || null,
          name_color: $("inNameColor").value || null,
          location_color: $("inLocationColor").value || null,
          quote_color: $("inQuoteColor").value || null,
          link_color: $("inLinkColor").value || null,
          link_bg_color: $("inLinkBgColor").value || null,
          link_bg_alpha: Number.isFinite(linkBgAlpha) ? linkBgAlpha : 100,
          card_color: $("inCardColor").value || null,
          cursor_url: $("inCursor").value.trim() || null,
          cursor_effect: $("inCursorFx").value || "none",
          cursor_effect_color: $("inCursorFxColor").value || null,
          cursor_effect_alpha: Number.isFinite(cursorFxAlpha)
            ? cursorFxAlpha
            : DEFAULT_CURSOR_FX_ALPHA,
          discord_frame_enabled: $("inDiscordFrame").checked,
          discord_presence_enabled: $("inDiscordPresence").checked,
          discord_status_enabled: $("inDiscordStatus").checked,
          discord_badges_enabled: $("inDiscordBadges").checked,
          discord_badge_codes: Array.isArray(discordBadgeCodes)
            ? discordBadgeCodes
            : null,
          show_visit_counter: $("inShowCounter").checked,
          visit_counter_color: $("inCounterColor").value || null,
          visit_counter_bg_color: $("inCounterBgColor").value || null,
          visit_counter_bg_alpha: Math.min(
            100,
            Math.max(0, parseInt($("inCounterBgAlpha").value || "20", 10))
          ),
        };
        if (!exists) {
          const r = await fetch("/api/linktrees", {
            method: "POST",
            headers: headers(),
            credentials: "include",
            body: JSON.stringify(body),
          });
          if (!r.ok) {
            throw new Error(await r.text());
          }
          return await r.json();
        } else {
          const r = await fetch(`/api/linktrees/${linktreeId}`, {
            method: "PATCH",
            headers: headers(),
            credentials: "include",
            body: JSON.stringify(body),
          });
          if (!r.ok) {
            throw new Error(await r.text());
          }
          return { ok: true };
        }
      }

      async function apiApplyTemplate(templateId, device) {
        const target = device || currentDevice || "pc";
        const r = await fetch(
          `/api/marketplace/templates/${encodeURIComponent(
            templateId
          )}/apply?device=${encodeURIComponent(target)}`,
          {
            method: "POST",
            headers: headers(),
            credentials: "include",
          }
        );
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiAddLink() {
        const body = {
          url: $("inLinkUrl").value.trim(),
          label: $("inLinkLabel").value.trim() || null,
          icon_url: $("inLinkIcon").value.trim() || null,
          is_active: $("inLinkActive").value === "true",
        };
        const r = await fetch(`/api/linktrees/${linktreeId}/links`, {
          method: "POST",
          headers: headers(),
          credentials: "include",
          body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiUpdateLink(linkId, body, opts = {}) {
        const silent = !!opts.silent;
        const skipRefresh = !!opts.skipRefresh;
        const r = await fetch(`/api/links/${linkId}`, {
          method: "PATCH",
          headers: headers(),
          credentials: "include",
          body: JSON.stringify(body),
        });
        if (!r.ok) {
          if (!silent) showMsg(msgLinks, "Update failed", false);
          return false;
        }
        if (!silent) showMsg(msgLinks, "Saved", true);
        if (!skipRefresh) await refreshData();
        return true;
      }

      async function apiDeleteLink(linkId) {
        const r = await fetch(`/api/links/${linkId}`, {
          method: "DELETE",
          headers: headers(),
          credentials: "include",
        });
        if (!r.ok) {
          showMsg(msgLinks, "Delete failed", false);
          return;
        }
        showMsg(msgLinks, "Deleted", true);
        await refreshData();
      }

      async function apiToggleMyIcon(code, displayed) {
        const r = await fetch(
          `/api/users/me/icons/${encodeURIComponent(code)}`,
          {
            method: "PATCH",
            headers: headers(),
            credentials: "include",
            body: JSON.stringify({ displayed }),
          }
        );
        if (!r.ok) {
          showMsg(msgMeta, "Icon toggle failed", false);
          return;
        }
        showMsg(msgMeta, "Icon updated", true);
        await refreshData();
      }

      const btnCreateTemplate = $("btnCreateTemplate");
      function updateCreateTemplateLink() {
        if (!btnCreateTemplate) return;
        const slug = $("inSlug").value.trim();
        const device = $("inDevice").value || currentDevice || "pc";
        const params = new URLSearchParams();
        params.set("source", "config");
        if (slug) params.set("slug", slug);
        if (device) params.set("device", device);
        btnCreateTemplate.href =
          "/marketplace/create" +
          (params.toString() ? "?" + params.toString() : "");
      }

      async function autoSaveBeforeDeviceSwitch() {
        if (!currentUser) {
          showMsg(msgMeta, "Not logged in", false);
          return false;
        }
        const slug = $("inSlug").value.trim();
        if (!slug) {
          showMsg(msgMeta, "Set a slug before switching devices", false);
          return false;
        }
        try {
          const exists = !!linktreeId;
          const res = await apiEnsureOrUpdateMeta(exists);
          if (!exists && res && res.id) {
            linktreeId = res.id;
          }
          return true;
        } catch (err) {
          showMsg(msgMeta, String(err), false);
          return false;
        }
      }

      $("inSlug").addEventListener("input", (e) => {
        $("slugPreview").textContent = e.target.value.trim() || "-";
        $("btnOpenPublic").href = `/tree/${encodeURIComponent(
          e.target.value.trim()
        )}`;
        updateCreateTemplateLink();
      });
      $("inDisplayName").addEventListener("change", toggleCustomNameField);
      $("inQuoteTyping").addEventListener("change", toggleQuoteTypingFields);
      toggleCustomNameField();
      toggleQuoteTypingFields();

      $("inDevice").addEventListener("change", async (e) => {
        const nextDevice = e.target.value || "pc";
        const prevDevice = currentDevice || "pc";
        if (nextDevice === prevDevice) return;
        const ok = await autoSaveBeforeDeviceSwitch();
        if (!ok) {
          e.target.value = prevDevice;
          return;
        }
        currentDevice = nextDevice;
        updateCreateTemplateLink();
        await refreshData();
      });
      if ($("btnSavePrivateTemplate")) {
        $("btnSavePrivateTemplate").addEventListener(
          "click",
          savePrivateTemplate
        );
      }
      $("btnDiscordLink").addEventListener("click", startDiscordLink);
      $("btnDiscordUnlink").addEventListener("click", unlinkDiscord);
      $("inDiscordPresence").addEventListener("change", updateDiscordUI);
      $("inDiscordStatus").addEventListener("change", updateDiscordUI);

      $("formMeta").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUser) {
          showMsg(msgMeta, "Not logged in", false);
          return;
        }
        try {
          const exists = !!linktreeId;
          const res = await apiEnsureOrUpdateMeta(exists);
          showMsg(msgMeta, exists ? "Updated" : "Created", true);
          await refreshData();
        } catch (err) {
          showMsg(msgMeta, String(err), false);
        }
      });

      if (!HIDE_LINKS && $("formAddLink")) {
        $("formAddLink").addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!linktreeId) {
            showMsg(msgLinks, "Create the Linktree first", false);
            return;
          }
          try {
            await apiAddLink();
            $("inLinkUrl").value = "";
            $("inLinkLabel").value = "";
            $("inLinkIcon").value = "";
            if ($("fileIcon")) $("fileIcon").value = "";
            setUploadStatus("linkIconStatus", "", "No icon uploaded.");
            $("inLinkActive").value = "true";
            showMsg(msgLinks, "Link added", true);
            await refreshData();
          } catch (err) {
            showMsg(msgLinks, String(err), false);
          }
        });
      }

      async function refreshData() {
        const slugInput = $("inSlug").value.trim();
        let lt = null;

        if (!slugInput) {
          currentTree = null;
          return;
        }

        if (currentUser) {
          lt = await apiLoadTreeOwnerBySlug(slugInput, currentDevice);
        }

        if (!lt && currentDevice === "mobile" && currentUser) {
          try {
            lt = await apiCloneVariant(slugInput, "mobile");
            showMsg(msgMeta, "Mobile version created from desktop", true);
            linktreeId = lt.id;
          } catch (_) {
            showMsg(msgMeta, "Create mobile copy failed", false);
          }
        }

        if (!lt) {
          currentTree = null;
          return;
        }

        currentTree = lt;
        linktreeId = lt.id;
        currentDevice = lt.device_type || currentDevice;
        $("inDevice").value = currentDevice;

        fillMetaForm(lt);
        renderLinks(lt.links || []);
        renderBadges(lt.icons || []);
      }

      window.addEventListener("message", async (evt) => {
        if (evt && evt.data && evt.data.type === "discord-linked") {
          await loadDiscordStatus();
          await refreshData();
          showMsg(msgMeta, "Discord linked", true);
        }
      });

      async function boot() {
        try {
          const user = await renderAuthHeader();
          if (!user) {
            document.getElementById("notLogged").style.display = "block";
            document.getElementById("cfgWrap").style.display = "none";
            return;
          }
          document.getElementById("cfgWrap").style.display = "grid";

          const preferred =
            slugFromQuery() ||
            user.linktree_slug ||
            (user.username || "").toLowerCase().replace(/[^a-z0-9_-]/gi, "");
          document.getElementById("inSlug").value = preferred;
          document.getElementById("slugPreview").textContent = preferred;
          document.getElementById(
            "btnOpenPublic"
          ).href = `/tree/${encodeURIComponent(preferred)}`;
          const preferredDevice = deviceFromQuery();
          currentDevice =
            preferredDevice === "both" ? "pc" : preferredDevice || "pc";
          document.getElementById("inDevice").value = currentDevice;
          updateCreateTemplateLink();
          await loadDiscordStatus();
          await refreshData();
          await loadSavedTemplates();
          const templateId = templateIdFromQuery();
          if (templateId) {
            try {
              const devParam = preferredDevice || currentDevice;
              await apiApplyTemplate(templateId, devParam);
              showMsg(
                msgMeta,
                devParam === "both"
                  ? "Template applied to desktop and mobile"
                  : "Template applied",
                true
              );
              await refreshData();
            } catch (err) {
              showMsg(msgMeta, "Template apply failed", false);
            }
            const url = new URL(location.href);
            url.searchParams.delete("template_id");
            url.searchParams.delete("device");
            history.replaceState({}, "", url.toString());
          }
          if (!currentTree) {
            showMsg(
              msgMeta,
              "You don't have a Linktree yet. Fill fields and Save to create it.",
              false
            );
          }
        } catch (e) {
          console.error("boot failed:", e);
          showMsg(msgMeta, "Init failed – see console", false);
          document.getElementById("notLogged").style.display = "block";
        }
      }
      boot();

      const hashedFileCache = new WeakMap();
      async function withHashedFile(file) {
        if (!file) return null;
        if (hashedFileCache.has(file)) return hashedFileCache.get(file);
        const name = file.name || "upload";
        const dot = name.lastIndexOf(".");
        const base = dot > 0 ? name.slice(0, dot) : name;
        const ext = dot > 0 ? name.slice(dot) : "";
        let hash = "";
        try {
          const buf = await file.arrayBuffer();
          const digest = await crypto.subtle.digest("SHA-256", buf);
          hash = Array.from(new Uint8Array(digest))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("")
            .slice(0, 16);
        } catch (_) {
          hash = Math.random().toString(16).slice(2, 10);
        }
        const safeBase = base.replace(/[^a-zA-Z0-9._-]/g, "_");
        const hashedName = `${safeBase}--${hash}${ext}`;
        const hashed = new File([file], hashedName, {
          type: file.type,
          lastModified: file.lastModified,
        });
        hashedFileCache.set(file, hashed);
        return hashed;
      }

      async function uploadInlineFile(inputEl, endpoint) {
        if (!inputEl || !inputEl.files || !inputEl.files[0]) return null;
        if (!currentUser) {
          const user = await renderAuthHeader();
          if (!user) throw new Error("Not logged in");
        }
        const raw = inputEl.files[0];
        const file = (await withHashedFile(raw)) || raw;
        const fd = new FormData();
        fd.append("file", file);
        const r = await fetch(endpoint, {
          method: "POST",
          credentials: "include",
          body: fd,
        });
        if (!r.ok) throw new Error(await r.text());
        const { url } = await r.json();
        return url;
      }

      async function uploadFile(inputId, endpoint) {
        const raw = $(inputId).files[0];
        const f = (await withHashedFile(raw)) || raw;
        if (!f) return null;
        if (!currentUser) {
          const user = await renderAuthHeader();
          if (!user) throw new Error("Not logged in");
        }
        const fd = new FormData();
        fd.append("file", f);
        const r = await fetch(endpoint, {
          method: "POST",
          credentials: "include",
          body: fd,
        });
        if (!r.ok) throw new Error(await r.text());
        const data = await r.json();
        if (!data) return { url: "" };
        if (typeof data === "string") return { url: data };
        if (typeof data === "object") {
          return {
            url: typeof data.url === "string" ? data.url : "",
            name: typeof data.name === "string" ? data.name : "",
          };
        }
        return { url: "" };
      }

      async function fetchUpload(inputId, endpoint) {
        const raw = $(inputId).files[0];
        const f = (await withHashedFile(raw)) || raw;
        if (!f) return null;
        if (!currentUser) {
          const user = await renderAuthHeader();
          if (!user) throw new Error("Not logged in");
        }
        const fd = new FormData();
        fd.append("file", f);
        const r = await fetch(endpoint, {
          method: "POST",
          credentials: "include",
          body: fd,
        });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function removeMetaUpload(opts) {
        const { fieldId, fileId, statusId, emptyMsg, label, desktopOnly } =
          opts || {};
        const field = fieldId ? $(fieldId) : null;
        if (!field) return;
        if (desktopOnly && currentDevice !== "pc") {
          showMsg(msgMeta, "Switch to Desktop to remove the cursor.", false);
          return;
        }
        field.value = "";
        if (fileId && $(fileId)) $(fileId).value = "";
        if (statusId) setUploadStatus(statusId, "", emptyMsg || "");
        if (!linktreeId) {
          showMsg(msgMeta, "Create the Linktree first", false);
          return;
        }
        try {
          await apiEnsureOrUpdateMeta(true);
          showMsg(msgMeta, `${label || "Upload"} removed`, true);
          await refreshData();
        } catch (e) {
          showMsg(msgMeta, `${label || "Upload"} remove failed`, false);
        }
      }

      $("fileSong").addEventListener("change", async () => {
        try {
          const res = await uploadFile(
            "fileSong",
            `/api/users/me/song?device=${encodeURIComponent(
              currentDevice || "pc"
            )}`
          );
          const url = res?.url || "";
          const name = res?.name || "";
          $("inSong").value = url;
          $("inSongName").value = name;
          setUploadStatus("songStatus", url, "No song uploaded yet.", name);
          showMsg(msgMeta, "Song uploaded", true);
        } catch (e) {
          showMsg(msgMeta, "Song upload failed", false);
        }
      });

      $("btnRemoveSong")?.addEventListener("click", async () => {
        $("inSongName").value = "";
        await removeMetaUpload({
          fieldId: "inSong",
          fileId: "fileSong",
          statusId: "songStatus",
          emptyMsg: "No song uploaded yet.",
          label: "Song",
        });
      });

      $("fileSongIcon").addEventListener("change", async () => {
        try {
          const res = await uploadFile(
            "fileSongIcon",
            `/api/users/me/songicon?device=${encodeURIComponent(
              currentDevice || "pc"
            )}`
          );
          const url = res?.url || "";
          $("inSongIcon").value = url;
          setUploadStatus("songIconStatus", url, "No icon uploaded.");
          showMsg(msgMeta, "Song icon uploaded", true);
        } catch (e) {
          showMsg(msgMeta, "Song icon upload failed", false);
        }
      });

      $("btnRemoveSongIcon")?.addEventListener("click", async () => {
        await removeMetaUpload({
          fieldId: "inSongIcon",
          fileId: "fileSongIcon",
          statusId: "songIconStatus",
          emptyMsg: "No icon uploaded.",
          label: "Song icon",
        });
      });

      $("filePfp").addEventListener("change", async () => {
        try {
          const res = await uploadFile(
            "filePfp",
            `/api/users/me/linktree-pfp?device=${encodeURIComponent(
              currentDevice || "pc"
            )}`
          );
          const url = res?.url || "";
          $("inLinktreePfp").value = url;
          setUploadStatus(
            "pfpStatus",
            url,
            "Using your account profile picture."
          );
          showMsg(msgMeta, "Profile picture uploaded", true);
        } catch (e) {
          showMsg(msgMeta, "Profile picture upload failed", false);
        }
      });

      $("btnRemovePfp")?.addEventListener("click", async () => {
        await removeMetaUpload({
          fieldId: "inLinktreePfp",
          fileId: "filePfp",
          statusId: "pfpStatus",
          emptyMsg: "Using your account profile picture.",
          label: "Profile picture",
        });
      });

      $("fileBg").addEventListener("change", async () => {
        try {
          const res = await fetchUpload(
            "fileBg",
            `/api/users/me/background?device=${encodeURIComponent(
              currentDevice || "pc"
            )}`
          );
          $("inBg").value = res.url;
          setUploadStatus("bgStatus", res.url, "No background uploaded yet.");
          showMsg(msgMeta, "Background uploaded", true);
        } catch (e) {
          showMsg(msgMeta, "Background upload failed", false);
        }
      });

      $("btnRemoveBg")?.addEventListener("click", async () => {
        await removeMetaUpload({
          fieldId: "inBg",
          fileId: "fileBg",
          statusId: "bgStatus",
          emptyMsg: "No background uploaded yet.",
          label: "Background",
        });
      });

      $("fileCursor").addEventListener("change", async () => {
        if (currentDevice !== "pc") {
          showMsg(
            msgMeta,
            "Cursor upload is desktop-only. Switch to Desktop first.",
            false
          );
          $("fileCursor").value = "";
          return;
        }
        try {
          const res = await uploadFile(
            "fileCursor",
            `/api/users/me/cursor?device=${encodeURIComponent(
              currentDevice || "pc"
            )}`
          );
          const url = res?.url || "";
          $("inCursor").value = url;
          setUploadStatus("cursorStatus", url, "No cursor uploaded.");
          showMsg(msgMeta, "Cursor uploaded", true);
        } catch (e) {
          showMsg(msgMeta, "Cursor upload failed", false);
        }
      });

      $("btnRemoveCursor")?.addEventListener("click", async () => {
        await removeMetaUpload({
          fieldId: "inCursor",
          fileId: "fileCursor",
          statusId: "cursorStatus",
          emptyMsg: "No cursor uploaded.",
          label: "Cursor",
          desktopOnly: true,
        });
      });

      $("btnRemoveLinkIcon")?.addEventListener("click", () => {
        $("inLinkIcon").value = "";
        if ($("fileIcon")) $("fileIcon").value = "";
        setUploadStatus("linkIconStatus", "", "No icon uploaded.");
      });

      $("fileIcon").addEventListener("change", async () => {
        try {
          const res = await uploadFile("fileIcon", "/api/users/me/linkicon");
          const url = res?.url || "";
          $("inLinkIcon").value = url;
          setUploadStatus("linkIconStatus", url, "No icon uploaded.");
          showMsg(msgLinks, "Icon uploaded", true);
        } catch (e) {
          showMsg(msgLinks, "Icon upload failed", false);
        }
      });

      // visitor counter (zweites Script, aber harmless)
      (async () => {
        const KEY = "taoma_last_counted_at";
        const DAY = 24 * 60 * 60 * 1000;
        const now = Date.now();
        const last = parseInt(localStorage.getItem(KEY) || "0", 10);
        const shouldCount = !last || now - last > DAY;

        if (shouldCount) {
          navigator.sendBeacon("/api/visits/increment");
          localStorage.setItem(KEY, String(now));
        }

        const res = await fetch("/api/visits/value");
        const { total } = await res.json();
        document.getElementById("visitor-count").textContent =
          total !== undefined && total !== null ? total : "0";
      })();
    </script>
  </body>
</html>
