<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAOMA - Marketplace</title>
    <meta name="description" content="Browse and save Linktree templates." />
    <meta name="theme-color" content="#0f1223" />
    <link rel="icon" type="image/png" href="/static/icon.png" />
    <style>
      /* ==============================
         TAOMA Marketplace – Restyle
         CSS only (keeps IDs/classes/JS)
         ============================== */

      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      :root {
        --bg: #070b16;
        --bg-2: #0b1223;
        --surface: rgba(255, 255, 255, 0.06);
        --card: rgba(255, 255, 255, 0.07);
        --card-2: rgba(255, 255, 255, 0.1);
        --ink: #eef2ff;
        --muted: rgba(238, 242, 255, 0.72);
        --border: rgba(255, 255, 255, 0.14);
        --border-2: rgba(255, 255, 255, 0.22);
        --acc: #2dd4bf; /* teal */
        --acc-2: #60a5fa; /* blue */
        --ok: #22c55e;
        --danger: #fb7185;
        --ring: rgba(45, 212, 191, 0.35);
        --shadow: 0 14px 40px rgba(0, 0, 0, 0.35),
          0 2px 10px rgba(0, 0, 0, 0.24);
        --radius: 18px;
        --space: clamp(16px, 2vw, 24px);
        --container: 1150px;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f8ff;
          --bg-2: #eef2ff;
          --surface: rgba(15, 23, 42, 0.05);
          --card: rgba(15, 23, 42, 0.04);
          --card-2: rgba(15, 23, 42, 0.06);
          --ink: #0b1220;
          --muted: rgba(11, 18, 32, 0.7);
          --border: rgba(11, 18, 32, 0.14);
          --border-2: rgba(11, 18, 32, 0.22);
          --shadow: 0 14px 40px rgba(2, 6, 23, 0.12),
            0 2px 10px rgba(2, 6, 23, 0.06);
          --ring: rgba(45, 212, 191, 0.35);
        }
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font: 15px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Ubuntu, Arial, sans-serif;
        color: var(--ink);
        background: var(--bg);
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        background: radial-gradient(
            1100px 800px at 10% -12%,
            color-mix(in oklab, var(--acc) 20%, transparent) 0%,
            transparent 60%
          ),
          radial-gradient(
            900px 700px at 105% 0%,
            color-mix(in oklab, var(--acc-2) 18%, transparent) 0%,
            transparent 58%
          ),
          radial-gradient(
            1000px 700px at 90% 120%,
            color-mix(in oklab, var(--acc-2) 12%, transparent) 0%,
            transparent 60%
          ),
          linear-gradient(160deg, var(--bg-2) 0%, var(--bg) 70%);
      }

      a {
        color: inherit;
        text-decoration: none;
      }
      img {
        max-width: 100%;
        display: block;
      }

      .container {
        width: min(100%, var(--container));
        margin: 0 auto;
        padding-inline: var(--space);
      }

      header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: saturate(1.1) blur(12px);
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--bg) 86%, transparent) 0%,
          transparent 100%
        );
        border-bottom: 1px solid var(--border);
      }

      .nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 68px;
        gap: 12px;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 900;
        letter-spacing: 0.2px;
      }

      .brand .logo {
        width: 30px;
        height: 30px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
      }

      .links {
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .links a {
        padding: 0.55rem 0.85rem;
        border-radius: 12px;
        border: 1px solid transparent;
        color: color-mix(in oklab, var(--ink) 92%, var(--muted));
        transition: 0.15s ease;
      }

      .links a:hover {
        background: var(--surface);
        border-color: var(--border);
        color: var(--ink);
      }

      .links a[aria-current="page"] {
        background: color-mix(in oklab, var(--acc) 16%, transparent);
        border-color: color-mix(in oklab, var(--acc) 30%, var(--border));
        color: var(--ink);
      }

      .mobile-toggle {
        display: none;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--ink);
        cursor: pointer;
      }

      .auth {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.78rem 1rem;
        border-radius: 14px;
        border: 1px solid color-mix(in oklab, var(--acc) 30%, var(--border));
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--acc) 80%, #ffffff 10%) 0%,
          color-mix(in oklab, var(--acc) 70%, #000000 8%) 100%
        );
        color: #031018;
        font-weight: 800;
        box-shadow: var(--shadow);
        transition: transform 0.15s ease, filter 0.15s ease,
          background 0.15s ease;
        white-space: nowrap;
        cursor: pointer;
      }

      @media (prefers-color-scheme: light) {
        .btn {
          color: #052016;
        }
      }

      .btn:hover {
        transform: translateY(-1px);
        filter: saturate(1.06);
      }
      .btn:active {
        transform: translateY(0px);
      }

      .btn.ghost,
      .btn.small {
        background: transparent;
        color: var(--ink);
        border: 1px solid var(--border);
        box-shadow: none;
      }

      .btn.ghost:hover,
      .btn.small:hover {
        background: var(--surface);
        border-color: var(--border-2);
      }

      .btn.danger {
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--danger) 78%, #fff 8%) 0%,
          color-mix(in oklab, var(--danger) 70%, #000 12%) 100%
        );
        border-color: color-mix(in oklab, var(--danger) 30%, var(--border));
        color: #2b0610;
      }

      .btn.sm {
        padding: 0.55rem 0.8rem;
        border-radius: 12px;
        font-size: 0.92rem;
        font-weight: 800;
      }

      .avatar-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.4rem 0.6rem;
        border-radius: 999px;
        background: var(--surface);
        border: 1px solid var(--border);
        color: var(--ink);
        cursor: pointer;
        transition: 0.15s ease;
      }

      .avatar-btn:hover {
        background: color-mix(in oklab, var(--surface) 70%, transparent);
        border-color: var(--border-2);
      }

      .avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        object-fit: cover;
        display: block;
        background: color-mix(in oklab, var(--bg) 70%, #000);
      }

      .avatar-fallback {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font: 900 12px/1 Inter, ui-sans-serif;
        background: color-mix(in oklab, var(--acc-2) 35%, transparent);
        border: 1px solid var(--border);
      }

      .menu {
        position: absolute;
        right: 0;
        top: calc(100% + 10px);
        min-width: 180px;
        z-index: 60;
        background: color-mix(in oklab, var(--bg) 92%, #000);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 0.35rem;
        display: none;
      }

      .menu.open {
        display: block;
      }

      .menu a,
      .menu button {
        width: 100%;
        text-align: left;
        display: block;
        background: transparent;
        color: var(--ink);
        padding: 0.6rem 0.7rem;
        border: 0;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
      }

      .menu a:hover,
      .menu button:hover {
        background: var(--surface);
      }

      main {
        flex: 1;
        padding-block: clamp(28px, 5vw, 64px);
      }

      .hero {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.75rem;
      }

      .hero h1 {
        font-size: clamp(26px, 4vw, 36px);
        margin: 0;
        letter-spacing: -0.02em;
      }

      .hero p {
        margin: 0;
        color: var(--muted);
        max-width: 70ch;
      }

      .search-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-top: 0.35rem;
      }

      .input,
      .select,
      textarea {
        background: color-mix(in oklab, var(--bg) 72%, #000 8%);
        border: 1px solid var(--border);
        border-radius: 14px;
        color: var(--ink);
        padding: 0.75rem 0.9rem;
        width: min(520px, 100%);
        font: inherit;
        outline: none;
        transition: box-shadow 0.15s ease, border-color 0.15s ease,
          background 0.15s ease;
      }

      .select {
        width: auto;
      }

      .input::placeholder,
      textarea::placeholder {
        color: color-mix(in oklab, var(--muted) 85%, transparent);
      }

      .input:focus,
      .select:focus,
      textarea:focus {
        border-color: color-mix(in oklab, var(--acc) 45%, var(--border));
        box-shadow: 0 0 0 4px var(--ring);
        background: color-mix(in oklab, var(--bg) 78%, #000 6%);
      }

      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        margin-bottom: 1.2rem;
      }

      .tab-btn {
        padding: 0.55rem 0.95rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--ink);
        cursor: pointer;
        font-weight: 800;
        transition: 0.15s ease;
      }

      .tab-btn:hover {
        border-color: var(--border-2);
        background: color-mix(in oklab, var(--surface) 70%, transparent);
      }

      .tab-btn.active {
        background: color-mix(in oklab, var(--acc) 22%, transparent);
        border-color: color-mix(in oklab, var(--acc) 35%, var(--border));
      }

      .grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      }

      .card {
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card) 92%, transparent) 0%,
          color-mix(in oklab, var(--card-2) 92%, transparent) 100%
        );
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 220px;
        transition: transform 0.15s ease, border-color 0.15s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        border-color: var(--border-2);
      }

      .template-top {
        display: flex;
        gap: 0.85rem;
        align-items: center;
      }

      .template-pfp {
        width: 66px;
        height: 66px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: color-mix(in oklab, var(--bg) 70%, #000);
        display: grid;
        place-items: center;
        border: 1px solid var(--border);
      }

      .template-pfp img,
      .template-pfp video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .template-title {
        font-weight: 900;
        font-size: 1rem;
        margin: 0;
      }

      .template-meta {
        font-size: 0.92rem;
        color: var(--muted);
      }

      .chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0.65rem;
        border-radius: 999px;
        background: color-mix(in oklab, var(--acc-2) 14%, transparent);
        border: 1px solid var(--border);
        font-size: 0.82rem;
        font-weight: 800;
        color: color-mix(in oklab, var(--ink) 94%, var(--muted));
      }

      .card-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: auto;
      }

      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }

      .muted {
        color: var(--muted);
      }

      .alert {
        border: 1px solid var(--border);
        background: var(--surface);
        border-radius: 14px;
        padding: 0.7rem 0.9rem;
        width: 100%;
        display: none;
        font-weight: 700;
      }

      .alert.ok {
        border-color: color-mix(in oklab, var(--ok) 40%, var(--border));
        background: color-mix(in oklab, var(--ok) 12%, transparent);
      }

      .alert.err {
        border-color: color-mix(in oklab, var(--danger) 40%, var(--border));
        background: color-mix(in oklab, var(--danger) 10%, transparent);
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 80;
      }

      .modal.open {
        display: flex;
      }

      .modal-card {
        width: min(920px, 100%);
        max-height: 90vh;
        background: color-mix(in oklab, var(--bg) 78%, #000 10%);
        border: 1px solid var(--border);
        border-radius: 22px;
        overflow: hidden;
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        box-shadow: var(--shadow);
      }

      .modal-body {
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
      }

      .modal-body iframe {
        width: 100%;
        height: 100%;
        min-height: 420px;
        border: 0;
        border-radius: 16px;
        background: var(--bg);
      }

      .modal-meta {
        padding: 18px;
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        background: color-mix(in oklab, var(--bg) 82%, #000 6%);
      }

      .modal-meta h2 {
        margin: 0;
        letter-spacing: -0.01em;
      }
      .modal-meta p {
        margin: 0;
        color: var(--muted);
      }

      /* Better keyboard visibility */
      :focus-visible {
        outline: none;
        box-shadow: 0 0 0 4px var(--ring);
        border-color: color-mix(in oklab, var(--acc) 45%, var(--border));
      }

      @media (max-width: 980px) {
        .modal-card {
          grid-template-columns: 1fr;
        }
        .modal-meta {
          border-left: 0;
          border-top: 1px solid var(--border);
        }
      }

      @media (max-width: 820px) {
        .mobile-toggle {
          display: inline-flex;
        }
        .links {
          position: fixed;
          inset: 68px 0 auto 0;
          padding: 1rem var(--space);
          background: linear-gradient(
            180deg,
            color-mix(in oklab, var(--bg) 94%, transparent) 0%,
            color-mix(in oklab, var(--bg) 70%, transparent) 100%
          );
          border-bottom: 1px solid var(--border);
          flex-direction: column;
          align-items: flex-start;
          gap: 0.4rem;
          display: none;
        }
        .links.open {
          display: flex;
        }
      }

      @media (max-width: 640px) {
        .search-row {
          flex-direction: column;
          align-items: stretch;
        }
        .input {
          width: 100%;
        }
        .select {
          width: 100%;
        }
        .template-top {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container nav" role="navigation" aria-label="Primary">
        <div class="brand">
          <a href="/"
            ><img
              class="logo"
              src="/static/icon.png"
              alt="TAOMA logo"
              width="30"
              height="30"
          /></a>
          <a href="/">TAOMA™</a>
        </div>
        <button
          type="button"
          class="mobile-toggle"
          id="mobileToggle"
          aria-controls="primary-menu"
          aria-expanded="false"
          aria-label="Toggle menu"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M4 6H20M4 12H20M4 18H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
        <nav id="primary-menu" class="links" aria-label="Site">
          <a href="/">Home</a>
          <a href="/api">GIF API</a>
          <a href="/api/gif/admin">Add GIFs</a>
          <a href="/marketplace" aria-current="page">Marketplace</a>
          <a href="/linktree/config">Linktree</a>
        </nav>
        <div id="authSlot" class="auth"></div>
      </div>
    </header>

    <main>
      <div class="container">
        <section class="hero">
          <h1>Linktree Marketplace</h1>
          <p>Browse public templates, manage your own, and save favorites.</p>
          <div class="search-row">
            <input
              id="searchInput"
              class="input"
              type="search"
              placeholder="Search templates by name, author, or description"
            />
            <select id="deviceFilter" class="select" style="min-width: 160px">
              <option value="all">All devices</option>
              <option value="pc">Desktop</option>
              <option value="mobile">Mobile</option>
              <option value="both">Desktop + Mobile</option>
            </select>
            <span class="chip" id="resultCount">0 templates</span>
            <a class="btn ghost" href="/marketplace/create">Create template</a>
          </div>
        </section>

        <div class="tabs">
          <button class="tab-btn active" data-tab="public">Templates</button>
          <button class="tab-btn" data-tab="mine">Your Templates</button>
          <button class="tab-btn" data-tab="saved">Saved Templates</button>
        </div>

        <section class="tab-panel active" id="tab-public">
          <div class="grid" id="publicGrid"></div>
        </section>

        <section class="tab-panel" id="tab-mine">
          <div class="grid" id="mineGrid"></div>
        </section>

        <section class="tab-panel" id="tab-saved">
          <div class="grid" id="savedGrid"></div>
        </section>
      </div>
    </main>

    <div class="modal" id="detailModal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-body">
          <iframe
            id="demoFrame"
            title="Template demo"
            allow="autoplay"
          ></iframe>
        </div>
        <div class="modal-meta">
          <button class="btn ghost sm" id="closeModal">Close</button>
          <h2 id="modalTitle"></h2>
          <p id="modalOwner"></p>
          <p id="modalDesc"></p>
          <div class="card-actions" id="modalActions"></div>
        </div>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const escapeHtml = (value) =>
        String(value !== undefined && value !== null ? value : "").replace(
          /[&<>"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch] || ch)
        );

      function sanitizeUrl(raw) {
        if (typeof raw !== "string") return "";
        const trimmed = raw.trim();
        if (!trimmed) return "";
        if (trimmed.startsWith("javascript:")) return "";
        try {
          const u = new URL(trimmed, window.location.origin);
          if (["http:", "https:"].includes(u.protocol)) {
            return trimmed.startsWith("http://") ||
              trimmed.startsWith("https://")
              ? u.href
              : trimmed;
          }
        } catch (_) {
          if (trimmed.startsWith("/") && !trimmed.startsWith("//"))
            return trimmed;
        }
        return "";
      }

      function isVideoUrl(url) {
        return /\.(mp4|mov|webm|m4v|avi|mkv)$/i.test(url || "");
      }

      function hexOrNull(val) {
        const t = (val || "").trim();
        if (!t) return null;
        if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(t)) return t;
        return null;
      }

      function normalizeVariant(raw, deviceFallback) {
        const v = { ...(raw || {}) };
        v.device_type = v.device_type || deviceFallback || "pc";
        v.display_name_mode = v.display_name_mode || "slug";
        if (v.display_name_mode === "custom") {
          if (!v.custom_display_name || !v.custom_display_name.trim()) {
            showMsg(
              formMsg,
              `Custom display name required for ${v.device_type}`,
              false
            );
            return null;
          }
          v.custom_display_name = v.custom_display_name.trim();
        } else {
          v.custom_display_name = null;
        }
        v.link_color = hexOrNull(v.link_color);
        v.link_bg_color = hexOrNull(v.link_bg_color);
        v.card_color = hexOrNull(v.card_color);
        v.text_color = hexOrNull(v.text_color);
        v.name_color = hexOrNull(v.name_color);
        v.location_color = hexOrNull(v.location_color);
        v.quote_color = hexOrNull(v.quote_color);
        v.visit_counter_color = hexOrNull(v.visit_counter_color);
        v.visit_counter_bg_color = hexOrNull(v.visit_counter_bg_color);
        v.show_audio_player = !!v.show_audio_player;
        v.discord_presence_enabled = !!v.discord_presence_enabled;
        v.discord_presence =
          (v.discord_presence || "online").toString().toLowerCase();
        v.discord_status_enabled = !!v.discord_status_enabled;
        v.discord_status_text = v.discord_status_text
          ? String(v.discord_status_text).trim()
          : null;
        v.discord_badges_enabled = !!v.discord_badges_enabled;
        v.link_bg_alpha = Math.min(
          100,
          Math.max(0, parseInt(v.link_bg_alpha ?? 100, 10))
        );
        v.transparency = Math.min(
          100,
          Math.max(0, parseInt(v.transparency ?? 0, 10))
        );
        v.visit_counter_bg_alpha = Math.min(
          100,
          Math.max(0, parseInt(v.visit_counter_bg_alpha ?? 20, 10))
        );
        v.background_url = (v.background_url || "").trim();
        if (!v.background_url) {
          showMsg(
            formMsg,
            `Background URL required for ${v.device_type}`,
            false
          );
          return null;
        }
        return v;
      }

      async function fetchSession() {
        try {
          const r = await fetch("/api/auth/verify", {
            credentials: "include",
          });
          if (!r.ok) return null;
          return await r.json();
        } catch (_) {
          return null;
        }
      }

      async function renderAuthHeader() {
        const slot = $("authSlot");
        if (!slot) return null;
        const session = await fetchSession();
        const user = session && session.user ? session.user : null;
        const isAdmin = !!(user && user.admin);
        currentUser = user;
        if (!user) {
          slot.innerHTML = `<a class="btn small" href="/login?next=${encodeURIComponent(
            location.href
          )}">Login</a>
          <a class="btn small" href="/register?next=${encodeURIComponent(
            location.href
          )}">Register</a>`;
          return null;
        }
        const uname = user.username || "User";
        const initials = uname.trim().slice(0, 2).toUpperCase();
        const pfp = sanitizeUrl(
          user.profile_picture ? String(user.profile_picture) : ""
        );
        slot.innerHTML = `
        <div class="auth-box" style="position:relative">
          <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false">
            ${
              pfp
                ? `<img class="avatar" src="${pfp}" alt="${escapeHtml(
                    uname
                  )}'s profile picture">`
                : `<span class="avatar-fallback" aria-hidden="true">${escapeHtml(
                    initials
                  )}</span>`
            }
            <span class="uname" style="font-weight:700;font-size:.95rem">${escapeHtml(
              uname
            )}</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="menu" id="userMenu" role="menu">
            <a href="/profile" role="menuitem">Profile</a>
            ${isAdmin ? `<a href="/admin" role="menuitem">Admin</a>` : ``}
            <button id="logoutBtnHdr" role="menuitem">Logout</button>
          </div>
        </div>`;

        const btn = slot.querySelector("#avatarBtn");
        const m = slot.querySelector("#userMenu");
        const lo = slot.querySelector("#logoutBtnHdr");

        function close() {
          m.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
        }

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = m.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
        document.addEventListener("click", (e) => {
          if (!m.contains(e.target) && !btn.contains(e.target)) close();
        });
        lo.addEventListener(
          "click",
          async () => {
            try {
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "include",
              });
            } catch {}
            location.href = "/";
          },
          { passive: true }
        );
        return user;
      }

      let currentUser = null;
      let publicTemplates = [];
      let myTemplates = [];
      let savedTemplates = [];
      let savedIds = new Set();
      let editingId = null;
      let variantCache = { pc: null, mobile: null };

      const resultCount = $("resultCount");
      const formMsg = $("formMsg");

      function showMsg(el, text, ok = false) {
        if (!el) {
          alert(text);
          return;
        }
        el.textContent = text;
        el.className = "alert " + (ok ? "ok" : "err");
        el.style.display = "block";
        setTimeout(() => (el.style.display = "none"), 3500);
      }

      function headers() {
        return { "Content-Type": "application/json" };
      }

      async function apiGet(url) {
        const r = await fetch(url, { credentials: "include" });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiPost(url, body) {
        const r = await fetch(url, {
          method: "POST",
          headers: headers(),
          credentials: "include",
          body: body ? JSON.stringify(body) : null,
        });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiPatch(url, body) {
        const r = await fetch(url, {
          method: "PATCH",
          headers: headers(),
          credentials: "include",
          body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiDelete(url) {
        const r = await fetch(url, {
          method: "DELETE",
          headers: headers(),
          credentials: "include",
        });
        if (!r.ok && r.status !== 204) throw new Error(await r.text());
      }

      function matchesSearch(item, term, deviceFilterVal) {
        if (deviceFilterVal && deviceFilterVal !== "all") {
          if ((item.device_type || "pc") !== deviceFilterVal) return false;
        }
        if (!term) return true;
        const hay = `${item.name || ""} ${item.description || ""} ${
          item.owner_username || ""
        } ${item.creator || ""} ${item.device_type || ""}`.toLowerCase();
        return hay.includes(term.toLowerCase());
      }
      function renderTemplates(list, container, opts = {}) {
        container.innerHTML = "";
        const term = $("searchInput").value.trim();
        const deviceVal = $("deviceFilter").value || "all";
        const filtered = list.filter((item) =>
          matchesSearch(item, term, deviceVal)
        );
        filtered.forEach((item) => {
          const card = document.createElement("div");
          card.className = "card";
          const previewRaw = sanitizeUrl(item.preview_image_url) || "";
          const preview =
            previewRaw && isVideoUrl(previewRaw)
              ? previewRaw
              : previewRaw || "/static/icon.png";
          const previewIsVideo = isVideoUrl(preview);
          const isSaved = savedIds.has(item.id);
          const deviceLabel =
            item.device_type === "both"
              ? "Desktop + Mobile"
              : item.device_type === "mobile"
              ? "Mobile"
              : "Desktop";
          const ownerAvatar =
            sanitizeUrl(item.owner_profile_picture || "") || "/static/icon.png";
          card.innerHTML = `
            <div class="template-top">
              <div class="template-pfp">
                ${
                  previewIsVideo
                    ? `<video data-preview-video src="${preview}" muted playsinline preload="auto" aria-label="${escapeHtml(
                        item.name
                      )} preview"></video>`
                    : `<img src="${preview}" alt="${escapeHtml(
                        item.name
                      )} preview" />`
                }
              </div>
              <div>
                <p class="template-title">${escapeHtml(item.name)}</p>
                <div class="template-meta">
                  <span style="display:inline-flex;align-items:center;gap:.45rem">
                    <img src="${ownerAvatar}" alt="avatar" style="width:22px;height:22px;border-radius:50%;object-fit:cover;border:1px solid #ffffff22">
                    by ${escapeHtml(
                      item.creator || item.owner_username || "unknown"
                    )}
                  </span>
                </div>
              </div>
            </div>
            <div class="template-meta">${escapeHtml(
              item.description || "No description yet."
            )}</div>
            <div class="row" style="display:flex;gap:.5rem;flex-wrap:wrap">
              <span class="chip">${item.is_public ? "Public" : "Private"}</span>
              <span class="chip">${deviceLabel}</span>
            </div>
            <div class="card-actions">
              <button class="btn sm ghost" data-act="demo">Live demo</button>
              <button class="btn sm" data-act="use">Use template</button>
              <a class="btn sm ghost" data-demo-link data-device="${
                item.device_type || "pc"
              }" href="${buildDemoUrl(
            item,
            item.device_type
          )}" target="_blank" rel="noopener">Demo link</a>
              ${
                opts.allowSave
                  ? `<button class="btn sm ghost" data-act="save">${
                      isSaved ? "Saved" : "Save"
                    }</button>`
                  : ""
              }
              ${
                opts.allowEdit
                  ? `<a class="btn sm ghost" href="/marketplace/create?template_id=${encodeURIComponent(
                      item.id
                    )}">Edit template</a>
                     <button class="btn sm danger" data-act="delete">Delete</button>`
                  : ""
              }
            </div>
          `;

          card
            .querySelector('[data-act="demo"]')
            .addEventListener("click", () => openModal(item));
          card
            .querySelector('[data-act="use"]')
            .addEventListener("click", () => useTemplate(item));
          const saveBtn = card.querySelector('[data-act="save"]');
          if (saveBtn) {
            saveBtn.addEventListener("click", () => toggleSave(item, saveBtn));
          }
          const editBtn = card.querySelector('[data-act="edit"]');
          if (editBtn) {
            editBtn.addEventListener("click", () => startEdit(item));
          }
          const delBtn = card.querySelector('[data-act="delete"]');
          if (delBtn) {
            delBtn.addEventListener("click", () => deleteTemplate(item));
          }

          container.appendChild(card);
        });
        return filtered.length;
      }

      function renderAll() {
        const publicCount = renderTemplates(publicTemplates, $("publicGrid"), {
          allowSave: true,
        });
        renderTemplates(myTemplates, $("mineGrid"), { allowEdit: true });
        renderTemplates(savedTemplates, $("savedGrid"), { allowSave: true });
        resultCount.textContent = `${publicCount} templates`;
      }

      async function loadTemplates() {
        publicTemplates = await apiGet("/api/marketplace/templates");
        myTemplates = await apiGet("/api/marketplace/templates/mine");
        savedTemplates = await apiGet("/api/marketplace/templates/saved");
        savedIds = new Set(savedTemplates.map((t) => t.id));
        renderAll();
      }

      async function toggleSave(item, btn) {
        try {
          if (savedIds.has(item.id)) {
            await apiDelete(`/api/marketplace/templates/${item.id}/save`);
            savedIds.delete(item.id);
          } else {
            await apiPost(`/api/marketplace/templates/${item.id}/save`);
            savedIds.add(item.id);
          }
          savedTemplates = await apiGet("/api/marketplace/templates/saved");
          if (btn) {
            btn.textContent = savedIds.has(item.id) ? "Saved" : "Save";
          }
          renderAll();
        } catch (e) {
          alert("Save failed");
        }
      }

      function deviceLabel(device) {
        return device === "both"
          ? "Desktop + Mobile"
          : device === "mobile"
          ? "Mobile"
          : "Desktop";
      }

      function buildDemoUrl(item, device) {
        const dRaw = device || item.device_type || "pc";
        const d = dRaw === "both" ? "pc" : dRaw;
        const url = new URL(
          `/marketplace/templates/${encodeURIComponent(item.id)}/demo`,
          window.location.origin
        );
        url.searchParams.set("template_id", item.id);
        if (d) url.searchParams.set("device", d);
        return url.toString();
      }

      function openDemoWindow(url, device = "pc") {
        const features =
          device === "mobile"
            ? "width=430,height=900,menubar=0,toolbar=0,location=0,status=0"
            : "width=1280,height=900";
        const w = window.open(url, "_blank", features);
        if (!w) location.href = url;
      }

      function useTemplate(item, deviceOverride) {
        const sourceDevice = deviceOverride || item.device_type || "pc";
        const target =
          sourceDevice === "both"
            ? "both"
            : sourceDevice === "mobile"
            ? "mobile"
            : "pc";
        const label =
          target === "both"
            ? "Desktop and Mobile"
            : target === "mobile"
            ? "Mobile"
            : "Desktop";
        const ok = confirm(
          `Are you sure? This will replace your ${label} Linktree appearance (links and icons stay unchanged).`
        );
        if (!ok) return;
        location.href = `/linktree/config?template_id=${encodeURIComponent(
          item.id
        )}&device=${encodeURIComponent(target)}`;
      }

      function openModal(item) {
        const modal = $("detailModal");
        const frame = $("demoFrame");
        const actions = $("modalActions");
        $("modalTitle").textContent = item.name || "Template";
        $("modalOwner").textContent = `by ${
          item.creator || item.owner_username || "unknown"
        }`;
        $("modalDesc").textContent = item.description || "";
        let demoDevice =
          item.device_type === "mobile"
            ? "mobile"
            : item.device_type === "both"
            ? "pc"
            : "pc";
        frame.src = buildDemoUrl(item, demoDevice);
        actions.innerHTML = "";
        let demoLink = null;
        if (item.device_type === "both") {
          const toggleWrap = document.createElement("div");
          toggleWrap.className = "row";
          toggleWrap.style.marginBottom = "8px";
          ["pc", "mobile"].forEach((dev) => {
            const btn = document.createElement("button");
            btn.className = "btn sm ghost";
            btn.textContent =
              dev === "pc" ? "Desktop preview" : "Mobile preview";
            btn.addEventListener("click", () => {
              demoDevice = dev;
              frame.src = buildDemoUrl(item, demoDevice);
              if (demoLink) {
                demoLink.href = buildDemoUrl(item, demoDevice);
                demoLink.dataset.device = demoDevice;
              }
            });
            toggleWrap.appendChild(btn);
          });
          actions.appendChild(toggleWrap);
        }
        const useBtn = document.createElement("button");
        useBtn.className = "btn sm";
        useBtn.textContent = "Use template";
        useBtn.addEventListener("click", () =>
          useTemplate(item, item.device_type)
        );
        actions.appendChild(useBtn);
        const saveBtn = document.createElement("button");
        saveBtn.className = "btn sm ghost";
        saveBtn.textContent = savedIds.has(item.id) ? "Saved" : "Save";
        saveBtn.addEventListener("click", () => toggleSave(item, saveBtn));
        actions.appendChild(saveBtn);
        demoLink = document.createElement("a");
        demoLink.className = "btn sm ghost";
        demoLink.href = buildDemoUrl(item, demoDevice);
        demoLink.target = "_blank";
        demoLink.rel = "noopener";
        demoLink.textContent = "Open demo link";
        demoLink.dataset.demoLink = "1";
        demoLink.dataset.device = demoDevice;
        actions.appendChild(demoLink);
        modal.classList.add("open");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        const modal = $("detailModal");
        const frame = $("demoFrame");
        frame.src = "";
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
      }
      async function loadLinktreeData() {
        if (!currentUser || !currentUser.linktree_slug) {
          showMsg(formMsg, "Create a Linktree first", false);
          return null;
        }
        const device = $("tplDevice").value || "pc";
        try {
          const lt = await apiGet(
            `/api/linktrees/by-slug/${encodeURIComponent(
              currentUser.linktree_slug
            )}/manage?device=${encodeURIComponent(device)}`
          );
          const data = {
            device_type: device,
            location: lt.location || "",
            quote: lt.quote || "",
            song_url: lt.song_url || "",
            show_audio_player: !!lt.show_audio_player,
            background_url: lt.background_url || "",
            background_is_video: !!lt.background_is_video,
            transparency: lt.transparency ?? 0,
            name_effect: lt.name_effect || "none",
            background_effect: lt.background_effect || "none",
            display_name_mode: lt.display_name_mode || "slug",
            custom_display_name: lt.custom_display_name || "",
            link_color: lt.link_color || "",
            link_bg_color: lt.link_bg_color || "",
            link_bg_alpha: lt.link_bg_alpha ?? 100,
            card_color: lt.card_color || "",
            text_color: lt.text_color || "",
            name_color: lt.name_color || "",
            location_color: lt.location_color || "",
            quote_color: lt.quote_color || "",
            cursor_url: lt.cursor_url || "",
            discord_frame_enabled: !!lt.discord_frame_enabled,
            discord_presence_enabled: !!lt.discord_presence_enabled,
            discord_presence: lt.discord_presence || "online",
            discord_status_enabled: !!lt.discord_status_enabled,
            discord_status_text: lt.discord_status_text || "",
            discord_badges_enabled: !!lt.discord_badges_enabled,
            show_visit_counter: !!lt.show_visit_counter,
            visit_counter_color: lt.visit_counter_color || "",
            visit_counter_bg_color: lt.visit_counter_bg_color || "",
            visit_counter_bg_alpha: lt.visit_counter_bg_alpha ?? 20,
          };
          variantCache[device] = { ...data };
          $("tplLocation").value = data.location;
          $("tplQuote").value = data.quote;
          $("tplSong").value = data.song_url;
          $("tplAudioPlayer").value = data.show_audio_player ? "true" : "false";
          $("tplBackground").value = data.background_url;
          $("tplBgVideo").value = data.background_is_video ? "true" : "false";
          $("tplTrans").value = data.transparency;
          $("tplNameFx").value = data.name_effect;
          $("tplBgFx").value = data.background_effect;
          $("tplDisplayName").value = data.display_name_mode;
          $("tplCustomName").value = data.custom_display_name;
          $("tplLinkColor").value = data.link_color;
          $("tplLinkBgColor").value = data.link_bg_color;
          $("tplLinkBgAlpha").value = data.link_bg_alpha;
          $("tplCardColor").value = data.card_color;
          $("tplTextColor").value = data.text_color;
          $("tplNameColor").value = data.name_color;
          $("tplLocationColor").value = data.location_color;
          $("tplQuoteColor").value = data.quote_color;
          $("tplCursorUrl").value = data.cursor_url;
          $("tplDiscordFrame").value = data.discord_frame_enabled
            ? "true"
            : "false";
          $("tplDiscordPresence").value = data.discord_presence_enabled
            ? "true"
            : "false";
          $("tplDiscordPresenceValue").value = data.discord_presence || "online";
          $("tplDiscordStatusLine").value = data.discord_status_enabled
            ? "true"
            : "false";
          $("tplDiscordStatusText").value = data.discord_status_text || "";
          $("tplDiscordBadges").value = data.discord_badges_enabled
            ? "true"
            : "false";
          $("tplShowCounter").value = data.show_visit_counter
            ? "true"
            : "false";
          $("tplCounterColor").value = data.visit_counter_color;
          $("tplCounterBgColor").value = data.visit_counter_bg_color;
          $("tplCounterBgAlpha").value = data.visit_counter_bg_alpha;
          showMsg(formMsg, "Linktree loaded", true);
          return data;
        } catch (e) {
          showMsg(formMsg, "Load failed", false);
          return null;
        }
      }

      function resetForm() {
        editingId = null;
        variantCache = { pc: null, mobile: null };
        $("formTitle").textContent = "Create Template";
        $("tplName").value = "";
        $("tplCreator").value = currentUser ? currentUser.username || "" : "";
        $("tplDesc").value = "";
        $("tplMode").value = "pc";
        $("tplDevice").value = "pc";
        $("tplPublic").value = "true";
        $("tplLocation").value = "";
        $("tplQuote").value = "";
        $("tplSong").value = "";
        $("tplAudioPlayer").value = "false";
        $("tplBackground").value = "";
        $("tplBgVideo").value = "false";
        $("tplTrans").value = "0";
        $("tplNameFx").value = "none";
        $("tplBgFx").value = "none";
        $("tplDisplayName").value = "slug";
        $("tplCustomName").value = "";
        $("tplLinkColor").value = "";
        $("tplLinkBgColor").value = "";
        $("tplLinkBgAlpha").value = "100";
        $("tplCardColor").value = "";
        $("tplTextColor").value = "";
        $("tplNameColor").value = "";
        $("tplLocationColor").value = "";
        $("tplQuoteColor").value = "";
        $("tplCursorUrl").value = "";
        $("tplDiscordFrame").value = "false";
        $("tplDiscordPresence").value = "false";
        $("tplDiscordPresenceValue").value = "online";
        $("tplDiscordStatusLine").value = "false";
        $("tplDiscordStatusText").value = "";
        $("tplDiscordBadges").value = "false";
        $("tplShowCounter").value = "false";
        $("tplCounterColor").value = "";
        $("tplCounterBgColor").value = "";
        $("tplCounterBgAlpha").value = "20";
      }

      async function startEdit(item) {
        try {
          const detail = await apiGet(`/api/marketplace/templates/${item.id}`);
          editingId = item.id;
          $("formTitle").textContent = "Edit Template";
          $("tplName").value = detail.name || "";
          $("tplCreator").value = detail.creator || detail.owner_username || "";
          $("tplDesc").value = detail.description || "";
          $("tplPreview").value = detail.preview_image_url || "";
          $("tplPublic").value = detail.is_public ? "true" : "false";
          const variants = detail.variants || [];
          variantCache = { pc: null, mobile: null };
          variants.forEach((v) => {
            if (v.device_type === "pc" || v.device_type === "mobile") {
              variantCache[v.device_type] = v;
            }
          });
          const mode =
            variants.length === 2
              ? "both"
              : variants[0] && variants[0].device_type
              ? variants[0].device_type
              : "pc";
          $("tplMode").value = mode;
          const activeVariant =
            mode === "both"
              ? variantCache.pc || variantCache.mobile || {}
              : variantCache[mode] || {};
          $("tplDevice").value = activeVariant.device_type || "pc";
          $("tplLocation").value = activeVariant.location || "";
          $("tplQuote").value = activeVariant.quote || "";
          $("tplSong").value = activeVariant.song_url || "";
          $("tplAudioPlayer").value = activeVariant.show_audio_player
            ? "true"
            : "false";
          $("tplBackground").value = activeVariant.background_url || "";
          $("tplBgVideo").value = activeVariant.background_is_video
            ? "true"
            : "false";
          $("tplTrans").value =
            activeVariant.transparency !== undefined &&
            activeVariant.transparency !== null
              ? activeVariant.transparency
              : 0;
          $("tplNameFx").value = activeVariant.name_effect || "none";
          $("tplBgFx").value = activeVariant.background_effect || "none";
          $("tplDisplayName").value = activeVariant.display_name_mode || "slug";
          $("tplCustomName").value = activeVariant.custom_display_name || "";
          $("tplLinkColor").value = activeVariant.link_color || "";
          $("tplLinkBgColor").value = activeVariant.link_bg_color || "";
          $("tplLinkBgAlpha").value =
            activeVariant.link_bg_alpha !== undefined &&
            activeVariant.link_bg_alpha !== null
              ? activeVariant.link_bg_alpha
              : 100;
          $("tplCardColor").value = activeVariant.card_color || "";
          $("tplTextColor").value = activeVariant.text_color || "";
          $("tplNameColor").value = activeVariant.name_color || "";
          $("tplLocationColor").value = activeVariant.location_color || "";
          $("tplQuoteColor").value = activeVariant.quote_color || "";
          $("tplCursorUrl").value = activeVariant.cursor_url || "";
          $("tplDiscordFrame").value = activeVariant.discord_frame_enabled
            ? "true"
            : "false";
          $("tplDiscordPresence").value = activeVariant.discord_presence_enabled
            ? "true"
            : "false";
          $("tplDiscordPresenceValue").value =
            activeVariant.discord_presence || "online";
          $("tplDiscordStatusLine").value = activeVariant.discord_status_enabled
            ? "true"
            : "false";
          $("tplDiscordStatusText").value =
            activeVariant.discord_status_text || "";
          $("tplDiscordBadges").value = activeVariant.discord_badges_enabled
            ? "true"
            : "false";
          $("tplShowCounter").value = activeVariant.show_visit_counter
            ? "true"
            : "false";
          $("tplCounterColor").value = activeVariant.visit_counter_color || "";
          $("tplCounterBgColor").value =
            activeVariant.visit_counter_bg_color || "";
          $("tplCounterBgAlpha").value =
            activeVariant.visit_counter_bg_alpha !== undefined &&
            activeVariant.visit_counter_bg_alpha !== null
              ? activeVariant.visit_counter_bg_alpha
              : 20;
          showMsg(formMsg, "Loaded for editing", true);
        } catch (e) {
          showMsg(formMsg, "Edit load failed", false);
        }
      }

      async function deleteTemplate(item) {
        if (!confirm(`Delete template ${item.name}?`)) return;
        try {
          await apiDelete(`/api/marketplace/templates/${item.id}`);
          await loadTemplates();
        } catch (e) {
          alert("Delete failed");
        }
      }

      async function saveTemplate() {
        const name = $("tplName").value.trim();
        if (!name) {
          showMsg(formMsg, "Name required", false);
          return;
        }
        const desc = $("tplDesc").value.trim();
        const creator = $("tplCreator").value.trim();
        const mode = $("tplMode").value || "pc";

        const buildVariantFromForm = (device) => {
          const displayMode = $("tplDisplayName").value || "slug";
          const customName = $("tplCustomName").value.trim();
          if (displayMode === "custom" && !customName) {
            showMsg(
              formMsg,
              "Custom display name is required when mode is Custom",
              false
            );
            return null;
          }
          const v = {
            device_type: device,
            location: $("tplLocation").value.trim() || "",
            quote: $("tplQuote").value.trim() || "",
            song_url: $("tplSong").value.trim() || "",
            show_audio_player: $("tplAudioPlayer").value === "true",
            background_url: $("tplBackground").value.trim(),
            background_is_video: $("tplBgVideo").value === "true",
            transparency: Math.min(
              100,
              Math.max(0, parseInt($("tplTrans").value || "0", 10))
            ),
            name_effect: $("tplNameFx").value || "none",
            background_effect: $("tplBgFx").value || "none",
            display_name_mode: displayMode,
            custom_display_name: displayMode === "custom" ? customName : null,
            link_color: hexOrNull($("tplLinkColor").value),
            link_bg_color: hexOrNull($("tplLinkBgColor").value),
            link_bg_alpha: Math.min(
              100,
              Math.max(0, parseInt($("tplLinkBgAlpha").value || "100", 10))
            ),
            card_color: hexOrNull($("tplCardColor").value),
            text_color: hexOrNull($("tplTextColor").value),
            name_color: hexOrNull($("tplNameColor").value),
            location_color: hexOrNull($("tplLocationColor").value),
            quote_color: hexOrNull($("tplQuoteColor").value),
            cursor_url: $("tplCursorUrl").value.trim() || null,
            discord_frame_enabled: $("tplDiscordFrame").value === "true",
            discord_presence_enabled: $("tplDiscordPresence").value === "true",
            discord_presence: $("tplDiscordPresenceValue").value || "online",
            discord_status_enabled: $("tplDiscordStatusLine").value === "true",
            discord_status_text: $("tplDiscordStatusText").value.trim() || null,
            discord_badges_enabled: $("tplDiscordBadges").value === "true",
            show_visit_counter: $("tplShowCounter").value === "true",
            visit_counter_color: hexOrNull($("tplCounterColor").value),
            visit_counter_bg_color: hexOrNull($("tplCounterBgColor").value),
            visit_counter_bg_alpha: Math.min(
              100,
              Math.max(0, parseInt($("tplCounterBgAlpha").value || "20", 10))
            ),
          };
          return normalizeVariant(v, device);
        };

        // Always update cache for the currently selected device
        const currentDevice = $("tplDevice").value || "pc";
        const currentVariant = buildVariantFromForm(currentDevice);
        if (!currentVariant) return;
        variantCache[currentDevice] = currentVariant;

        let variants = [];
        if (mode === "both") {
          const normPc = normalizeVariant(variantCache.pc, "pc");
          const normMob = normalizeVariant(variantCache.mobile, "mobile");
          if (!normPc || !normMob) return;
          variants = [normPc, normMob];
        } else if (mode === "pc" || mode === "mobile") {
          const norm = normalizeVariant(currentVariant, currentDevice);
          if (!norm) return;
          variants = [norm];
        } else {
          showMsg(formMsg, "Invalid template scope", false);
          return;
        }

        const payload = {
          name,
          description: desc || null,
          creator: creator || currentUser?.username || null,
          preview_image_url: null, // backend uses background
          is_public: $("tplPublic").value === "true",
          variants,
        };
        try {
          if (editingId) {
            await apiPatch(`/api/marketplace/templates/${editingId}`, payload);
            showMsg(formMsg, "Template updated", true);
          } else {
            await apiPost("/api/marketplace/templates", payload);
            showMsg(formMsg, "Template created", true);
          }
          resetForm();
          await loadTemplates();
        } catch (e) {
          showMsg(formMsg, `Save failed: ${e.message || e}`, false);
        }
      }

      function wireTabs() {
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".tab-btn")
              .forEach((b) => b.classList.remove("active"));
            document
              .querySelectorAll(".tab-panel")
              .forEach((p) => p.classList.remove("active"));
            btn.classList.add("active");
            $("tab-" + btn.dataset.tab).classList.add("active");
          });
        });
      }

      async function boot() {
        const user = await renderAuthHeader();
        if (!user) {
          $("publicGrid").innerHTML =
            '<div class="muted">Please log in to view the marketplace.</div>';
          return;
        }
        wireTabs();
        $("searchInput").addEventListener("input", renderAll);
        $("deviceFilter").addEventListener("change", renderAll);
        $("closeModal").addEventListener("click", closeModal);
        $("detailModal").addEventListener("click", (e) => {
          if (e.target.id === "detailModal") closeModal();
        });
        await loadTemplates();
        document.addEventListener("click", (e) => {
          const a = e.target.closest("[data-demo-link]");
          if (!a) return;
          e.preventDefault();
          const dev = a.dataset.device || "pc";
          openDemoWindow(a.href, dev);
        });
        document.addEventListener(
          "loadeddata",
          (e) => {
            const v = e.target;
            if (!v || !v.dataset || !v.dataset.previewVideo) return;
            try {
              v.currentTime = 0.01;
            } catch (_) {}
          },
          true
        );
        document.addEventListener(
          "seeked",
          (e) => {
            const v = e.target;
            if (!v || !v.dataset || !v.dataset.previewVideo) return;
            v.pause();
            try {
              v.currentTime = 0.01;
            } catch (_) {}
          },
          true
        );
      }

      const navToggle = $("navToggle");
      const navLinks = $("navLinks");
      navToggle?.addEventListener("click", () => {
        navLinks?.classList.toggle("open");
      });

      boot();
      const toggle = document.getElementById("mobileToggle");
      const menu = document.getElementById("primary-menu");
      toggle?.addEventListener("click", () => {
        const open = menu.classList.toggle("open");
        toggle.setAttribute("aria-expanded", String(open));
      });
    </script>
  </body>
</html>
