<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Anime GIF API - Admin</title>
    <link rel="icon" type="image/png" href="/static/icon.png" />
    <style>
      :root {
        --bg: #0e1020;
        --bg-soft: #141735;
        --card: #171b3b;
        --ink: #e9ebff;
        --muted: #a2a9c8;
        --acc: #85a3ff;
        --acc-2: #5b7bff;
        --ok: #35d79c;
        --danger: #ff5a6a;
        --ring: #85a3ff55;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35), 0 2px 8px rgba(0, 0, 0, 0.25);
        --radius: 16px;
        --space: clamp(16px, 2vw, 24px);
        --container: 1100px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font: 15px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Ubuntu, Arial, sans-serif;
        color: var(--ink);
        background: var(--bg);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        z-index: -1;
        pointer-events: none;
        background: radial-gradient(
            1400px 900px at 12% -8%,
            #1b1f45 0%,
            #1b1f45 35%,
            transparent 72%
          ),
          radial-gradient(
            1200px 700px at 80% 20%,
            #111533 0%,
            #111533 32%,
            transparent 60%
          ),
          linear-gradient(135deg, #0e1020 0%, #0b0d1c 100%);
      }

      header {
        position: sticky;
        top: 0;
        z-index: 50;
        backdrop-filter: saturate(1.1) blur(10px);
        background: linear-gradient(180deg, #0c0f24cc 0%, #0c0f2400 100%);
        border-bottom: 1px solid #ffffff14;
      }

      .container {
        width: min(100%, var(--container));
        margin: 0 auto;
        padding: 0 var(--space);
      }

      .nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 64px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 800;
        letter-spacing: 0.4px;
      }

      .brand .logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: block;
      }

      .links {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .links a {
        padding: 0.45rem 0.7rem;
        border-radius: 10px;
        border: 1px solid transparent;
        color: var(--ink);
        text-decoration: none;
      }

      .links a:hover {
        border-color: #ffffff1f;
        background: #ffffff0f;
      }

      .mobile-toggle {
        display: none;
        background: transparent;
        border: 1px solid #ffffff26;
        border-radius: 10px;
        width: 40px;
        height: 40px;
        align-items: center;
        justify-content: center;
        color: var(--ink);
      }

      @media (max-width: 800px) {
        .mobile-toggle {
          display: inline-flex;
        }

        .links {
          position: fixed;
          inset: 64px 0 auto 0;
          background: linear-gradient(180deg, #0b0f29, #0b0f2945);
          padding: 1rem;
          display: none;
          flex-direction: column;
        }

        .links.open {
          display: flex;
        }
      }

      footer {
        border-top: 1px solid #ffffff14;
        padding-block: 24px;
        margin-top: auto;
      }

      footer a {
        color: inherit;
        text-decoration: none;
        font-weight: 700;
      }

      footer a:hover {
        text-decoration: underline;
      }

      .foot {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .social {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }

      .social a {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        border: 1px solid #ffffff26;
        color: var(--ink);
      }

      .auth {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .auth .btn.small {
        padding: 0.5rem 0.7rem;
        border-radius: 10px;
        background: transparent;
        color: var(--ink);
        border: 1px solid #ffffff26;
        box-shadow: none;
        font-weight: 600;
      }

      .avatar-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.55rem;
        border-radius: 999px;
        background: #ffffff10;
        border: 1px solid #ffffff26;
        cursor: pointer;
      }

      .avatar {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        object-fit: cover;
        display: block;
        background: #0f1331;
      }

      .avatar-fallback {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font: 700 12px/1 Inter, ui-sans-serif;
        background: #25306a;
        color: #e9ebff;
      }

      .menu {
        position: absolute;
        margin-top: 0.4rem;
        right: 0;
        min-width: 160px;
        z-index: 60;
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card), transparent 8%),
          var(--card)
        );
        border: 1px solid #ffffff22;
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 0.35rem;
        display: none;
      }

      .menu.open {
        display: block;
      }

      .menu a,
      .menu button {
        all: unset;
        display: block;
        padding: 0.6rem 0.7rem;
        border-radius: 10px;
        color: var(--ink);
        cursor: pointer;
      }

      .menu a:hover,
      .menu button:hover,
      .menu a:focus-visible,
      .menu button:focus-visible {
        background: #ffffff12;
      }

      main {
        width: min(100%, var(--container));
        margin: 0 auto;
        padding: clamp(16px, 4vw, 28px);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      h1 {
        margin: 12px 0 4px;
        font-size: clamp(26px, 4vw, 34px);
      }

      h2 {
        margin: 0 0 10px;
      }

      p,
      .muted {
        color: var(--muted);
        margin: 0 0 8px;
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      label {
        color: var(--ink);
        font-size: 14px;
        font-weight: 700;
        margin: 8px 0 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      input[type="text"],
      input[type="url"],
      input[type="number"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        background: #0e1330;
        color: var(--ink);
        outline: none;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--acc);
        box-shadow: 0 0 0 4px var(--ring);
      }

      .btn {
        cursor: pointer;
        background: linear-gradient(120deg, var(--acc), var(--acc-2));
        color: #080b1d;
        border: none;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 800;
      }

      .btn.secondary {
        background: #25305e;
        color: #cfe0ff;
      }

      .btn.danger {
        background: #33161f;
        color: #f8c0c9;
        border: 1px solid #ff5a6a55;
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      @media (min-width: 900px) {
        .grid.two {
          grid-template-columns: 1.2fr 1fr;
        }
      }

      .pill {
        display: inline-block;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #0b1030;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #c7cffd;
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .chip {
        background: #0b1030;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #c7cffd;
        padding: 6px 10px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .chip button {
        all: unset;
        cursor: pointer;
        font-weight: 800;
        opacity: 0.8;
      }

      .preview {
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }

      .preview img {
        max-width: 260px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .status {
        margin-top: 10px;
        font-size: 14px;
      }

      .status.ok {
        color: var(--ok);
      }

      .status.err {
        color: var(--danger);
      }

      .table-rows {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      code {
        background: #0b1030;
        color: #cfe0ff;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .badge {
        background: #1f2449;
        color: #cfe0ff;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 6px 10px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
      }

      .section-title {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      :focus-visible {
        outline: 2px solid var(--acc);
        outline-offset: 2px;
        box-shadow: 0 0 0 6px var(--ring);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container nav" role="navigation" aria-label="Primary">
        <div class="brand">
          <a href="/"
            ><img class="logo" src="/static/icon.png" alt="TAOMA logo"
          /></a>
          <a href="/" style="color: inherit; text-decoration: none">TAOMA</a>
        </div>
        <button
          type="button"
          class="mobile-toggle"
          id="mobileToggle"
          aria-controls="primary-menu"
          aria-expanded="false"
          aria-label="Toggle menu"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M4 6H20M4 12H20M4 18H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
        <nav id="primary-menu" class="links" aria-label="Site">
          <a href="/">Home</a>
          <a href="/api">GIF API</a>
          <a href="/api/gif/admin" aria-current="page">Add GIFs</a>
          <a href="/linktree/config">Linktree</a>
        </nav>
        <div id="authSlot" class="auth"></div>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <div class="section-title">
          <div>
            <p class="pill" id="whoami"></p>
            <h1>GIF API Admin</h1>
            <p>
              Manage GIFs, check badges, and lock or unlock users who can edit
              GIFs.
            </p>
          </div>
        </div>
      </section>
      <section class="grid two">
        <div class="card">
          <div class="section-title">
            <h2 data-i18n="admin.builder">Create / Edit GIF</h2>
            <div class="pill" id="pillNSFW">sfw</div>
          </div>
          <p class="muted">All fields are necessary.</p>
          <form id="gifForm" class="grid" style="gap: 12px">
            <label data-i18n="admin.title">Title</label>
            <input
              type="text"
              id="title"
              required
              data-i18n-placeholder="ph.title"
            />
            <label data-i18n="admin.url">GIF URL</label>
            <input type="url" id="url" required placeholder="https://..." />
            <label data-i18n="admin.anime">Anime</label>
            <input
              type="text"
              id="anime"
              data-i18n-placeholder="ph.anime"
              required
            />
            <div class="grid" style="gap: 12px">
              <div>
                <label data-i18n="admin.nsfw">NSFW?</label>
                <select id="nsfw">
                  <option value="false">sfw</option>
                  <option value="true">nsfw</option>
                </select>
              </div>
              <div>
                <label data-i18n="admin.character">Character</label>
                <div style="display: flex; gap: 8px">
                  <input
                    type="text"
                    id="charInput"
                    data-i18n-placeholder="ph.character"
                  />
                  <button
                    type="button"
                    class="btn secondary"
                    id="addChar"
                    data-i18n="admin.addChar"
                  >
                    Add
                  </button>
                </div>
                <div id="chars" class="chips"></div>
              </div>
              <div>
                <label data-i18n="admin.tags">Tags</label>
                <div style="display: flex; gap: 8px">
                  <input
                    type="text"
                    id="tagInput"
                    placeholder="tag, mood, pose..."
                  />
                  <button
                    type="button"
                    class="btn secondary"
                    id="addTag"
                    data-i18n="admin.addTag"
                  >
                    Add
                  </button>
                </div>
                <div id="tags" class="chips"></div>
              </div>
            </div>
            <div class="preview" id="preview" style="display: none">
              <img id="gifPreview" alt="GIF preview" />
              <pre
                id="payloadBox"
                style="
                  flex: 1;
                  min-height: 180px;
                  background: #0b1030;
                  border: 1px solid rgba(255, 255, 255, 0.08);
                  border-radius: 12px;
                  padding: 12px;
                  color: #cfe0ff;
                  overflow: auto;
                "
              ></pre>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap">
              <button type="submit" class="btn" data-i18n="admin.save">
                save
              </button>
              <button
                type="button"
                class="btn secondary"
                id="fillDemo"
                data-i18n="admin.demo"
              >
                fill with demo data
              </button>
              <button
                type="button"
                class="btn secondary"
                id="clearAll"
                data-i18n="admin.clear"
              >
                Clear all
              </button>
            </div>
            <div id="status" class="status"></div>
          </form>
        </div>

        <div class="card" id="blacklistCard">
          <div class="section-title">
            <h2>GIF-Blacklist</h2>
            <span class="pill">Only Admins</span>
          </div>
          <p class="muted">
            Blacklisted users cannot create, edit, or delete any GIFs. Every
            other feature of the website stays unchanged.
          </p>
          <label for="blUserId">User ID</label>
          <input type="number" id="blUserId" min="1" placeholder="123" />
          <label for="blReason">reason (optional)</label>
          <input type="text" id="blReason" placeholder="Spam, Abuse, ..." />
          <div
            style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px"
          >
            <button class="btn" id="blAdd">Blacklist user</button>
            <button class="btn secondary" id="blRemove">remove</button>
            <button class="btn secondary" id="blReload">reload list</button>
          </div>
          <div id="blStatus" class="status"></div>
          <div
            id="blList"
            style="
              margin-top: 12px;
              display: flex;
              flex-direction: column;
              gap: 8px;
              max-height: 240px;
              overflow: auto;
            "
          ></div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">
          <h2 data-i18n="admin.list">Search GIFs</h2>
          <div style="display: flex; gap: 8px; flex-wrap: wrap">
            <input
              type="text"
              id="q"
              placeholder="Title contains..."
              style="min-width: 200px"
            />
            <select id="nsfwList">
              <option value="true" data-i18n="admin.nsfwAll">both</option>
              <option value="false" data-i18n="admin.onlySfw">only sfw</option>
              <option value="only" data-i18n="admin.onlyNsfw">only nsfw</option>
            </select>
            <button
              class="btn secondary"
              id="btnReload"
              data-i18n="admin.reload"
            >
              reload
            </button>
          </div>
        </div>
        <div class="table-rows" id="tableWrap"></div>
        <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap">
          <button class="btn secondary" id="more" data-i18n="admin.more">
            load more
          </button>
        </div>
      </section>
    </main>

    <footer>
      <div class="container foot">
        <div class="muted">
          TAOMA - Anime GIF API Admin Â· <a href="/datenschutz.html">Privacy Policy</a>
        </div>
        <div class="social">
          <a
            class="iso-pro is-gh"
            href="https://github.com/TAOMA"
            aria-label="GitHub"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                d="M12 .5C5.73.5.5 5.74.5 12.02c0 5.1 3.29 9.42 7.86 10.95.58.12.79-.25.79-.56 0-.28-.01-1.02-.02-2-3.2.7-3.88-1.54-3.88-1.54-.53-1.35-1.3-1.71-1.3-1.71-1.06-.73.08-.72.08-.72 1.17.08 1.78 1.21 1.78 1.21 1.04 1.78 2.74 1.26 3.41.96.1-.76.41-1.26.75-1.55-2.56-.29-5.26-1.28-5.26-5.69 0-1.26.45-2.29 1.19-3.1-.12-.29-.52-1.45.11-3.02 0 0 .97-.31 3.18 1.18a11.1 11.1 0 0 1 5.79 0c2.2-1.49 3.17-1.18 3.17-1.18.64 1.57.24 2.73.12 3.02.74.81 1.19 1.84 1.19 3.1 0 4.42-2.7 5.39-5.28 5.67.42.36.8 1.08.8 2.19 0 1.58-.02 2.85-.02 3.24 0 .31.21.69.8.57A10.53 10.53 0 0 0 23.5 12C23.5 5.74 18.27.5 12 .5Z"
              />
            </svg>
          </a>
          <a
            class="iso-pro is-mail"
            href="mailto:kontakt@taoma.space"
            aria-label="E-Mail"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M4 6h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <path
                d="M4 6 12 13 20 6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </a>
          <a
            class="iso-pro is-discord"
            href="https://discord.gg/"
            aria-label="Discord"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 245 240"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                d="M104.4 104.9c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1.1-6.1-4.5-11.1-10.2-11.1zm36.2 0c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.5-11.1-10.2-11.1z"
              />
              <path
                d="M189.5 20h-134C44.2 20 35 29.2 35 40.7v135.2c0 11.5 9.2 20.7 20.5 20.7h113.4l-5.3-18.4 12.8 11.8 12.1 11.2 21.5 19V40.7c0-11.5-9.2-20.7-20.5-20.7zm-38.6 135s-3.6-4.3-6.6-8.1c13.1-3.7 18.1-11.8 18.1-11.8-4.1 2.7-8 4.6-11.5 5.9-5 2.1-9.8 3.4-14.5 4.3-9.6 1.8-18.4 1.3-25.9-.1-5.7-1.1-10.6-2.6-14.7-4.3-2.3-.9-4.8-2-7.4-3.4-.3-.2-.6-.3-.9-.5-.2-.1-.3-.2-.4-.3-1.8-1-2.8-1.7-2.8-1.7s4.8 7.9 17.5 11.7c-3 3.8-6.7 8.3-6.7 8.3-22.1-.7-30.5-15.2-30.5-15.2 0-32.1 14.4-58.1 14.4-58.1 14.4-10.8 28-10.5 28-10.5l1 1.2c-18 5.2-26.3 13.1-26.3 13.1s2.2-1.2 5.9-2.9c10.7-4.7 19.2-5.9 22.7-6.2.6-.1 1.1-.2 1.7-.2 6.1-.8 13-1 20.2-.2 9.5 1.1 19.7 3.9 30.1 9.6 0 0-7.9-7.5-24.9-12.7l1.4-1.6s13.7-.3 28 10.5c0 0 14.4 26 14.4 58.1 0-.1-8.5 14.4-30.6 15.1z"
              />
            </svg>
          </a>
        </div>
      </div>
    </footer>

    <div
      id="loginModal"
      class="card"
      style="
        display: none;
        position: fixed;
        right: 16px;
        bottom: 16px;
        max-width: 340px;
        z-index: 10;
      "
    >
      <div class="section-title">
        <h3>Login</h3>
        <button id="toggleLogin" class="btn secondary">X</button>
      </div>
      <p class="muted">Log in with your account.</p>
      <label>API Base URL</label>
      <input type="url" id="apiBaseModal" placeholder="https://your-api.tld" />
      <div style="display: flex; gap: 8px; margin-top: 10px">
        <button class="btn" id="btnLoginModal">Go to login page</button>
        <button class="btn secondary" id="btnLogoutModal">Logout</button>
      </div>
      <div id="authMsgModal" class="status"></div>
    </div>

    <script>
      const menu = document.getElementById("primary-menu");
      const mobileToggle = document.getElementById("mobileToggle");
      if (mobileToggle && menu) {
        mobileToggle.addEventListener("click", () => {
          const open = menu.classList.toggle("open");
          mobileToggle.setAttribute("aria-expanded", open ? "true" : "false");
        });
      }

      const $ = (sel) => document.querySelector(sel);
      const chars = new Set();
      const tags = new Set();
      function renderChips(containerId, valuesSet) {
        const el = $(containerId);
        el.innerHTML = "";
        [...valuesSet].forEach((v) => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.innerHTML = `<span>${v}</span><button title="remove">X</button>`;
          chip.querySelector("button").onclick = () => {
            valuesSet.delete(v);
            renderChips(containerId, valuesSet);
          };
          el.appendChild(chip);
        });
      }
      function buildPayload() {
        return {
          title: $("#title").value.trim(),
          url: $("#url").value.trim(),
          nsfw: $("#nsfw").value === "true",
          anime: ($("#anime").value || "").trim(),
          characters: Array.from(chars),
          tags: Array.from(tags),
        };
      }
      function showPreview() {
        const p = buildPayload();
        $("#preview").style.display = p.url ? "flex" : "none";
        $("#gifPreview").src = p.url || "";
        $("#pillNSFW").textContent = p.nsfw ? "nsfw" : "sfw";
        $("#pillNSFW").style.background = p.nsfw ? "#31131b" : "#0b1030";
        $("#pillNSFW").style.borderColor = p.nsfw
          ? "#ff6b81"
          : "rgba(255,255,255,.08)";
        $("#payloadBox").textContent = JSON.stringify(p, null, 2);
      }
      $("#addChar").onclick = () => {
        const v = $("#charInput").value.trim();
        if (!v) return;
        chars.add(v);
        $("#charInput").value = "";
        renderChips("#chars", chars);
        showPreview();
      };
      $("#addTag").onclick = () => {
        const v = $("#tagInput").value.trim();
        if (!v) return;
        tags.add(v.toLowerCase());
        $("#tagInput").value = "";
        renderChips("#tags", tags);
        showPreview();
      };
      ["title", "url", "anime", "nsfw"].forEach((id) =>
        $("#" + id).addEventListener("input", showPreview)
      );
      $("#fillDemo").onclick = () => {
        $("#title").value = "NazunaSmoke";
        $("#url").value =
          "https://64.media.tumblr.com/f73b119eedb96c5c960440e9e95d7ca7/f85ffa2085789c11-63/s540x810/321435276705554ca903558d0443a94578805a0a.gif";
        $("#anime").value = "Call of the Night";
        $("#nsfw").value = "false";
        chars.clear();
        tags.clear();
        chars.add("Nazuna Nanakusa");
        tags.add("smoking");
        tags.add("night");
        renderChips("#chars", chars);
        renderChips("#tags", tags);
        showPreview();
      };
      $("#clearAll").onclick = () => {
        $("#gifForm").reset();
        chars.clear();
        tags.clear();
        renderChips("#chars", chars);
        renderChips("#tags", tags);
        $("#preview").style.display = "none";
        $("#status").textContent = "";
      };
    </script>

    <script>
      let AUTH_TOKEN = null;
      let IS_ADMIN = false;
      let CURRENT_USER = null;
      const authHeaders = () =>
        AUTH_TOKEN && AUTH_TOKEN !== "cookie"
          ? { "X-Auth-Token": AUTH_TOKEN }
          : {};
      const _fetch = window.fetch;
      window.fetch = (url, opts = {}) =>
        _fetch(url, { credentials: "include", ...opts });
      const getBase = () => {
        const v =
          ($("#apiBase") ? $("#apiBase").value : "") || window.location.origin;
        return v.replace(/\/$/, "");
      };
      (function ensureBase() {
        const inp = document.getElementById("apiBase");
        if (inp && !inp.value) inp.value = window.location.origin;
        const modal = document.getElementById("apiBaseModal");
        if (modal && !modal.value) modal.value = window.location.origin;
      })();

      async function safe(fn) {
        try {
          return await fn();
        } catch (e) {
          console.error(e);
          return null;
        }
      }

      function escapeHtml(value) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return String(value ?? "").replace(/[&<>"']/g, (ch) => map[ch] || ch);
      }

      function sanitizeUrl(raw) {
        if (typeof raw !== "string") return "";
        const trimmed = raw.trim();
        if (!trimmed) return "";
        if (trimmed.startsWith("javascript:")) return "";
        try {
          const u = new URL(trimmed, window.location.origin);
          if (["http:", "https:"].includes(u.protocol)) {
            return trimmed.startsWith("http://") || trimmed.startsWith("https://")
              ? u.href
              : trimmed;
          }
        } catch (_) {
          if (trimmed.startsWith("/") && !trimmed.startsWith("//")) return trimmed;
        }
        return "";
      }

      async function fetchSession() {
        try {
          const r = await safe(() =>
            fetch("/api/auth/verify", { credentials: "include" })
          );
          if (!r || !r.ok) return null;
          return await r.json();
        } catch (_) {
          return null;
        }
      }

      async function renderAuthHeader() {
        const slot = document.getElementById("authSlot");
        if (!slot) return;

        const session = await fetchSession();
        const user = session?.user || null;
        CURRENT_USER = user;
        const isAdmin = !!(user && user.admin);
        IS_ADMIN = isAdmin;

        if (!user) {
          slot.innerHTML = `
        <a class="btn small" href="/login?next=${encodeURIComponent(location.href)}">Login</a>
        <a class="btn small" href="/register?next=${encodeURIComponent(location.href)}">Register</a>
      `;
          return;
        }

        const uname = user.username || "User";
        const initials = uname.trim().slice(0, 2).toUpperCase() || "U";
        const pfp = sanitizeUrl(user.profile_picture || "");

        slot.innerHTML = `
      <div class="auth-box" style="position:relative">
        <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false">
          ${
            pfp
              ? `<img class="avatar" src="${pfp}" alt="${escapeHtml(uname)}'s profile picture">`
              : `<span class="avatar-fallback" aria-hidden="true">${escapeHtml(initials)}</span>`
          }
          <span class="uname" style="font-weight:700;font-size:.95rem">${escapeHtml(uname)}</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div class="menu" id="userMenu" role="menu" aria-label="User menu">
          <a href="/profile" role="menuitem">Profile</a>
          ${isAdmin ? `<a href="/admin" role="menuitem">Admin</a>` : ``}
          <button id="logoutBtnHdr" role="menuitem">Logout</button>
        </div>
      </div>
    `;

        const btn = slot.querySelector("#avatarBtn");
        const menu = slot.querySelector("#userMenu");
        const logoutBtn = slot.querySelector("#logoutBtnHdr");

        function closeMenu() {
          if (menu) menu.classList.remove("open");
          if (btn) btn.setAttribute("aria-expanded", "false");
        }

        btn?.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = menu?.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });

        document.addEventListener("click", (e) => {
          const target = e.target;
          if (
            target instanceof Node &&
            menu &&
            !menu.contains(target) &&
            btn &&
            !btn.contains(target)
          )
            closeMenu();
        });

        logoutBtn?.addEventListener(
          "click",
          async () => {
            try {
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "include",
              });
            } catch {}
            location.href = "/";
          },
          { passive: true }
        );
      }
      function requireTokenOrAsk() {
        if (!AUTH_TOKEN) {
          $("#loginModal").style.display = "block";
          $("#authMsg").textContent = "Please log in to manage GIFs.";
          $("#authMsg").className = "status err";
          return false;
        }
        return true;
      }
      function syncBase() {
        if ($("#apiBaseModal") && $("#apiBase") && $("#apiBaseModal").value) {
          $("#apiBase").value = $("#apiBaseModal").value;
        } else if ($("#apiBase") && $("#apiBaseModal") && $("#apiBase").value) {
          $("#apiBaseModal").value = $("#apiBase").value;
        }
      }
      $("#toggleLogin").onclick = () => {
        const vis = $("#loginModal").style.display !== "none";
        $("#loginModal").style.display = vis ? "none" : "block";
      };
      $("#btnLoginModal").onclick = () => {
        window.location.href =
          "/login?next=" + encodeURIComponent(window.location.href);
      };
      $("#btnLogoutModal").onclick = async () => {
        await performLogout($("#authMsgModal"));
      };
      async function performLogout(statusEl) {
        const base = getBase();
        try {
          await fetch(base + "/api/auth/logout", {
            method: "POST",
            headers: authHeaders(),
          });
        } finally {
          AUTH_TOKEN = null;
          IS_ADMIN = false;
          CURRENT_USER = null;
          statusEl.textContent = "Logged out.";
          statusEl.className = "status";
        }
      }

      $("#gifForm").onsubmit = async (e) => {
        e.preventDefault();
        if (!requireTokenOrAsk()) return;
        const base = getBase();
        const payload = buildPayload();
        if (
          !payload.title ||
          !payload.url ||
          !payload.anime ||
          !payload.characters.length ||
          !payload.tags.length
        ) {
          $("#status").textContent =
            "All fields are required (title, anime, characters, tags).";
          $("#status").className = "status err";
          return;
        }
        try {
          const res = await fetch(base + "/api/gifs", {
            method: "POST",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify(payload),
          });
          if (res.status === 401) {
            $("#loginModal").style.display = "block";
            throw new Error("Unauthorized. Please log in.");
          }
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || res.statusText);
          $("#status").textContent = "Saved (ID " + data.id + ")";
          $("#status").className = "status ok";
        } catch (err) {
          $("#status").textContent = "Error: " + err.message;
          $("#status").className = "status err";
        }
      };
      $("#loginModal").style.display = "none";

      function setWhoAmI(text) {
        $("#whoami").textContent = text || "";
      }
      async function verifyToken() {
        const session = await fetchSession();
        if (!session || !session.user) {
          IS_ADMIN = false;
          CURRENT_USER = null;
          setWhoAmI("Not logged in.");
          return false;
        }
        IS_ADMIN = !!session.user.admin;
        CURRENT_USER = session.user;
        AUTH_TOKEN = "cookie";
        setWhoAmI("Logged in as " + (session.user.username || "user"));
        return true;
      }
      async function ensureAuthUI() {
        const ok = await verifyToken();
        if (!ok) {
          $("#loginModal").style.display = "block";
          setWhoAmI("Not logged in.");
        }
      }
      let ADMIN_OFFSET = 0;
      const PAGE_SIZE = 25;

      function renderTable(rows, append = false) {
        const wrap = $("#tableWrap");
        const currentUserId =
          CURRENT_USER && CURRENT_USER.id != null
            ? Number(CURRENT_USER.id)
            : null;
        const makeRow = (g) => {
          const ownerId =
            g && Object.prototype.hasOwnProperty.call(g, "created_by")
              ? Number(g.created_by)
              : null;
          const canEdit =
            IS_ADMIN ||
            (currentUserId !== null &&
              ownerId !== null &&
              Number(ownerId) === currentUserId);
          const payload = encodeURIComponent(
            JSON.stringify({
              id: g.id,
              title: g.title || "",
              url: g.url || "",
              nsfw: !!g.nsfw,
              anime: g.anime || "",
              characters: g.characters || [],
              tags: g.tags || [],
            })
          );
          const loadCell = canEdit
            ? `<button class="btn secondary" data-load="${payload}">${"Load"}</button>`
            : `<div class="muted" style="text-align:right;font-size:.9rem" title="Only your own GIFs can be edited">View only</div>`;
          const deleteCell = canEdit
            ? `<button class="btn" data-del="${g.id}">${"Delete"}</button>`
            : `<div></div>`;
          return `
<div style="display:grid;grid-template-columns:64px 1fr auto auto auto;gap:12px;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06)">
  <img src="${
    g.url
  }" alt="" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.08)"/>
  <div>
    <div style="color:#e7e9ff;font-weight:700">${g.title}</div>
    <div class="muted">#${g.id} | ${g.anime || "-"} | ${
            g.nsfw ? "nsfw" : "sfw"
          } | ${g.created_by ? "User " + g.created_by : "no owner"}</div>
    <div class="muted">Tags: ${(g.tags || []).join(", ") || "-"} | Chars: ${
            (g.characters || []).join(", ") || "-"
          }</div>
  </div>
  <a class="btn secondary" href="${
    g.url
  }" target="_blank" rel="noopener">${"Open"}</a>
  ${loadCell}
  ${deleteCell}
</div>`;
        };
        const html = rows.map(makeRow).join("");
        if (!append) wrap.innerHTML = "";
        wrap.insertAdjacentHTML(
          "beforeend",
          html || `<span class="muted">${"No results."}</span>`
        );
        wrap.querySelectorAll("button[data-del]").forEach((btn) => {
          btn.onclick = async () => {
            const id = btn.getAttribute("data-del");
            if (!confirm("Really delete #" + id + "?")) return;
            await deleteGif(id);
            ADMIN_OFFSET = 0;
            await loadAdminList(false);
          };
        });
        wrap.querySelectorAll("button[data-load]").forEach((btn) => {
          btn.onclick = () => {
            try {
              const g = JSON.parse(
                decodeURIComponent(btn.getAttribute("data-load"))
              );
              loadIntoBuilder(g);
            } catch (e) {
              alert("Could not load into builder: " + e.message);
            }
          };
        });
      }
      function loadIntoBuilder(g) {
        $("#title").value = g.title || "";
        $("#url").value = g.url || "";
        $("#anime").value = g.anime || "";
        $("#nsfw").value = g.nsfw ? "true" : "false";
        chars.clear();
        (g.characters || []).forEach((c) => c && chars.add(String(c)));
        tags.clear();
        (g.tags || []).forEach((t) => t && tags.add(String(t)));
        renderChips("#chars", chars);
        renderChips("#tags", tags);
        showPreview();
        const formCard = document.querySelector("#gifForm").closest(".card");
        formCard.scrollIntoView({ behavior: "smooth", block: "start" });
        formCard.style.boxShadow =
          "0 0 0 2px #7c9cff, 0 10px 30px rgba(0,0,0,.25)";
        setTimeout(() => {
          formCard.style.boxShadow = "";
        }, 800);
        $("#status").textContent =
          "Loaded from list. You can edit or save now.";
        $("#status").className = "status ok";
      }
      async function loadAdminList(append = false) {
        if (!AUTH_TOKEN) {
          $("#loginModal").style.display = "block";
          return;
        }
        const base = getBase();
        const q = encodeURIComponent($("#q").value.trim());
        const nsfw = $("#nsfwList").value;
        const url = IS_ADMIN
          ? `${base}/api/admin/gifs?q=${q}&nsfw=${nsfw}&limit=${PAGE_SIZE}&offset=${ADMIN_OFFSET}`
          : `${base}/api/gifs?q=${q}&nsfw=${nsfw}&limit=${PAGE_SIZE}&offset=${ADMIN_OFFSET}`;
        const r = await fetch(url, { headers: authHeaders() });
        if (!r.ok) {
          $("#tableWrap").textContent = "Load error: " + r.statusText;
          return;
        }
        const rows = await r.json();
        renderTable(rows, append);
      }
      async function deleteGif(id) {
        const base = getBase();
        const r = await fetch(base + "/api/gifs/" + id, {
          method: "DELETE",
          headers: authHeaders(),
        });
        if (!r.ok && r.status !== 204) {
          const j = await r.json().catch(() => ({ detail: r.statusText }));
          alert("Delete failed: " + (j.detail || r.statusText));
        }
      }
      $("#btnReload").onclick = async () => {
        ADMIN_OFFSET = 0;
        await loadAdminList(false);
      };
      $("#more").onclick = async () => {
        ADMIN_OFFSET += PAGE_SIZE;
        await loadAdminList(true);
      };
      window.addEventListener("load", async () => {
        await renderAuthHeader();
        await ensureAuthUI();
        const blacklistCard = document.getElementById("blacklistCard");
        if (blacklistCard && !IS_ADMIN) {
          blacklistCard.style.display = "none";
        }
        if (AUTH_TOKEN) {
          ADMIN_OFFSET = 0;
          await loadAdminList(false);
          if (IS_ADMIN) {
            await loadBlacklist();
          }
        }
      });
      async function loadBlacklist() {
        if (!AUTH_TOKEN || !IS_ADMIN) return;
        const base = getBase();
        const statusEl = $("#blStatus");
        statusEl.textContent = "";
        try {
          const r = await fetch(base + "/api/admin/gif-blacklist", {
            headers: authHeaders(),
          });
          if (!r.ok) throw new Error(r.statusText);
          const list = await r.json();
          const wrap = $("#blList");
          wrap.innerHTML = "";
          if (!list.length) {
            wrap.innerHTML = '<span class="muted">No entries.</span>';
            return;
          }
          list.forEach((entry) => {
            const div = document.createElement("div");
            div.className = "card";
            div.style.padding = "10px 12px";
            div.innerHTML = `
<div style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
  <div>
    <div style="font-weight:700;color:#e7e9ff">User #${entry.user_id}</div>
    <div class="muted">${
      entry.reason ? entry.reason : "No reason provided"
    }</div>
    <div class="muted">${entry.created_at || ""}</div>
  </div>
  <button class="btn danger" data-unblock="${entry.user_id}">Remove</button>
</div>`;
            wrap.appendChild(div);
          });
          wrap.querySelectorAll("[data-unblock]").forEach((btn) => {
            btn.onclick = async () => {
              $("#blUserId").value = btn.getAttribute("data-unblock");
              await unblockUser();
              await loadBlacklist();
            };
          });
        } catch (err) {
          statusEl.textContent = "Error while loading: " + err.message;
          statusEl.className = "status err";
        }
      }

      async function blockUser() {
        if (!requireTokenOrAsk()) return;
        const base = getBase();
        const userId = Number($("#blUserId").value);
        const reason = $("#blReason").value.trim() || null;
        const statusEl = $("#blStatus");
        if (!userId) {
          statusEl.textContent = "User ID is missing.";
          statusEl.className = "status err";
          return;
        }
        try {
          const r = await fetch(`${base}/api/admin/gif-blacklist/${userId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json", ...authHeaders() },
            body: JSON.stringify({ reason }),
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.detail || r.statusText);
          statusEl.textContent = `User #${userId} blacklisted.`;
          statusEl.className = "status ok";
          await loadBlacklist();
        } catch (err) {
          statusEl.textContent = "Error: " + err.message;
          statusEl.className = "status err";
        }
      }

      async function unblockUser() {
        if (!requireTokenOrAsk()) return;
        const base = getBase();
        const userId = Number($("#blUserId").value);
        const statusEl = $("#blStatus");
        if (!userId) {
          statusEl.textContent = "User ID is missing.";
          statusEl.className = "status err";
          return;
        }
        try {
          const r = await fetch(`${base}/api/admin/gif-blacklist/${userId}`, {
            method: "DELETE",
            headers: authHeaders(),
          });
          if (!r.ok) {
            const j = await r.json().catch(() => ({}));
            throw new Error(j.detail || r.statusText);
          }
          statusEl.textContent = `User #${userId} removed.`;
          statusEl.className = "status ok";
          await loadBlacklist();
        } catch (err) {
          statusEl.textContent = "Error: " + err.message;
          statusEl.className = "status err";
        }
      }

      $("#blAdd").onclick = blockUser;
      $("#blRemove").onclick = unblockUser;
      $("#blReload").onclick = loadBlacklist;
    </script>
  </body>
</html>
