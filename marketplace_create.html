<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Template - TAOMA</title>
    <meta
      name="description"
      content="Create Linktree templates for desktop, mobile, or both."
    />
    <meta property="og:title" content="Create Template - TAOMA" />
    <meta
      property="og:description"
      content="Turn your Linktree design into a reusable template."
    />
    <meta name="theme-color" content="#0f1223" />
    <link rel="icon" type="image/png" href="/static/icon.png" />
    <style>
      /* === TAOMA Marketplace Create — Restyle (no functional changes) === */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      :root {
        --bg: #0b1220;
        --bg2: #0a162a;
        --card: #0f2139;
        --card2: #0c1b31;
        --ink: #eaf0ff;
        --muted: #aab7d6;
        --muted2: #7f92bc;
        --border: rgba(255, 255, 255, 0.1);
        --border2: rgba(255, 255, 255, 0.16);
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.35),
          0 2px 10px rgba(0, 0, 0, 0.25);
        --shadow2: 0 10px 30px rgba(0, 0, 0, 0.25);
        --r: 18px;
        --r2: 14px;
        --r3: 12px;
        --space: clamp(16px, 2.4vw, 28px);
        --container: 1120px;

        --acc: #2bd4c7; /* teal */
        --acc2: #4aa3ff; /* blue */
        --acc3: #8b5cf6; /* violet */
        --ring: rgba(43, 212, 199, 0.35);

        --ok: #2ce6a2;
        --danger: #ff5a6a;
        --warn: #ffcc66;

        --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Ubuntu, Cantarell, "Helvetica Neue", Arial;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f8ff;
          --bg2: #eef3ff;
          --card: #ffffff;
          --card2: #f8fbff;
          --ink: #0b1020;
          --muted: #425277;
          --muted2: #5a6b92;
          --border: rgba(10, 16, 32, 0.1);
          --border2: rgba(10, 16, 32, 0.14);
          --shadow: 0 22px 70px rgba(12, 24, 50, 0.12),
            0 2px 10px rgba(12, 24, 50, 0.08);
          --shadow2: 0 10px 28px rgba(12, 24, 50, 0.1);
          --ring: rgba(74, 163, 255, 0.25);
        }
      }

      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font: 15px/1.6 var(--font);
        color: var(--ink);
        background: radial-gradient(
            1200px 700px at 15% -10%,
            color-mix(in oklab, var(--acc3) 28%, transparent),
            transparent 65%
          ),
          radial-gradient(
            900px 600px at 100% 0%,
            color-mix(in oklab, var(--acc2) 35%, transparent),
            transparent 65%
          ),
          linear-gradient(160deg, var(--bg2), var(--bg));
        min-height: 100dvh;
        display: flex;
        flex-direction: column;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      .container {
        width: min(100%, var(--container));
        margin: 0 auto;
        padding: 0 var(--space);
      }

      /* Header / nav */
      header {
        position: sticky;
        top: 0;
        z-index: 30;
        backdrop-filter: blur(10px) saturate(1.1);
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--bg) 75%, transparent),
          color-mix(in oklab, var(--bg) 40%, transparent)
        );
        border-bottom: 1px solid var(--border);
      }

      .nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 70px;
        gap: 12px;
      }

      .brand {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-weight: 900;
        letter-spacing: 0.3px;
      }
      .brand a {
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }
      .brand .logo {
        width: 32px;
        height: 32px;
        border-radius: 12px;
        box-shadow: var(--shadow2);
      }

      .links {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .links a {
        padding: 0.55rem 0.8rem;
        border-radius: 999px;
        border: 1px solid transparent;
        color: color-mix(in oklab, var(--ink) 92%, var(--muted));
        transition: transform 0.15s ease, background 0.15s ease,
          border-color 0.15s ease;
      }
      .links a:hover {
        background: color-mix(in oklab, var(--card) 75%, transparent);
        border-color: var(--border2);
      }
      .links a[aria-current="page"] {
        background: color-mix(in oklab, var(--acc2) 16%, transparent);
        border-color: color-mix(in oklab, var(--acc2) 35%, transparent);
      }

      .auth {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.55rem;
        padding: 0.78rem 1rem;
        border-radius: 999px;
        border: 1px solid color-mix(in oklab, var(--acc) 35%, var(--border));
        background: linear-gradient(
          135deg,
          color-mix(in oklab, var(--acc) 78%, #0000),
          color-mix(in oklab, var(--acc2) 68%, #0000)
        );
        color: #fff;
        font-weight: 800;
        cursor: pointer;
        transition: transform 0.15s ease, filter 0.15s ease,
          box-shadow 0.15s ease;
        box-shadow: var(--shadow2);
        user-select: none;
      }
      .btn:hover {
        transform: translateY(-1px);
        filter: saturate(1.05) brightness(1.02);
      }
      .btn:active {
        transform: translateY(0px);
        filter: saturate(1);
      }

      .btn.ghost {
        background: transparent;
        color: var(--ink);
        border: 1px solid var(--border2);
        box-shadow: none;
      }
      .btn.ghost:hover {
        background: color-mix(in oklab, var(--card) 70%, transparent);
      }

      .btn.sm {
        padding: 0.56rem 0.78rem;
        border-radius: 999px;
        font-size: 0.92rem;
        box-shadow: none;
      }
      .btn.small {
        padding: 0.52rem 0.75rem;
        border-radius: 999px;
        font-size: 0.92rem;
        background: transparent;
        color: var(--ink);
        border: 1px solid var(--border2);
        box-shadow: none;
        font-weight: 800;
      }
      .btn.small:hover {
        background: color-mix(in oklab, var(--card) 70%, transparent);
      }

      /* User menu */
      .auth-box {
        position: relative;
      }
      .avatar-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.55rem;
        padding: 0.42rem 0.6rem;
        border-radius: 999px;
        background: color-mix(in oklab, var(--card) 70%, transparent);
        border: 1px solid var(--border);
        color: var(--ink);
        cursor: pointer;
      }
      .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
      }
      .avatar-fallback {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: color-mix(in oklab, var(--acc2) 18%, transparent);
        border: 1px solid var(--border);
        font-weight: 900;
      }

      .menu {
        position: absolute;
        top: calc(100% + 10px);
        right: 0;
        min-width: 190px;
        display: none;
        flex-direction: column;
        overflow: hidden;
        border-radius: 16px;
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card) 92%, transparent),
          var(--card)
        );
        border: 1px solid var(--border2);
        box-shadow: var(--shadow);
        z-index: 40;
      }
      .menu.open {
        display: flex;
      }
      .menu a,
      .menu button {
        padding: 0.72rem 0.9rem;
        background: transparent;
        color: var(--ink);
        border: 0;
        cursor: pointer;
        text-align: left;
        font-weight: 750;
      }
      .menu a:hover,
      .menu button:hover {
        background: color-mix(in oklab, var(--acc2) 14%, transparent);
      }

      /* Main */
      main {
        flex: 1;
      }

      .hero {
        padding: calc(var(--space) * 1) 0 0;
      }
      .hero h1 {
        margin: 0;
        font-size: clamp(26px, 3.8vw, 38px);
        letter-spacing: -0.02em;
      }
      .hero p {
        margin: 0.35rem 0 0;
        color: var(--muted);
        max-width: 70ch;
      }

      .row {
        display: flex;
        gap: 0.7rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .card {
        margin: 1.2rem 0 2rem;
        border-radius: var(--r);
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card) 92%, transparent),
          var(--card)
        );
        border: 1px solid var(--border2);
        box-shadow: var(--shadow);
        padding: clamp(16px, 2.2vw, 24px);
      }

      .panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
        margin: 1.2rem 0 1rem;
      }

      .option {
        position: relative;
        padding: 16px;
        border-radius: var(--r2);
        border: 1px solid var(--border);
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card2) 88%, transparent),
          color-mix(in oklab, var(--card2) 70%, transparent)
        );
        box-shadow: var(--shadow2);
        display: grid;
        gap: 8px;
      }
      .option strong {
        font-size: 1.05rem;
        letter-spacing: -0.01em;
      }
      .option p {
        margin: 0;
        color: var(--muted);
      }
      .option button {
        justify-self: flex-start;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        border: 1px solid color-mix(in oklab, var(--acc2) 30%, var(--border));
        background: color-mix(in oklab, var(--acc2) 18%, transparent);
        color: color-mix(in oklab, var(--ink) 92%, var(--muted));
        font-weight: 800;
        font-size: 0.92rem;
      }

      .grid {
        display: grid;
        gap: 12px;
      }
      .grid.cols-2 {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .field label {
        font-weight: 850;
        font-size: 0.95rem;
      }

      .input,
      .select,
      textarea {
        width: 100%;
        padding: 0.75rem 0.9rem;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: color-mix(in oklab, var(--bg) 70%, var(--card));
        color: var(--ink);
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease,
          transform 0.15s ease;
      }
      textarea {
        min-height: 92px;
        resize: vertical;
      }

      .input::placeholder,
      textarea::placeholder {
        color: color-mix(in oklab, var(--muted2) 80%, transparent);
      }

      .input:focus,
      .select:focus,
      textarea:focus {
        border-color: color-mix(in oklab, var(--acc2) 55%, var(--border2));
        box-shadow: 0 0 0 4px var(--ring);
      }
      .input:focus-visible,
      .select:focus-visible,
      textarea:focus-visible {
        outline: none;
      }

      .muted {
        color: var(--muted);
      }

      .hr {
        height: 1px;
        width: 100%;
        background: var(--border);
      }

      .alert {
        border-radius: 14px;
        padding: 0.75rem 0.9rem;
        border: 1px solid var(--border2);
        background: color-mix(in oklab, var(--card) 70%, transparent);
        display: none;
        font-weight: 650;
      }
      .alert.ok {
        display: block;
        border-color: color-mix(in oklab, var(--ok) 55%, var(--border2));
        background: color-mix(in oklab, var(--ok) 14%, transparent);
      }
      .alert.err {
        display: block;
        border-color: color-mix(in oklab, var(--danger) 65%, var(--border2));
        background: color-mix(in oklab, var(--danger) 12%, transparent);
      }

      /* Mobile nav */
      .mobile-toggle {
        display: none;
      }

      @media (max-width: 860px) {
        .mobile-toggle {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 42px;
          height: 42px;
          border-radius: 12px;
          border: 1px solid var(--border2);
          background: transparent;
          color: var(--ink);
        }
        .links {
          position: fixed;
          inset: 70px 0 auto 0;
          padding: 14px var(--space);
          background: linear-gradient(
            180deg,
            color-mix(in oklab, var(--bg) 92%, transparent),
            color-mix(in oklab, var(--bg) 70%, transparent)
          );
          border-bottom: 1px solid var(--border);
          flex-direction: column;
          align-items: flex-start;
          display: none;
          gap: 10px;
        }
        .links.open {
          display: flex;
        }
      }

      @media (max-width: 520px) {
        .card {
          padding: 16px;
        }
        .option {
          padding: 14px;
        }
      }

      /* Respect reduced motion */
      @media (prefers-reduced-motion: reduce) {
        * {
          scroll-behavior: auto !important;
          transition: none !important;
          animation: none !important;
        }
      }

      /* === UX add-ons (drafts, toasts, sticky actions) === */
      .sticky-actions {
        position: sticky;
        bottom: 18px;
        z-index: 25;
        margin: 0 auto;
        width: min(100%, var(--container));
        padding: 0 var(--space) calc(var(--space) * 0.6);
        pointer-events: none;
      }
      .sticky-actions .bar {
        pointer-events: auto;
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid var(--border2);
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card) 92%, transparent),
          color-mix(in oklab, var(--card) 78%, transparent)
        );
        box-shadow: var(--shadow);
      }
      .sticky-actions .left {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: color-mix(in oklab, var(--bg) 62%, var(--card));
        color: color-mix(in oklab, var(--ink) 92%, var(--muted));
        font-weight: 850;
        font-size: 0.92rem;
        white-space: nowrap;
      }
      .pill.ok {
        border-color: color-mix(in oklab, var(--ok) 55%, var(--border2));
        background: color-mix(in oklab, var(--ok) 14%, transparent);
      }
      .pill.warn {
        border-color: color-mix(in oklab, var(--warn) 65%, var(--border2));
        background: color-mix(in oklab, var(--warn) 12%, transparent);
      }
      .kbd {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.92em;
        padding: 0.15rem 0.45rem;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: color-mix(in oklab, var(--card2) 86%, transparent);
        color: color-mix(in oklab, var(--ink) 92%, var(--muted));
      }
      .quick-setup {
        margin-top: 1.1rem;
        border-radius: var(--r);
        border: 1px solid var(--border2);
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--acc2) 12%, var(--card)),
          color-mix(in oklab, var(--acc3) 9%, var(--card))
        );
        box-shadow: var(--shadow2);
        padding: clamp(14px, 2vw, 18px);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .quick-setup .qs-title {
        font-weight: 950;
        letter-spacing: -0.01em;
        margin: 0 0 0.25rem 0;
      }
      .quick-setup .qs-sub {
        margin: 0;
        color: var(--muted);
        max-width: 70ch;
      }
      .qs-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .toast-wrap {
        position: fixed;
        inset: auto 16px 16px auto;
        z-index: 60;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }
      .toast {
        pointer-events: auto;
        width: min(420px, calc(100vw - 32px));
        border-radius: 16px;
        border: 1px solid var(--border2);
        background: linear-gradient(
          180deg,
          color-mix(in oklab, var(--card) 92%, transparent),
          var(--card)
        );
        box-shadow: var(--shadow);
        padding: 12px 12px;
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }
      .toast .t-title {
        font-weight: 950;
        margin: 0;
        line-height: 1.25;
      }
      .toast .t-text {
        margin: 0.15rem 0 0;
        color: var(--muted);
        font-weight: 650;
      }
      .toast .t-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .toast .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-top: 5px;
        background: color-mix(in oklab, var(--acc2) 70%, var(--acc));
        box-shadow: 0 0 0 4px color-mix(in oklab, var(--acc2) 18%, transparent);
        flex: 0 0 auto;
      }
      .toast.danger .dot {
        background: var(--danger);
        box-shadow: 0 0 0 4px
          color-mix(in oklab, var(--danger) 18%, transparent);
      }
      .toast.ok .dot {
        background: var(--ok);
        box-shadow: 0 0 0 4px color-mix(in oklab, var(--ok) 16%, transparent);
      }

      .field .help {
        margin: 0;
        color: var(--muted2);
        font-size: 0.92rem;
        line-height: 1.35;
      }
      .input.invalid,
      .select.invalid,
      textarea.invalid {
        border-color: color-mix(in oklab, var(--danger) 70%, var(--border2));
        box-shadow: 0 0 0 4px
          color-mix(in oklab, var(--danger) 18%, transparent);
      }
      .errline {
        color: color-mix(in oklab, var(--danger) 86%, var(--ink));
        font-weight: 800;
        font-size: 0.92rem;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <!-- UX: Toasts -->
    <div
      class="toast-wrap"
      id="toastWrap"
      aria-live="polite"
      aria-atomic="true"
    ></div>

    <header>
      <div class="container nav" role="navigation" aria-label="Primary">
        <div class="brand">
          <a href="/"
            ><img
              class="logo"
              src="/static/icon.png"
              alt="TAOMA logo"
              width="30"
              height="30"
          /></a>
          <a href="/">TAOMA™</a>
        </div>
        <button
          type="button"
          class="mobile-toggle"
          id="mobileToggle"
          aria-controls="primary-menu"
          aria-expanded="false"
          aria-label="Toggle menu"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <path
              d="M4 6H20M4 12H20M4 18H20"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
        <nav id="primary-menu" class="links" aria-label="Site">
          <a href="/">Home</a>
          <a href="/api">GIF API</a>
          <a href="/api/gif/admin">Add GIFs</a>
          <a href="/marketplace" aria-current="page">Marketplace</a>
          <a href="/linktree/config">Linktree</a>
        </nav>
        <div id="authSlot" class="auth"></div>
      </div>
    </header>

    <main>
      <div class="container">
        <section class="hero">
          <div
            class="row"
            style="
              justify-content: space-between;
              gap: 1rem;
              align-items: flex-start;
            "
          >
            <div>
              <h1>Create a template</h1>
              <p>
                Save your Linktree look to the marketplace. Templates include
                your layout and styling only—no links, icons, or slug.
              </p>
            </div>
            <a class="btn ghost sm" href="/marketplace">Back to marketplace</a>
          </div>
        </section>

        <section class="quick-setup" aria-label="Quick setup">
          <div>
            <p class="qs-title">Quick setup</p>
            <p class="qs-sub">
              New here? Start with the essentials: choose a base (import or
              fresh), name your template, set a background, and hit
              <strong>Create</strong>. Tip: press
              <span class="kbd">Ctrl</span> + <span class="kbd">S</span> to
              save.
            </p>
          </div>
          <div class="qs-actions">
            <button class="btn ghost sm" type="button" id="qsJumpDetails">
              Template details
            </button>
            <button class="btn ghost sm" type="button" id="qsJumpLook">
              Look & colors
            </button>
            <button class="btn sm" type="button" id="qsJumpCreate">
              Create
            </button>
          </div>
        </section>

        <div class="options">
          <div class="option">
            <strong>Import my current Linktree</strong>
            <p class="muted">
              Pull your existing Linktree settings (backgrounds, colors,
              effects) for desktop or mobile.
            </p>
            <button class="btn sm" id="btnChoiceImport">
              Use current setup
            </button>
          </div>
          <div class="option">
            <strong>Start from scratch</strong>
            <p class="muted">
              Build a brand-new template without touching your existing
              Linktree.
            </p>
            <button class="btn ghost sm" id="btnChoiceFresh">Start new</button>
          </div>
        </div>

        <section class="card panel" id="formSection" style="display: none">
          <div
            class="row"
            style="justify-content: space-between; align-items: center"
          >
            <h3 style="margin: 0">Template details</h3>
            <span class="badge" id="modeBadge">Desktop</span>
          </div>
          <div class="grid cols-2">
            <div class="field">
              <label for="tplCreator">Creator</label>
              <input
                id="tplCreator"
                class="input"
                type="text"
                maxlength="100"
                placeholder="Your name or brand"
              />
            </div>
            <div class="field">
              <label for="tplName">Template name</label>
              <input
                id="tplName"
                class="input"
                type="text"
                maxlength="64"
                required
              />
            </div>
            <div class="field">
              <label for="tplDesc">Description (optional)</label>
              <textarea
                id="tplDesc"
                class="input"
                maxlength="500"
                placeholder="What makes this template unique?"
              ></textarea>
            </div>
            <div class="field">
              <label for="tplPublic">Visibility</label>
              <select id="tplPublic" class="select">
                <option value="true">Public</option>
                <option value="false">Private</option>
              </select>
            </div>
            <div class="field">
              <label for="tplMode">Template contains</label>
              <select id="tplMode" class="select">
                <option value="pc">Desktop only</option>
                <option value="mobile">Mobile only</option>
                <option value="both">Desktop + Mobile</option>
              </select>
            </div>
            <div class="field">
              <label for="tplDevice">Editing variant</label>
              <select id="tplDevice" class="select">
                <option value="pc">Desktop</option>
                <option value="mobile">Mobile</option>
              </select>
            </div>
          </div>

          <div
            class="row"
            style="justify-content: space-between; align-items: flex-start"
          >
            <div class="muted" id="slugHint"></div>
            <div class="row" style="gap: 0.4rem">
              <button class="btn ghost sm" id="btnResetVariant">
                Start blank for this device
              </button>
              <button class="btn sm" id="btnImportVariant">
                Import from my Linktree
              </button>
            </div>
          </div>

          <div class="grid cols-2">
            <div class="field">
              <label for="tplLocation">Location (optional)</label>
              <input
                id="tplLocation"
                class="input"
                type="text"
                maxlength="120"
              />
            </div>
            <div class="field">
              <label for="tplQuote">Quote (optional)</label>
              <input id="tplQuote" class="input" type="text" maxlength="240" />
            </div>
            <div class="field">
              <label for="tplSong">Song URL (optional)</label>
              <input id="tplSong" class="input" type="text" maxlength="500" />
            </div>
            <div class="field">
              <label for="tplAudioPlayer">Show audio player</label>
              <select id="tplAudioPlayer" class="select">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div class="field">
              <label for="tplBackground">Background URL *</label>
              <input
                id="tplBackground"
                class="input"
                type="text"
                maxlength="500"
                placeholder="/media/... or https://"
              />
            </div>
            <div class="field">
              <label for="tplTrans">Transparency (0-100)</label>
              <input
                id="tplTrans"
                class="input"
                type="number"
                min="0"
                max="100"
                value="0"
              />
            </div>
            <div class="field">
              <label for="tplCardColor">Card/base color</label>
              <input
                id="tplCardColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplNameFx">Name effect</label>
              <select id="tplNameFx" class="select">
                <option value="none">None</option>
                <option value="glow">Glow</option>
                <option value="neon">Neon</option>
                <option value="rainbow">Rainbow</option>
              </select>
            </div>
            <div class="field">
              <label for="tplBgFx">Background effect</label>
              <select id="tplBgFx" class="select">
                <option value="none">None</option>
                <option value="night">Night</option>
                <option value="rain">Rain</option>
                <option value="snow">Snow</option>
              </select>
            </div>
            <div class="field">
              <label for="tplDisplayName">Display name mode</label>
              <select id="tplDisplayName" class="select">
                <option value="slug">Slug</option>
                <option value="username">Username</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="field">
              <label for="tplCustomName">Custom display name</label>
              <input
                id="tplCustomName"
                class="input"
                type="text"
                maxlength="64"
              />
            </div>
            <div class="field">
              <label for="tplLinkColor">Link color</label>
              <input
                id="tplLinkColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplLinkBgColor">Link background color</label>
              <input
                id="tplLinkBgColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplLinkBgAlpha">Link background alpha (0-100)</label>
              <input
                id="tplLinkBgAlpha"
                class="input"
                type="number"
                min="0"
                max="100"
                value="100"
              />
            </div>
            <div class="field">
              <label for="tplTextColor">Text color</label>
              <input
                id="tplTextColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplNameColor">Name color</label>
              <input
                id="tplNameColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplLocationColor">Location color</label>
              <input
                id="tplLocationColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplQuoteColor">Quote color</label>
              <input
                id="tplQuoteColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplCursorUrl">Cursor URL (optional)</label>
              <input
                id="tplCursorUrl"
                class="input"
                type="text"
                maxlength="500"
              />
            </div>
            <div class="field">
              <label for="tplDiscordFrame">Discord frame enabled</label>
              <select id="tplDiscordFrame" class="select">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div class="field">
              <label for="tplDiscordPresence">Discord activity status</label>
              <select id="tplDiscordPresence" class="select">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div class="field">
              <label for="tplDiscordPresenceValue">Activity status</label>
              <select id="tplDiscordPresenceValue" class="select">
                <option value="online">Online</option>
                <option value="idle">Idle</option>
                <option value="dnd">Do not disturb</option>
                <option value="offline">Offline</option>
              </select>
            </div>
            <div class="field">
              <label for="tplDiscordStatusLine">Discord status line</label>
              <select id="tplDiscordStatusLine" class="select">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div class="field">
              <label for="tplDiscordStatusText">Status text</label>
              <input
                id="tplDiscordStatusText"
                class="input"
                type="text"
                maxlength="140"
                placeholder="e.g. Building something cool"
              />
            </div>
            <div class="field">
              <label for="tplDiscordBadges">Discord badges</label>
              <select id="tplDiscordBadges" class="select">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div class="field">
              <label for="tplShowCounter">Show visit counter</label>
              <select id="tplShowCounter" class="select">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div class="field">
              <label for="tplCounterColor">Counter color</label>
              <input
                id="tplCounterColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplCounterBgColor">Counter background color</label>
              <input
                id="tplCounterBgColor"
                class="input"
                type="text"
                placeholder="#RRGGBB"
              />
            </div>
            <div class="field">
              <label for="tplCounterBgAlpha"
                >Counter background alpha (0-100)</label
              >
              <input
                id="tplCounterBgAlpha"
                class="input"
                type="number"
                min="0"
                max="100"
                value="20"
              />
            </div>
          </div>

          <div class="hr"></div>
          <div
            class="row"
            style="justify-content: space-between; align-items: center"
          >
            <div class="muted">
              Templates save to the marketplace using Firebase. Links, icons,
              and slug are never copied.
            </div>
            <div class="row" style="gap: 0.4rem">
              <button class="btn ghost sm" id="btnResetAll">Reset form</button>
              <button class="btn sm" id="btnSaveTemplate">
                Create template
              </button>
            </div>
          </div>
          <div class="alert" id="formMsg"></div>
        </section>
      </div>

      <!-- UX: Sticky actions (shows when there are unsaved changes) -->
      <div class="sticky-actions" id="stickyActions" style="display: none">
        <div class="bar" role="region" aria-label="Unsaved changes">
          <div class="left">
            <span class="pill warn" id="dirtyPill">Unsaved changes</span>
            <span class="pill" id="draftPill" style="display: none"
              >Draft saved</span
            >
            <span class="pill" id="hintPill"
              >Save anytime with <span class="kbd">Ctrl</span>+<span class="kbd"
                >S</span
              ></span
            >
          </div>
          <div class="row" style="gap: 0.4rem">
            <button class="btn ghost sm" type="button" id="btnDiscardDraft">
              Discard
            </button>
            <button class="btn sm" type="button" id="btnStickySave">
              Save
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      const $ = (id) => document.getElementById(id);

      function showMsg(el, text, ok = false) {
        if (!el) return;
        el.textContent = text;
        el.className = "alert " + (ok ? "ok" : "err");
        el.style.display = "block";
        setTimeout(() => (el.style.display = "none"), 3500);
      }

      function headers() {
        return { "Content-Type": "application/json" };
      }

      async function fetchSession() {
        try {
          const r = await fetch("/api/auth/verify", { credentials: "include" });
          if (!r.ok) return null;
          return await r.json();
        } catch (_) {
          return null;
        }
      }

      async function apiGet(url) {
        const r = await fetch(url, { credentials: "include" });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiPost(url, body) {
        const r = await fetch(url, {
          method: "POST",
          headers: headers(),
          credentials: "include",
          body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      async function apiPatch(url, body) {
        const r = await fetch(url, {
          method: "PATCH",
          headers: headers(),
          credentials: "include",
          body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error(await r.text());
        return await r.json();
      }

      const params = new URLSearchParams(location.search);
      const presetSlug = params.get("slug") || "";
      const presetDevice = (() => {
        const val = params.get("device");
        if (val === "both") return "both";
        if (val === "mobile") return "mobile";
        return "pc";
      })();

      const formMsg = $("formMsg");
      const userBadge = $("userBadge");
      const modeBadge = $("modeBadge");
      const slugHint = $("slugHint");
      const formSection = $("formSection");

      let currentUser = null;
      let currentDevice = presetDevice === "both" ? "pc" : presetDevice;
      let variantCache = { pc: null, mobile: null };
      let choiceMade = false;
      let editingId = null;
      let dirtyVisibility = false;
      let dirtyMeta = false;
      let dirtyVariant = false;

      function resetChangeFlags() {
        dirtyVisibility = false;
        dirtyMeta = false;
        dirtyVariant = false;
      }

      function markDirtyByField(id) {
        if (!id) return;
        if (id === "tplPublic") {
          dirtyVisibility = true;
          return;
        }
        if (id === "tplCreator" || id === "tplName" || id === "tplDesc") {
          dirtyMeta = true;
          return;
        }
        if (id.startsWith("tpl")) dirtyVariant = true;
      }

      function hexOrNull(val) {
        const t = (val || "").trim();
        if (!t) return null;
        if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(t)) return t;
        return null;
      }


      const VIDEO_EXTENSIONS = [".mp4", ".webm", ".m4v", ".mov"];

      function looksLikeVideoUrl(url) {
        if (!url) return false;
        const lower = String(url).toLowerCase();
        return VIDEO_EXTENSIONS.some((ext) => lower.includes(ext));
      }

      function normalizeVariant(raw, deviceFallback) {
        const v = { ...(raw || {}) };
        v.device_type = v.device_type || deviceFallback || "pc";
        v.display_name_mode = v.display_name_mode || "slug";
        if (v.display_name_mode === "custom") {
          if (!v.custom_display_name || !v.custom_display_name.trim()) {
            showMsg(
              formMsg,
              `Custom display name required for ${v.device_type}`,
              false
            );
            return null;
          }
          v.custom_display_name = v.custom_display_name.trim();
        } else {
          v.custom_display_name = null;
        }
        v.link_color = hexOrNull(v.link_color);
        v.link_bg_color = hexOrNull(v.link_bg_color);
        v.card_color = hexOrNull(v.card_color);
        v.text_color = hexOrNull(v.text_color);
        v.name_color = hexOrNull(v.name_color);
        v.location_color = hexOrNull(v.location_color);
        v.quote_color = hexOrNull(v.quote_color);
        v.visit_counter_color = hexOrNull(v.visit_counter_color);
        v.visit_counter_bg_color = hexOrNull(v.visit_counter_bg_color);
        v.show_audio_player = !!v.show_audio_player;
        v.discord_presence_enabled = !!v.discord_presence_enabled;
        v.discord_presence =
          (v.discord_presence || "online").toString().toLowerCase();
        v.discord_status_enabled = !!v.discord_status_enabled;
        v.discord_status_text = v.discord_status_text
          ? String(v.discord_status_text).trim()
          : null;
        v.discord_badges_enabled = !!v.discord_badges_enabled;
        v.link_bg_alpha = Math.min(
          100,
          Math.max(0, parseInt(v.link_bg_alpha ?? 100, 10))
        );
        v.transparency = Math.min(
          100,
          Math.max(0, parseInt(v.transparency ?? 0, 10))
        );
        v.visit_counter_bg_alpha = Math.min(
          100,
          Math.max(0, parseInt(v.visit_counter_bg_alpha ?? 20, 10))
        );
        v.background_url = (v.background_url || "").trim();
        if (!v.background_url) {
          showMsg(
            formMsg,
            `Background URL required for ${v.device_type}`,
            false
          );
          return null;
        }
        return v;
      }

      function updateModeBadge() {
        const mode = $("tplMode").value || "pc";
        if (mode === "pc") $("tplDevice").value = "pc";
        if (mode === "mobile") $("tplDevice").value = "mobile";
        if (mode === "both") {
          modeBadge.textContent = "Desktop + Mobile";
        } else if (mode === "mobile") {
          modeBadge.textContent = "Mobile";
        } else {
          modeBadge.textContent = "Desktop";
        }
      }

      function updateSlugHint() {
        const slug =
          presetSlug ||
          (currentUser && currentUser.linktree_slug) ||
          "your-slug";
        const device = $("tplDevice").value || currentDevice || "pc";
        slugHint.textContent = `Import uses /linktrees/${slug} for ${device}.`;
      }

      function resetVariant(device) {
        const d = device || currentDevice || "pc";
        variantCache[d] = {
          device_type: d,
          location: "",
          quote: "",
          song_url: "",
          show_audio_player: false,
          background_url: "",
          background_is_video: false,
          transparency: 0,
          name_effect: "none",
          background_effect: "none",
          display_name_mode: "slug",
          custom_display_name: "",
          link_color: "",
          link_bg_color: "",
          link_bg_alpha: 100,
          card_color: "",
          text_color: "",
          name_color: "",
          location_color: "",
          quote_color: "",
          cursor_url: "",
          discord_frame_enabled: false,
          discord_presence_enabled: false,
          discord_presence: "online",
          discord_status_enabled: false,
          discord_status_text: "",
          discord_badges_enabled: false,
          show_visit_counter: false,
          visit_counter_color: "",
          visit_counter_bg_color: "",
          visit_counter_bg_alpha: 20,
        };
        applyVariantToForm(variantCache[d]);
      }

      function applyVariantToForm(v) {
        $("tplLocation").value = v.location || "";
        $("tplQuote").value = v.quote || "";
        $("tplSong").value = v.song_url || "";
        $("tplAudioPlayer").value = v.show_audio_player ? "true" : "false";
        $("tplBackground").value = v.background_url || "";
        $("tplTrans").value =
          v.transparency !== undefined && v.transparency !== null
            ? v.transparency
            : 0;
        $("tplNameFx").value = v.name_effect || "none";
        $("tplBgFx").value = v.background_effect || "none";
        $("tplDisplayName").value = v.display_name_mode || "slug";
        $("tplCustomName").value = v.custom_display_name || "";
        $("tplLinkColor").value = v.link_color || "";
        $("tplLinkBgColor").value = v.link_bg_color || "";
        $("tplLinkBgAlpha").value =
          v.link_bg_alpha !== undefined && v.link_bg_alpha !== null
            ? v.link_bg_alpha
            : 100;
        $("tplCardColor").value = v.card_color || "";
        $("tplTextColor").value = v.text_color || "";
        $("tplNameColor").value = v.name_color || "";
        $("tplLocationColor").value = v.location_color || "";
        $("tplQuoteColor").value = v.quote_color || "";
        $("tplCursorUrl").value = v.cursor_url || "";
        $("tplDiscordFrame").value = v.discord_frame_enabled ? "true" : "false";
        $("tplDiscordPresence").value = v.discord_presence_enabled
          ? "true"
          : "false";
        $("tplDiscordPresenceValue").value = v.discord_presence || "online";
        $("tplDiscordStatusLine").value = v.discord_status_enabled
          ? "true"
          : "false";
        $("tplDiscordStatusText").value = v.discord_status_text || "";
        $("tplDiscordBadges").value = v.discord_badges_enabled ? "true" : "false";
        $("tplShowCounter").value = v.show_visit_counter ? "true" : "false";
        $("tplCounterColor").value = v.visit_counter_color || "";
        $("tplCounterBgColor").value = v.visit_counter_bg_color || "";
        $("tplCounterBgAlpha").value =
          v.visit_counter_bg_alpha !== undefined &&
          v.visit_counter_bg_alpha !== null
            ? v.visit_counter_bg_alpha
            : 20;
      }

      function buildVariantFromForm(device) {
        const d = device || currentDevice || "pc";
        const displayMode = $("tplDisplayName").value || "slug";
        const customName = $("tplCustomName").value.trim();
        if (displayMode === "custom" && !customName) {
          showMsg(
            formMsg,
            "Custom display name is required when mode is Custom",
            false
          );
          return null;
        }
        return {
          device_type: d,
          location: $("tplLocation").value.trim() || "",
          quote: $("tplQuote").value.trim() || "",
          song_url: $("tplSong").value.trim() || "",
          show_audio_player: $("tplAudioPlayer").value === "true",
          background_url: $("tplBackground").value.trim(),
          background_is_video: looksLikeVideoUrl($("tplBackground").value.trim()),
          transparency: Math.min(
            100,
            Math.max(0, parseInt($("tplTrans").value || "0", 10))
          ),
          name_effect: $("tplNameFx").value || "none",
          background_effect: $("tplBgFx").value || "none",
          display_name_mode: displayMode,
          custom_display_name: displayMode === "custom" ? customName : null,
          link_color: hexOrNull($("tplLinkColor").value),
          link_bg_color: hexOrNull($("tplLinkBgColor").value),
          link_bg_alpha: Math.min(
            100,
            Math.max(0, parseInt($("tplLinkBgAlpha").value || "100", 10))
          ),
          card_color: hexOrNull($("tplCardColor").value),
          text_color: hexOrNull($("tplTextColor").value),
          name_color: hexOrNull($("tplNameColor").value),
          location_color: hexOrNull($("tplLocationColor").value),
          quote_color: hexOrNull($("tplQuoteColor").value),
          cursor_url: $("tplCursorUrl").value.trim() || null,
          discord_frame_enabled: $("tplDiscordFrame").value === "true",
          discord_presence_enabled: $("tplDiscordPresence").value === "true",
          discord_presence: $("tplDiscordPresenceValue").value || "online",
          discord_status_enabled: $("tplDiscordStatusLine").value === "true",
          discord_status_text: $("tplDiscordStatusText").value.trim() || null,
          discord_badges_enabled: $("tplDiscordBadges").value === "true",
          show_visit_counter: $("tplShowCounter").value === "true",
          visit_counter_color: hexOrNull($("tplCounterColor").value),
          visit_counter_bg_color: hexOrNull($("tplCounterBgColor").value),
          visit_counter_bg_alpha: Math.min(
            100,
            Math.max(0, parseInt($("tplCounterBgAlpha").value || "20", 10))
          ),
        };
      }

      function ensureActiveVariant() {
        const dev = $("tplDevice").value || currentDevice || "pc";
        currentDevice = dev;
        if (!variantCache[dev]) {
          resetVariant(dev);
        } else {
          applyVariantToForm(variantCache[dev]);
        }
        updateModeBadge();
        updateSlugHint();
      }

      async function importFromLinktree(deviceOverride) {
        const device =
          deviceOverride || $("tplDevice").value || currentDevice || "pc";
        const slug =
          presetSlug ||
          (currentUser && currentUser.linktree_slug) ||
          (currentUser && currentUser.username);
        if (!slug) {
          showMsg(formMsg, "Set a Linktree slug first", false);
          return;
        }
        try {
          const lt = await apiGet(
            `/api/linktrees/by-slug/${encodeURIComponent(
              slug
            )}/manage?device=${encodeURIComponent(device)}`
          );
          const data = {
            device_type: device,
            location: lt.location || "",
            quote: lt.quote || "",
            song_url: lt.song_url || "",
            show_audio_player: !!lt.show_audio_player,
            background_url: lt.background_url || "",
            background_is_video: !!lt.background_is_video,
            transparency: lt.transparency ?? 0,
            name_effect: lt.name_effect || "none",
            background_effect: lt.background_effect || "none",
            display_name_mode: lt.display_name_mode || "slug",
            custom_display_name: lt.custom_display_name || "",
            link_color: lt.link_color || "",
            link_bg_color: lt.link_bg_color || "",
            link_bg_alpha: lt.link_bg_alpha ?? 100,
            card_color: lt.card_color || "",
            text_color: lt.text_color || "",
            name_color: lt.name_color || "",
            location_color: lt.location_color || "",
            quote_color: lt.quote_color || "",
            cursor_url: lt.cursor_url || "",
            discord_frame_enabled: !!lt.discord_frame_enabled,
            discord_presence_enabled: !!lt.discord_presence_enabled,
            discord_presence: lt.discord_presence || "online",
            discord_status_enabled: !!lt.discord_status_enabled,
            discord_status_text: lt.discord_status_text || "",
            discord_badges_enabled: !!lt.discord_badges_enabled,
            show_visit_counter: !!lt.show_visit_counter,
            visit_counter_color: lt.visit_counter_color || "",
            visit_counter_bg_color: lt.visit_counter_bg_color || "",
            visit_counter_bg_alpha: lt.visit_counter_bg_alpha ?? 20,
          };
          variantCache[device] = data;
          applyVariantToForm(data);
          showMsg(formMsg, `Imported ${device} settings`, true);
        } catch (e) {
          showMsg(formMsg, "Import failed", false);
        }
      }

      function resetForm() {
        editingId = null;
        resetChangeFlags();
        $("tplCreator").value = (currentUser && currentUser.username) || "";
        $("tplName").value = "";
        $("tplDesc").value = "";
        $("tplPublic").value = "true";
        $("tplMode").value =
          presetDevice === "both" ? "both" : presetDevice || "pc";
        $("tplDevice").value = currentDevice || "pc";
        $("btnSaveTemplate").textContent = "Create template";
        variantCache = { pc: null, mobile: null };
        resetVariant($("tplDevice").value);
        updateModeBadge();
        updateSlugHint();
      }

      async function saveTemplate() {
        const isPublic = $("tplPublic").value === "true";
        if (editingId && dirtyVisibility && !dirtyMeta && !dirtyVariant) {
          try {
            await apiPatch(`/api/marketplace/templates/${editingId}`, {
              is_public: isPublic,
            });
            showMsg(formMsg, "Template visibility updated", true);
            resetChangeFlags();
            setTimeout(() => {
              location.href = "/marketplace";
            }, 600);
          } catch (e) {
            showMsg(formMsg, `Save failed: ${e.message || e}`, false);
          }
          return;
        }
        const name = $("tplName").value.trim();
        if (!name) {
          showMsg(formMsg, "Name required", false);
          return;
        }
        const desc = $("tplDesc").value.trim();
        const creator =
          $("tplCreator").value.trim() ||
          (currentUser && currentUser.username) ||
          null;
        const mode = $("tplMode").value || "pc";
        const activeDevice = $("tplDevice").value || currentDevice || "pc";
        const activeVariant = buildVariantFromForm(activeDevice);
        if (!activeVariant) return;
        variantCache[activeDevice] = activeVariant;

        let variants = [];
        if (mode === "both") {
          const normPc = normalizeVariant(variantCache.pc, "pc");
          const normMob = normalizeVariant(variantCache.mobile, "mobile");
          if (!normPc || !normMob) return;
          variants = [normPc, normMob];
        } else {
          const norm = normalizeVariant(activeVariant, activeDevice);
          if (!norm) return;
          variants = [norm];
        }

        if (mode === "both" && variants.length < 2) {
          showMsg(formMsg, "Fill both desktop and mobile variants", false);
          return;
        }

        const payload = {
          name,
          description: desc || null,
          creator,
          is_public: isPublic,
          preview_image_url: null,
          variants,
        };

        try {
          if (editingId) {
            await apiPatch(`/api/marketplace/templates/${editingId}`, payload);
            showMsg(formMsg, "Template updated", true);
            resetChangeFlags();
            setTimeout(() => {
              location.href = "/marketplace";
            }, 600);
          } else {
            await apiPost("/api/marketplace/templates", payload);
            showMsg(formMsg, "Template created", true);
            resetChangeFlags();
            setTimeout(() => {
              location.href = "/marketplace";
            }, 800);
          }
        } catch (e) {
          showMsg(formMsg, `Save failed: ${e.message || e}`, false);
        }
      }

      function ensureChoice() {
        if (choiceMade) return;
        choiceMade = true;
        formSection.style.display = "flex";
      }

      function applyTemplateToForm(detail) {
        const variants = detail.variants || [];
        variantCache = { pc: null, mobile: null };
        variants.forEach((v) => {
          if (v.device_type === "pc" || v.device_type === "mobile") {
            variantCache[v.device_type] = v;
          }
        });
        const mode =
          variants.length === 2
            ? "both"
            : variants[0] && variants[0].device_type
            ? variants[0].device_type
            : "pc";
        $("tplMode").value = mode;
        const initialDevice =
          mode === "mobile" ? "mobile" : mode === "both" ? "pc" : "pc";
        $("tplDevice").value = initialDevice;
        updateModeBadge();
        const active =
          (mode === "both"
            ? variantCache[initialDevice]
            : variantCache[mode]) ||
          variants[0] ||
          {};
        applyVariantToForm(active);
      }

      async function loadTemplateForEdit(templateId) {
        try {
          const detail = await apiGet(
            `/api/marketplace/templates/${templateId}`
          );
          editingId = templateId;
          choiceMade = true;
          formSection.style.display = "flex";
          $("tplName").value = detail.name || "";
          $("tplCreator").value =
            detail.creator ||
            detail.owner_username ||
            (currentUser && currentUser.username) ||
            "";
          $("tplDesc").value = detail.description || "";
          $("tplPublic").value = detail.is_public ? "true" : "false";
          $("btnSaveTemplate").textContent = "Update template";
          applyTemplateToForm(detail);
          resetChangeFlags();
          showMsg(formMsg, "Template loaded for editing", true);
        } catch (e) {
          showMsg(formMsg, "Could not load template", false);
        }
      }

      async function boot() {
        const session = await fetchSession();
        currentUser = session && session.user ? session.user : null;
        if (!currentUser) {
          if (userBadge) {
            userBadge.textContent = "Login required";
            userBadge.classList.add("alert", "err");
          }
          location.href = `/login?next=${encodeURIComponent(location.href)}`;
          return;
        }
        if (userBadge) {
          userBadge.textContent = currentUser.username || "User";
        }
        resetForm();
        updateSlugHint();
        const tplId = params.get("template_id");
        if (tplId) {
          await loadTemplateForEdit(tplId);
        }
      }

      $("tplDevice").addEventListener("change", ensureActiveVariant);
      $("tplMode").addEventListener("change", () => {
        updateModeBadge();
        ensureActiveVariant();
      });
      $("btnImportVariant").addEventListener("click", async () => {
        ensureChoice();
        await importFromLinktree();
      });
      $("btnResetVariant").addEventListener("click", () => {
        ensureChoice();
        resetVariant($("tplDevice").value);
        showMsg(formMsg, "Variant cleared", true);
      });
      $("btnSaveTemplate").addEventListener("click", () => {
        ensureChoice();
        saveTemplate();
      });
      $("btnResetAll").addEventListener("click", () => {
        resetForm();
        showMsg(formMsg, "Form reset", true);
      });
      $("btnChoiceImport").addEventListener("click", async () => {
        ensureChoice();
        await importFromLinktree(currentDevice);
      });
      $("btnChoiceFresh").addEventListener("click", () => {
        ensureChoice();
        resetForm();
        showMsg(formMsg, "Starting new template", true);
      });

      boot();
      const toggle = document.getElementById("mobileToggle");
      const menu = document.getElementById("primary-menu");
      toggle?.addEventListener("click", () => {
        const open = menu.classList.toggle("open");
        toggle.setAttribute("aria-expanded", String(open));
      });

      function escapeHtml(value) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return String(value ?? "").replace(/[&<>"']/g, (ch) => map[ch] || ch);
      }

      function sanitizeUrl(raw) {
        if (typeof raw !== "string") return "";
        const trimmed = raw.trim();
        if (!trimmed) return "";
        if (trimmed.startsWith("javascript:")) return "";
        try {
          const u = new URL(trimmed, window.location.origin);
          if (["http:", "https:"].includes(u.protocol)) {
            return trimmed.startsWith("http://") ||
              trimmed.startsWith("https://")
              ? u.href
              : trimmed;
          }
        } catch (_) {
          if (trimmed.startsWith("/") && !trimmed.startsWith("//"))
            return trimmed;
        }
        return "";
      }

      async function safe(fn) {
        try {
          return await fn();
        } catch (e) {
          console.error(e);
          return null;
        }
      }
      async function fetchSession() {
        try {
          const r = await safe(() =>
            fetch("/api/auth/verify", { credentials: "include" })
          );
          if (!r || !r.ok) return null;
          return await r.json();
        } catch {
          return null;
        }
      }

      async function renderAuthHeader() {
        const slot = document.getElementById("authSlot");
        if (!slot) return;

        const session = await fetchSession();
        const user = session && session.user ? session.user : null;
        const isAdmin = !!(user && user.admin);

        if (!user) {
          slot.innerHTML = `<a class="btn small" href="/login?next=${encodeURIComponent(
            location.href
          )}">Login</a>
      <a class="btn small" href="/register?next=${encodeURIComponent(
        location.href
      )}">Register</a>`;
          return;
        }

        const uname = user.username || "User";
        const initials = uname.trim().slice(0, 2).toUpperCase() || "U";
        const pfp = sanitizeUrl(user.profile_picture || "");

        slot.innerHTML = `
    <div class="auth-box">
      <button class="avatar-btn" id="avatarBtn" aria-haspopup="menu" aria-expanded="false">
        ${
          pfp
            ? `<img class="avatar" src="${pfp}" alt="${escapeHtml(
                uname
              )}'s profile picture">`
            : `<span class="avatar-fallback" aria-hidden="true">${escapeHtml(
                initials
              )}</span>`
        }
        <span class="uname" style="font-weight:700;font-size:.95rem">${escapeHtml(
          uname
        )}</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="menu" id="userMenu" role="menu" aria-label="User menu">
        <a href="/profile" role="menuitem">Profile</a>
        ${isAdmin ? `<a href="/admin" role="menuitem">Admin</a>` : ""}
        <button id="logoutBtnHdr" role="menuitem">Logout</button>
      </div>
    </div>`;

        const btn = slot.querySelector("#avatarBtn");
        const menu = slot.querySelector("#userMenu");
        const logoutBtn = slot.querySelector("#logoutBtnHdr");

        function closeMenu() {
          menu?.classList.remove("open");
          btn?.setAttribute("aria-expanded", "false");
        }

        btn?.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = menu?.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });

        document.addEventListener("click", (e) => {
          if (
            menu &&
            !menu.contains(e.target) &&
            btn &&
            !btn.contains(e.target)
          ) {
            closeMenu();
          }
        });

        logoutBtn?.addEventListener(
          "click",
          async () => {
            try {
              await fetch("/api/auth/logout", {
                method: "POST",
                credentials: "include",
              });
            } catch {}
            location.href = "/";
          },
          { passive: true }
        );
      }

      renderAuthHeader();

      /* =========================
         UX Enhancements (no feature changes)
         - Draft autosave (localStorage)
         - Restore/discard prompts
         - Unsaved changes sticky bar
         - Ctrl+S save shortcut
         - Friendly validation + URL normalization
         ========================= */

      const UX = (() => {
        const DRAFT_VER = 1;

        const toastWrap = document.getElementById("toastWrap");
        const stickyActions = document.getElementById("stickyActions");
        const dirtyPill = document.getElementById("dirtyPill");
        const draftPill = document.getElementById("draftPill");
        const btnStickySave = document.getElementById("btnStickySave");
        const btnDiscardDraft = document.getElementById("btnDiscardDraft");

        const qsDetails = document.getElementById("qsJumpDetails");
        const qsLook = document.getElementById("qsJumpLook");
        const qsCreate = document.getElementById("qsJumpCreate");

        let dirty = false;
        let draftTimer = null;
        let initialSnapshot = null;

        function nowISO() {
          try {
            return new Date().toISOString();
          } catch {
            return "";
          }
        }

        function keyForDraft() {
          const slug = (
            presetSlug ||
            (currentUser && currentUser.linktree_slug) ||
            (currentUser && currentUser.username) ||
            "anon"
          ).toString();
          const mode = (params.get("template_id") || "new").toString();
          return `taoma:mp_create:draft:v${DRAFT_VER}:${slug}:${mode}`;
        }

        function toast({
          title,
          text,
          variant = "info",
          actions = [],
          timeout = 6500,
        } = {}) {
          if (!toastWrap) return;

          const el = document.createElement("div");
          el.className = `toast ${
            variant === "danger" ? "danger" : variant === "ok" ? "ok" : ""
          }`;
          el.innerHTML = `
            <span class="dot" aria-hidden="true"></span>
            <div style="min-width: 0">
              <p class="t-title">${escapeHtml(title || "")}</p>
              <p class="t-text">${escapeHtml(text || "")}</p>
            </div>
            <div class="t-actions"></div>
          `;

          const actionWrap = el.querySelector(".t-actions");
          actions.forEach((a) => {
            const b = document.createElement("button");
            b.className = a.primary ? "btn sm" : "btn ghost sm";
            b.type = "button";
            b.textContent = a.label;
            b.addEventListener("click", () => {
              try {
                a.onClick && a.onClick();
              } finally {
                el.remove();
              }
            });
            actionWrap.appendChild(b);
          });

          toastWrap.appendChild(el);

          if (timeout) {
            setTimeout(() => {
              if (el.isConnected) el.remove();
            }, timeout);
          }
        }

        function setDirty(on) {
          dirty = !!on;
          if (!stickyActions) return;
          stickyActions.style.display = dirty ? "block" : "none";
          if (dirtyPill)
            dirtyPill.textContent = dirty
              ? "Unsaved changes"
              : "All changes saved";
        }

        function readCurrentState() {
          const state = {
            editingId: editingId || null,
            presetSlug: presetSlug || "",
            presetDevice: presetDevice || "",
            currentDevice: currentDevice || "",
            choiceMade: !!choiceMade,
            form: {
              tplCreator: $("tplCreator")?.value ?? "",
              tplName: $("tplName")?.value ?? "",
              tplDesc: $("tplDesc")?.value ?? "",
              tplPublic: $("tplPublic")?.value ?? "true",
              tplMode: $("tplMode")?.value ?? "pc",
              tplDevice: $("tplDevice")?.value ?? "pc",
            },
            variantCache: variantCache || { pc: null, mobile: null },
            ts: nowISO(),
          };
          return state;
        }

        function snapshot() {
          try {
            const s = readCurrentState();
            // Don't store volatile timestamp in equality snapshot.
            const { ts, ...rest } = s;
            return JSON.stringify(rest);
          } catch {
            return null;
          }
        }

        function saveDraftDebounced() {
          if (!currentUser) return;
          if (!choiceMade) return;
          clearTimeout(draftTimer);
          draftTimer = setTimeout(() => {
            try {
              const k = keyForDraft();
              const data = readCurrentState();
              localStorage.setItem(k, JSON.stringify(data));
              if (draftPill) {
                draftPill.style.display = "inline-flex";
                draftPill.textContent = "Draft saved";
              }
            } catch {}
          }, 500);
        }

        function loadDraft() {
          try {
            const raw = localStorage.getItem(keyForDraft());
            if (!raw) return null;
            return JSON.parse(raw);
          } catch {
            return null;
          }
        }

        function discardDraft() {
          try {
            localStorage.removeItem(keyForDraft());
          } catch {}
          if (draftPill) draftPill.style.display = "none";
          setDirty(false);
          toast({
            title: "Draft discarded",
            text: "Local draft removed from this browser.",
            variant: "ok",
            timeout: 3500,
          });
        }

        function applyDraft(d) {
          if (!d) return;

          // Ensure form visible if draft had progressed
          if (d.choiceMade) {
            choiceMade = true;
            formSection.style.display = "flex";
          }

          // Restore top-level fields
          if ($("tplCreator")) $("tplCreator").value = d.form?.tplCreator ?? "";
          if ($("tplName")) $("tplName").value = d.form?.tplName ?? "";
          if ($("tplDesc")) $("tplDesc").value = d.form?.tplDesc ?? "";
          if ($("tplPublic"))
            $("tplPublic").value = d.form?.tplPublic ?? "true";
          if ($("tplMode"))
            $("tplMode").value = d.form?.tplMode ?? $("tplMode").value;
          if ($("tplDevice"))
            $("tplDevice").value = d.form?.tplDevice ?? $("tplDevice").value;

          // Restore variants
          if (d.variantCache) {
            variantCache = d.variantCache;
          }

          // Ensure UI in sync
          ensureActiveVariant();
          updateModeBadge();
          updateSlugHint();

          toast({
            title: "Draft restored",
            text: "We restored your local draft for this page.",
            variant: "ok",
            timeout: 3500,
          });
          setDirty(true);
        }

        function maybeOfferRestore() {
          const d = loadDraft();
          if (!d) return;

          // If we already have a template loaded for editing, don't auto-prompt unless it matches.
          // We'll still offer but be conservative.
          toast({
            title: "Restore your draft?",
            text: "A local draft was found from a previous visit.",
            actions: [
              { label: "Restore", primary: true, onClick: () => applyDraft(d) },
              { label: "Discard", onClick: () => discardDraft() },
            ],
            timeout: 0,
          });
        }

        function isProbablyUrlField(id) {
          return ["tplBackground", "tplSong", "tplCursorUrl"].includes(id);
        }

        function normalizeUrlField(el) {
          if (!el) return;
          const id = el.id;
          if (!isProbablyUrlField(id)) return;

          const before = (el.value || "").trim();
          if (!before) return;

          // Allow /media/... and other absolute paths
          if (before.startsWith("/") && !before.startsWith("//")) return;

          // Add https:// if missing scheme
          if (!/^https?:\/\//i.test(before)) {
            el.value = `https://${before}`;
          }
        }

        function markInvalid(el, msg) {
          if (!el) return;
          el.classList.add("invalid");
          el.setAttribute("aria-invalid", "true");
          let err = el.parentElement?.querySelector(".errline");
          if (!err) {
            err = document.createElement("div");
            err.className = "errline";
            el.parentElement?.appendChild(err);
          }
          err.textContent = msg || "Invalid value";
        }

        function clearInvalid(el) {
          if (!el) return;
          el.classList.remove("invalid");
          el.removeAttribute("aria-invalid");
          const err = el.parentElement?.querySelector(".errline");
          if (err) err.remove();
        }

        function validateHexInput(el) {
          const v = (el?.value || "").trim();
          if (!v) {
            clearInvalid(el);
            return true;
          }
          if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v)) {
            clearInvalid(el);
            return true;
          }
          markInvalid(el, "Use #RGB or #RRGGBB");
          return false;
        }

        function validateUrlLike(el, required = false) {
          const v = (el?.value || "").trim();
          if (!v) {
            if (required) {
              markInvalid(el, "This field is required");
              return false;
            }
            clearInvalid(el);
            return true;
          }
          if (v.startsWith("/") && !v.startsWith("//")) {
            clearInvalid(el);
            return true;
          }
          if (/^https?:\/\//i.test(v)) {
            clearInvalid(el);
            return true;
          }
          markInvalid(el, "Use https://... or /media/...");
          return false;
        }

        function validateFormFriendly() {
          // Minimal: name + background per active variant
          let ok = true;

          const nameEl = $("tplName");
          if (nameEl) {
            if (!nameEl.value.trim()) {
              markInvalid(nameEl, "Template name is required");
              ok = false;
            } else clearInvalid(nameEl);
          }

          // Active variant background required
          ok = validateUrlLike($("tplBackground"), true) && ok;

          // Optional URL-like fields
          ok = validateUrlLike($("tplSong"), false) && ok;
          ok = validateUrlLike($("tplCursorUrl"), false) && ok;

          // Hex fields
          [
            "tplLinkColor",
            "tplLinkBgColor",
            "tplCardColor",
            "tplTextColor",
            "tplNameColor",
            "tplLocationColor",
            "tplQuoteColor",
            "tplCounterColor",
            "tplCounterBgColor",
          ].forEach((id) => {
            ok = validateHexInput($(id)) && ok;
          });

          return ok;
        }

        function hookInputs() {
          const all = Array.from(
            document.querySelectorAll("input, select, textarea")
          );
          all.forEach((el) => {
            el.addEventListener("input", () => {
              if (el.id) markDirtyByField(el.id);
              setDirty(true);
              saveDraftDebounced();
              // live validate only for some fields
              if (el.id && (el.id.startsWith("tpl") || el.id === "tplName")) {
                if (el.classList.contains("invalid")) validateFormFriendly();
              }
            });
            el.addEventListener("change", () => {
              if (el.id) markDirtyByField(el.id);
              setDirty(true);
              saveDraftDebounced();
            });
            // Normalize on blur for URL fields
            el.addEventListener(
              "blur",
              () => {
                if (el.id) normalizeUrlField(el);
              },
              { passive: true }
            );
          });
        }

        function hookStickyButtons() {
          btnStickySave?.addEventListener("click", () => {
            if (!choiceMade) ensureChoice();
            // Before saving, ensure cached active variant is updated
            const activeDevice = $("tplDevice")?.value || currentDevice || "pc";
            const v = buildVariantFromForm(activeDevice);
            if (v) variantCache[activeDevice] = v;

            if (!validateFormFriendly()) {
              toast({
                title: "Fix a few fields",
                text: "Some values look invalid. Check the highlighted inputs.",
                variant: "danger",
                timeout: 4500,
              });
              return;
            }
            saveTemplate();
          });

          btnDiscardDraft?.addEventListener("click", () => {
            // Soft reset: discard local draft and revert to initial snapshot if possible
            discardDraft();
            // If we have an initial snapshot, reload the page state by re-running resetForm + optional template load
            try {
              const tplId = params.get("template_id");
              resetForm();
              if (tplId) loadTemplateForEdit(tplId);
            } catch {}
          });
        }

        function hookKeyboardShortcuts() {
          document.addEventListener("keydown", (e) => {
            const isMac = navigator.platform.toLowerCase().includes("mac");
            const mod = isMac ? e.metaKey : e.ctrlKey;
            if (mod && e.key.toLowerCase() === "s") {
              e.preventDefault();
              if (!choiceMade) ensureChoice();
              if (!validateFormFriendly()) {
                toast({
                  title: "Fix a few fields",
                  text: "Some values look invalid. Check the highlighted inputs.",
                  variant: "danger",
                  timeout: 4500,
                });
                return;
              }
              saveTemplate();
            }
          });
        }

        function hookQuickSetupJumps() {
          function scrollToId(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.scrollIntoView({ behavior: "smooth", block: "start" });
          }

          qsDetails?.addEventListener("click", () => {
            ensureChoice();
            scrollToId("formSection");
            $("tplName")?.focus?.();
          });

          qsLook?.addEventListener("click", () => {
            ensureChoice();
            scrollToId("tplBackground");
            $("tplBackground")?.focus?.();
          });

          qsCreate?.addEventListener("click", () => {
            ensureChoice();
            scrollToId("btnSaveTemplate");
            $("btnSaveTemplate")?.focus?.();
          });
        }

        function compareAndSetDirty() {
          const snap = snapshot();
          if (!initialSnapshot) initialSnapshot = snap;
          if (!snap || !initialSnapshot) return;
          setDirty(snap !== initialSnapshot);
        }

        function startDirtyWatcher() {
          // Periodically compare snapshots (cheap enough for this page)
          setInterval(() => {
            try {
              compareAndSetDirty();
            } catch {}
          }, 900);
        }

        function onAfterBoot() {
          // Initial baseline after boot/reset/template load.
          initialSnapshot = snapshot();
          setDirty(false);
          hookInputs();
          hookStickyButtons();
          hookKeyboardShortcuts();
          hookQuickSetupJumps();
          maybeOfferRestore();
          startDirtyWatcher();
        }

        return { onAfterBoot, validateFormFriendly, snapshot };
      })();

      // Call after boot completes (boot() is async)
      (async () => {
        // Wait until boot has done its first render.
        // If boot redirects (not logged in), this won't matter.
        try {
          // Microtask + short delay to ensure resetForm/applyTemplate finished
          await Promise.resolve();
          setTimeout(() => {
            try {
              UX.onAfterBoot();
            } catch {}
          }, 0);
        } catch {}
      })();

      // Patch: when we show the form due to user choice, create a new baseline
      const _ensureChoice = ensureChoice;
      ensureChoice = function () {
        _ensureChoice();
        try {
          /* baseline will be recalculated by watcher; keep draft timer */
        } catch {}
      };

      // Before saving in main button, run friendly validation too
      const _saveTemplate = saveTemplate;
      saveTemplate = async function () {
        if (UX.validateFormFriendly && !UX.validateFormFriendly()) {
          // formMsg already used; add a toast too
          try {
            const tw = document.getElementById("toastWrap");
            if (tw) {
              // minimal fallback toast
            }
          } catch {}
          showMsg(formMsg, "Please fix the highlighted fields", false);
          return;
        }
        const before = UX.snapshot ? UX.snapshot() : null;
        await _saveTemplate();
        // After successful saveTemplate() it navigates; but if not, we can clear dirty.
        const after = UX.snapshot ? UX.snapshot() : null;
        if (before && after && before !== after) {
          // keep dirty (save failed). If save succeeded but stayed, clear.
        }
      };
    </script>
  </body>
</html>
